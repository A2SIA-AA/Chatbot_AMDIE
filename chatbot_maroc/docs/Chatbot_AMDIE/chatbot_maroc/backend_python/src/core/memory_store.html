<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>Chatbot_AMDIE.chatbot_maroc.backend_python.src.core.memory_store API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../core.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;Chatbot_AMDIE.chatbot_maroc.backend_python.src.core</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#ConversationMemoryStore">ConversationMemoryStore</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ConversationMemoryStore.__init__">ConversationMemoryStore</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConversationMemoryStore.db_path">db_path</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.save_conversation">save_conversation</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.get_user_history_24h">get_user_history_24h</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.format_history_for_context">format_history_for_context</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.get_conversation_stats">get_conversation_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.cleanup_old_conversations">cleanup_old_conversations</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.get_all_users">get_all_users</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.delete_user_conversations">delete_user_conversations</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.export_user_conversations">export_user_conversations</a>
                        </li>
                        <li>
                                <a class="function" href="#ConversationMemoryStore.check_database_health">check_database_health</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#conversation_memory">conversation_memory</a>
            </li>
            <li>
                    <a class="function" href="#save_conversation">save_conversation</a>
            </li>
            <li>
                    <a class="function" href="#get_user_context">get_user_context</a>
            </li>
            <li>
                    <a class="function" href="#get_user_stats">get_user_stats</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
Chatbot_AMDIE<wbr>.chatbot_maroc<wbr>.<a href="./../../../backend_python.html">backend_python</a><wbr>.<a href="./../../src.html">src</a><wbr>.<a href="./../core.html">core</a><wbr>.memory_store    </h1>

                
                        <input id="mod-memory_store-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-memory_store-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ConversationMemoryStore</span><span class="p">:</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">    Classe pour gérer le stockage des conversations en utilisant SQLite.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    Cette classe fournit des fonctionnalités pour enregistrer, récupérer et analyser</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    les conversations des utilisateurs. Elle inclut également des méthodes pour nettoyer</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    les conversations anciennes et formater les données pour des besoins spécifiques,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    comme le contexte des agents d&#39;intelligence artificielle.</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">    :ivar db_path: Chemin vers la base de données SQLite utilisée pour stocker les conversations.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">    :type db_path: str</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;conversations.db&quot;</span><span class="p">):</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        Initialise le store SQLite</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        Args:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">            db_path: Chemin vers la base de données SQLite</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_database</span><span class="p">()</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ConversationMemoryStore initialisé: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        Initialise la base de données pour gérer les conversations et configure les tables nécessaires.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        Cette méthode crée une table `conversations` si elle n&#39;existe pas, ainsi que deux index pour améliorer</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        les performances des requêtes fréquemment utilisées. La table `conversations` stocke des informations</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        liées aux utilisateurs, y compris leur identifiant, leur email, leurs questions, les réponses qui leur</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        sont fournies, les horodatages de ces interactions, ainsi que des informations de session.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        :raises Exception: Si une erreur se produit lors de l&#39;initialisation de la base de données.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="s2">                             CREATE TABLE IF NOT EXISTS conversations</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="s2">                             (</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="s2">                                 id</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="s2">                                 INTEGER</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="s2">                                 PRIMARY</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="s2">                                 KEY</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="s2">                                 AUTOINCREMENT,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="s2">                                 username</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="s2">                                 TEXT</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="s2">                                 NOT</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="s2">                                 NULL,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="s2">                                 email</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="s2">                                 TEXT</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="s2">                                 NOT</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="s2">                                 NULL,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="s2">                                 question</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="s2">                                 TEXT</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="s2">                                 NOT</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="s2">                                 NULL,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="s2">                                 reponse</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="s2">                                 TEXT</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="s2">                                 NOT</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="s2">                                 NULL,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="s2">                                 timestamp</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="s2">                                 DATETIME</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="s2">                                 NOT</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="s2">                                 NULL,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="s2">                                 session_id</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="s2">                                 TEXT,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="s2">                                 created_at</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="s2">                                 DATETIME</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="s2">                                 DEFAULT</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="s2">                                 CURRENT_TIMESTAMP</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="s2">                             )</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>                <span class="c1"># Index pour optimiser les requêtes fréquentes</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="s2">                             CREATE INDEX IF NOT EXISTS idx_user_timestamp</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="s2">                                 ON conversations(username, email, timestamp DESC)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="s2">                             CREATE INDEX IF NOT EXISTS idx_session</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="s2">                                 ON conversations(session_id)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Base de données conversations initialisée&quot;</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur initialisation DB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>            <span class="k">raise</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="nd">@contextmanager</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        Fournit un gestionnaire de contexte pour obtenir une connexion à une base de</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        données SQLite, avec gestion automatisée des transactions et nettoyage en</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        cas d&#39;erreur.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        Lorsque le gestionnaire de contexte est utilisé, il établit une connexion avec la</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">        base de données, permet son utilisation à l&#39;intérieur du bloc de code, et se charge</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        de fermer la connexion une fois que le bloc de code est terminé ou en cas</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        d&#39;exception.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        :raises Exception: Si une erreur survient pendant l&#39;utilisation de la connexion.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        :return: Un objet connexion SQLite avec `row_factory` configuré pour permettre</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">                 l&#39;accès aux colonnes par nom.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>  <span class="c1"># Pour accéder aux colonnes par nom</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            <span class="k">yield</span> <span class="n">conn</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>                          <span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        Enregistre une conversation dans la base de données. La fonction enregistre</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        les informations fournies, telles que le nom d&#39;utilisateur, l&#39;adresse email,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        la question posée, la réponse donnée ainsi qu&#39;un éventuel identifiant de</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        session. Le timestamp est automatiquement ajouté lors de l&#39;insertion.</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur qui a posé la question</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        :type username: str</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        :param email: L&#39;adresse email de l&#39;utilisateur</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">        :type email: str</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        :param question: La question posée par l&#39;utilisateur</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">        :type question: str</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        :param reponse: La réponse donnée à l&#39;utilisateur</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        :type reponse: str</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        :param session_id: L&#39;identifiant de session associé, optionnel</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        :type session_id: str, optional</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">        :return: Retourne True si la conversation a été enregistrée avec succès,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">                 False en cas d&#39;échec</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">        :rtype: bool</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="s2">                             INSERT INTO conversations</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="s2">                                 (username, email, question, reponse, timestamp, session_id)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="s2">                             VALUES (?, ?, ?, ?, ?, ?)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                                 <span class="n">username</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                                 <span class="n">email</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                                 <span class="n">question</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                                 <span class="n">reponse</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                                 <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                                 <span class="n">session_id</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                             <span class="p">))</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Conversation sauvegardée: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur sauvegarde conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_history_24h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        Récupère l&#39;historique des conversations de l&#39;utilisateur spécifié au cours des</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">        dernières 24 heures. Les conversations sont triées par ordre décroissant de</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        timestamp.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">        L&#39;historique est limité par un nombre spécifié.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur de l&#39;utilisateur pour lequel récupérer</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">            l&#39;historique des conversations.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">        :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        :param limit: (optionnel) Le nombre maximum de conversations à récupérer. La</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">            valeur par défaut est 20.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        :return: Une liste de dictionnaires contenant les informations des conversations</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">            récupérées. Chaque dictionnaire inclut les clés suivantes : &#39;question&#39;,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">            &#39;reponse&#39;, &#39;timestamp&#39;, et &#39;session_id&#39;.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="s2">                                      SELECT question, reponse, timestamp, session_id</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="s2">                                        AND timestamp &gt;= ?</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="s2">                                      ORDER BY timestamp DESC</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="s2">                                          LIMIT ?</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                <span class="n">conversations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                    <span class="n">conversations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">],</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                        <span class="s1">&#39;reponse&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">],</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                    <span class="p">})</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Historique récupéré: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversations pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="k">return</span> <span class="n">conversations</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur récupération historique: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_history_for_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_conversations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        Formate l&#39;historique des conversations pour un contexte spécifique en affichant les détails des</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">        conversations d&#39;un utilisateur au cours des dernières 24 heures.</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel extraire l&#39;historique des conversations.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        :type username: str</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        :param email: L&#39;email de l&#39;utilisateur correspondant au nom d&#39;utilisateur donné.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        :type email: str</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        :param max_conversations: Le nombre maximum de conversations à inclure dans le contexte.</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">            Par défaut, 5.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        :type max_conversations: int</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        :return: Une chaîne de caractères formatée contenant l&#39;historique des conversations, ou</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">            un message indiquant l&#39;absence d&#39;historique.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">        :rtype: str</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_history_24h</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">max_conversations</span><span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="k">return</span> <span class="s2">&quot;HISTORIQUE: Aucune conversation précédente dans les 24h.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HISTORIQUE DES CONVERSATIONS (24h) - Utilisateur: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                <span class="c1"># Parse si c&#39;est une string</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CONVERSATION </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] - </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Q: </span><span class="si">{</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;R: </span><span class="si">{</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversation(s) récente(s)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        Récupère les statistiques liées aux conversations d&#39;un utilisateur, y compris le total des conversations,</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        le nombre de conversations dans les dernières 24 heures et les détails de la dernière conversation.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel rechercher les statistiques</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        :type username: str</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        :param email: L&#39;adresse email de l&#39;utilisateur pour lequel rechercher les statistiques</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        :type email: str</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">        :return: Un dictionnaire contenant les statistiques suivantes :</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">                 - &#39;total_conversations&#39;: nombre total de conversations</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">                 - &#39;conversations_24h&#39;: nombre de conversations dans les 24 dernières heures</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">                 - &#39;last_conversation&#39;: détails de la dernière conversation incluant &#39;timestamp&#39; et &#39;question&#39;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        :rtype: Dict</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        :raises Exception: En cas d&#39;erreur lors de l&#39;exécution des requêtes ou de la connexion à la base de données</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="c1"># Total conversations</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="s2">                                      SELECT COUNT(*) as total</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                <span class="n">total</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                <span class="c1"># Conversations 24h</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="s2">                                      SELECT COUNT(*) as recent</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="s2">                                        AND timestamp &gt;= ?</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">))</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="n">recent</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;recent&#39;</span><span class="p">]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                <span class="c1"># Dernière conversation</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="s2">                                      SELECT timestamp, question</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="s2">                                      WHERE username = ? AND email = ?</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="s2">                                      ORDER BY timestamp DESC LIMIT 1</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                <span class="n">last_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                <span class="n">last_conversation</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                    <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                <span class="p">}</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                <span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">,</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="s1">&#39;last_conversation&#39;</span><span class="p">:</span> <span class="n">last_conversation</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="p">}</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur statistiques: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;last_conversation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_to_keep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">        Supprime les anciennes conversations de la base de données qui ont une date</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">        antérieure à un nombre de jours spécifié (days_to_keep). Cette méthode effectue</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="sd">        un nettoyage des données en supprimant les enregistrements obsolètes d&#39;après</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="sd">        la date limite calculée.</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">        :param days_to_keep: Nombre de jours avant lesquels les conversations</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">            doivent être supprimées (par défaut 30).</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        :type days_to_keep: int</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        :return: Le nombre de conversations supprimées.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        :rtype: int</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_to_keep</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="s2">                                      DELETE</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="s2">                                      WHERE timestamp &lt; ?</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cutoff_date</span><span class="p">,))</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Nettoyage: </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> conversations supprimées (&gt; </span><span class="si">{</span><span class="n">days_to_keep</span><span class="si">}</span><span class="s2"> jours)&quot;</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="k">return</span> <span class="n">deleted_count</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur nettoyage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        Récupère tous les utilisateurs distincts avec leurs noms d&#39;utilisateur et leurs</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        adresses e-mail à partir de la base de données. Les utilisateurs sont renvoyés</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">        dans un ordre alphabétique basé sur leurs noms d&#39;utilisateur.</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">        :return: Une liste de tuples contenant les noms d&#39;utilisateur et adresses e-mail</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">                 de tous les utilisateurs distincts dans la base de données. Si une erreur</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">                 se produit, retourne une liste vide.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        :rtype: List[Tuple[str, str]]</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="s2">                                      SELECT DISTINCT username, email</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="s2">                                      ORDER BY username</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="k">return</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur liste utilisateurs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">        Supprime les conversations associées à un utilisateur spécifique.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        Cette méthode permet de supprimer toutes les conversations d&#39;un utilisateur donné</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        en fonction de son nom d&#39;utilisateur (username) et de son adresse e-mail.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        :param username: Nom d&#39;utilisateur de l&#39;individu dont les conversations doivent</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">            être supprimées.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        :type username: str</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        :param email: Adresse e-mail de l&#39;utilisateur dont les conversations sont à</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">            supprimer.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        :type email: str</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">        :return: Le nombre total de conversations supprimées avec succès pour cet</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">            utilisateur. Retourne `0` en cas d&#39;échec ou si aucune conversation n&#39;a été</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">            supprimée.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        :rtype: int</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="s2">                                      DELETE</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> conversations supprimées pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            <span class="k">return</span> <span class="n">deleted_count</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur suppression utilisateur: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_user_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        Exporte les conversations d&#39;un utilisateur à partir de la base de données en fonction de son</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        nom d&#39;utilisateur et de son email. Les conversations sont triées par ordre décroissant de leur</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        horodatage.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        Cette méthode effectue une requête SQL pour récupérer les conversations correspondantes dans la</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        base de données, puis les formate sous forme de liste de dictionnaires, où chaque dictionnaire</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        représente une conversation.</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel les conversations doivent être exportées.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">        :param email: L&#39;adresse e-mail associée à l&#39;utilisateur pour l&#39;extraction des conversations.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        :return: Une liste de dictionnaires représentant les conversations de l&#39;utilisateur, ou une</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">                 liste vide en cas d&#39;erreur.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="s2">                                      SELECT *</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="s2">                                      ORDER BY timestamp DESC</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                <span class="n">conversations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                    <span class="n">conversations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">],</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                        <span class="s1">&#39;reponse&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">],</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">],</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                    <span class="p">})</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="k">return</span> <span class="n">conversations</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur export: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_database_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">        Vérifie l&#39;état de santé de la base de données et retourne des statistiques détaillées sur son utilisation. Cette</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">        fonction évalue la taille de la base, le nombre total de conversations stockées, les utilisateurs uniques,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">        ainsi que le nombre de conversations enregistrées durant les dernières 24 heures.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">        :return: Un dictionnaire contenant des informations sur la santé de la base de données, y compris</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">            le chemin absolu de la base, sa taille en octets et mégaoctets, le nombre total de conversations</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">            enregistrées, le total d&#39;utilisateurs uniques et le nombre de conversations dans les dernières 24 heures.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">            Si une erreur survient lors du diagnostic, elle inclut l&#39;erreur et marque l&#39;état de la base comme</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">            « error ».</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a><span class="sd">        :rtype: Dict</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                <span class="c1"># Taille de la base</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) as total FROM conversations&quot;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                <span class="n">total_conversations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                <span class="c1"># Utilisateurs uniques</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(DISTINCT username, email) as users FROM conversations&quot;</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="n">total_users</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                <span class="c1"># Conversations récentes (24h)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) as recent FROM conversations WHERE timestamp &gt;= ?&quot;</span><span class="p">,</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                                      <span class="p">(</span><span class="n">cutoff_time</span><span class="p">,))</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                <span class="n">recent_conversations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;recent&#39;</span><span class="p">]</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                <span class="c1"># Taille du fichier</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="s1">&#39;database_path&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">),</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                <span class="s1">&#39;file_size_bytes&#39;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                <span class="s1">&#39;file_size_mb&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                <span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="n">total_conversations</span><span class="p">,</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                <span class="s1">&#39;total_users&#39;</span><span class="p">:</span> <span class="n">total_users</span><span class="p">,</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="n">recent_conversations</span><span class="p">,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="p">}</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur vérification santé DB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                <span class="s1">&#39;database_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>            <span class="p">}</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="c1"># Instance globale du memory store</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="n">conversation_memory</span> <span class="o">=</span> <span class="n">ConversationMemoryStore</span><span class="p">()</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="c1"># Fonctions utilitaires pour compatibilité</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">    Sauvegarde une conversation dans la mémoire persistante. Cette fonction permet</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">    de stocker les informations pertinentes d&#39;une conversation pour un usage</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">    ultérieur. Les informations sauvegardées incluent le nom d&#39;utilisateur, l&#39;email,</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">    la question posée, la réponse et un identifiant de session facultatif.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">    :param username: Le nom d&#39;utilisateur qui a participé à la conversation.</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">    :type username: str</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">    :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="sd">    :type email: str</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">    :param question: La question posée par l&#39;utilisateur pendant la conversation.</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">    :type question: str</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">    :param reponse: La réponse apportée à la question de l&#39;utilisateur.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">    :type reponse: str</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">    :param session_id: L&#39;identifiant unique de la session de conversation</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">        (facultatif, peut être None si non fourni).</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">    :type session_id: str, optionnel</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">    :return: Retourne True si la conversation a été sauvegardée avec succès,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">        False sinon.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="sd">    :rtype: bool</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="k">return</span> <span class="n">conversation_memory</span><span class="o">.</span><span class="n">save_conversation</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">reponse</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a><span class="sd">    Récupère le contexte utilisateur pour formater l&#39;historique de la conversation.</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a><span class="sd">    Cette fonction utilise la mémoire de conversation pour retourner un contexte</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a><span class="sd">    formaté basé sur l&#39;historique et les informations utilisateur fournies.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="sd">    :param username: Le nom d&#39;utilisateur utilisé pour le contexte.</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">    :type username: str</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">    :param email: L&#39;adresse e-mail associée à l&#39;utilisateur.</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a><span class="sd">    :type email: str</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="sd">    :return: Une chaîne formatée représentant le contexte utilisateur.</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a><span class="sd">    :rtype: str</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="k">return</span> <span class="n">conversation_memory</span><span class="o">.</span><span class="n">format_history_for_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_stats</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="sd">    Récupère les statistiques de conversation d&#39;un utilisateur donné.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a><span class="sd">    Cette fonction interagit avec une mémoire de conversation pour obtenir</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="sd">    des statistiques spécifiques à un utilisateur identifiable par son nom</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">    d&#39;utilisateur et son adresse e-mail.</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">    :param username: Nom d&#39;utilisateur pour identifier l&#39;utilisateur cible.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="sd">    :type username: str</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">    :param email: Adresse e-mail associée à l&#39;utilisateur.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="sd">    :type email: str</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">    :return: Un dictionnaire contenant les statistiques de conversation</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="sd">        associées à l&#39;utilisateur.</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">    :rtype: Dict</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>    <span class="k">return</span> <span class="n">conversation_memory</span><span class="o">.</span><span class="n">get_conversation_stats</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">Chatbot_AMDIE.chatbot_maroc.backend_python.src.core.memory_store</a> (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="ConversationMemoryStore">
                            <input id="ConversationMemoryStore-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ConversationMemoryStore</span>:

                <label class="view-source-button" for="ConversationMemoryStore-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore-12"><a href="#ConversationMemoryStore-12"><span class="linenos"> 12</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ConversationMemoryStore</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-13"><a href="#ConversationMemoryStore-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-14"><a href="#ConversationMemoryStore-14"><span class="linenos"> 14</span></a><span class="sd">    Classe pour gérer le stockage des conversations en utilisant SQLite.</span>
</span><span id="ConversationMemoryStore-15"><a href="#ConversationMemoryStore-15"><span class="linenos"> 15</span></a>
</span><span id="ConversationMemoryStore-16"><a href="#ConversationMemoryStore-16"><span class="linenos"> 16</span></a><span class="sd">    Cette classe fournit des fonctionnalités pour enregistrer, récupérer et analyser</span>
</span><span id="ConversationMemoryStore-17"><a href="#ConversationMemoryStore-17"><span class="linenos"> 17</span></a><span class="sd">    les conversations des utilisateurs. Elle inclut également des méthodes pour nettoyer</span>
</span><span id="ConversationMemoryStore-18"><a href="#ConversationMemoryStore-18"><span class="linenos"> 18</span></a><span class="sd">    les conversations anciennes et formater les données pour des besoins spécifiques,</span>
</span><span id="ConversationMemoryStore-19"><a href="#ConversationMemoryStore-19"><span class="linenos"> 19</span></a><span class="sd">    comme le contexte des agents d&#39;intelligence artificielle.</span>
</span><span id="ConversationMemoryStore-20"><a href="#ConversationMemoryStore-20"><span class="linenos"> 20</span></a>
</span><span id="ConversationMemoryStore-21"><a href="#ConversationMemoryStore-21"><span class="linenos"> 21</span></a><span class="sd">    :ivar db_path: Chemin vers la base de données SQLite utilisée pour stocker les conversations.</span>
</span><span id="ConversationMemoryStore-22"><a href="#ConversationMemoryStore-22"><span class="linenos"> 22</span></a><span class="sd">    :type db_path: str</span>
</span><span id="ConversationMemoryStore-23"><a href="#ConversationMemoryStore-23"><span class="linenos"> 23</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-24"><a href="#ConversationMemoryStore-24"><span class="linenos"> 24</span></a>
</span><span id="ConversationMemoryStore-25"><a href="#ConversationMemoryStore-25"><span class="linenos"> 25</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;conversations.db&quot;</span><span class="p">):</span>
</span><span id="ConversationMemoryStore-26"><a href="#ConversationMemoryStore-26"><span class="linenos"> 26</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-27"><a href="#ConversationMemoryStore-27"><span class="linenos"> 27</span></a><span class="sd">        Initialise le store SQLite</span>
</span><span id="ConversationMemoryStore-28"><a href="#ConversationMemoryStore-28"><span class="linenos"> 28</span></a>
</span><span id="ConversationMemoryStore-29"><a href="#ConversationMemoryStore-29"><span class="linenos"> 29</span></a><span class="sd">        Args:</span>
</span><span id="ConversationMemoryStore-30"><a href="#ConversationMemoryStore-30"><span class="linenos"> 30</span></a><span class="sd">            db_path: Chemin vers la base de données SQLite</span>
</span><span id="ConversationMemoryStore-31"><a href="#ConversationMemoryStore-31"><span class="linenos"> 31</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-32"><a href="#ConversationMemoryStore-32"><span class="linenos"> 32</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
</span><span id="ConversationMemoryStore-33"><a href="#ConversationMemoryStore-33"><span class="linenos"> 33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_database</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-34"><a href="#ConversationMemoryStore-34"><span class="linenos"> 34</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ConversationMemoryStore initialisé: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-35"><a href="#ConversationMemoryStore-35"><span class="linenos"> 35</span></a>
</span><span id="ConversationMemoryStore-36"><a href="#ConversationMemoryStore-36"><span class="linenos"> 36</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ConversationMemoryStore-37"><a href="#ConversationMemoryStore-37"><span class="linenos"> 37</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-38"><a href="#ConversationMemoryStore-38"><span class="linenos"> 38</span></a><span class="sd">        Initialise la base de données pour gérer les conversations et configure les tables nécessaires.</span>
</span><span id="ConversationMemoryStore-39"><a href="#ConversationMemoryStore-39"><span class="linenos"> 39</span></a>
</span><span id="ConversationMemoryStore-40"><a href="#ConversationMemoryStore-40"><span class="linenos"> 40</span></a><span class="sd">        Cette méthode crée une table `conversations` si elle n&#39;existe pas, ainsi que deux index pour améliorer</span>
</span><span id="ConversationMemoryStore-41"><a href="#ConversationMemoryStore-41"><span class="linenos"> 41</span></a><span class="sd">        les performances des requêtes fréquemment utilisées. La table `conversations` stocke des informations</span>
</span><span id="ConversationMemoryStore-42"><a href="#ConversationMemoryStore-42"><span class="linenos"> 42</span></a><span class="sd">        liées aux utilisateurs, y compris leur identifiant, leur email, leurs questions, les réponses qui leur</span>
</span><span id="ConversationMemoryStore-43"><a href="#ConversationMemoryStore-43"><span class="linenos"> 43</span></a><span class="sd">        sont fournies, les horodatages de ces interactions, ainsi que des informations de session.</span>
</span><span id="ConversationMemoryStore-44"><a href="#ConversationMemoryStore-44"><span class="linenos"> 44</span></a>
</span><span id="ConversationMemoryStore-45"><a href="#ConversationMemoryStore-45"><span class="linenos"> 45</span></a><span class="sd">        :raises Exception: Si une erreur se produit lors de l&#39;initialisation de la base de données.</span>
</span><span id="ConversationMemoryStore-46"><a href="#ConversationMemoryStore-46"><span class="linenos"> 46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-47"><a href="#ConversationMemoryStore-47"><span class="linenos"> 47</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-48"><a href="#ConversationMemoryStore-48"><span class="linenos"> 48</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-49"><a href="#ConversationMemoryStore-49"><span class="linenos"> 49</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-50"><a href="#ConversationMemoryStore-50"><span class="linenos"> 50</span></a><span class="s2">                             CREATE TABLE IF NOT EXISTS conversations</span>
</span><span id="ConversationMemoryStore-51"><a href="#ConversationMemoryStore-51"><span class="linenos"> 51</span></a><span class="s2">                             (</span>
</span><span id="ConversationMemoryStore-52"><a href="#ConversationMemoryStore-52"><span class="linenos"> 52</span></a><span class="s2">                                 id</span>
</span><span id="ConversationMemoryStore-53"><a href="#ConversationMemoryStore-53"><span class="linenos"> 53</span></a><span class="s2">                                 INTEGER</span>
</span><span id="ConversationMemoryStore-54"><a href="#ConversationMemoryStore-54"><span class="linenos"> 54</span></a><span class="s2">                                 PRIMARY</span>
</span><span id="ConversationMemoryStore-55"><a href="#ConversationMemoryStore-55"><span class="linenos"> 55</span></a><span class="s2">                                 KEY</span>
</span><span id="ConversationMemoryStore-56"><a href="#ConversationMemoryStore-56"><span class="linenos"> 56</span></a><span class="s2">                                 AUTOINCREMENT,</span>
</span><span id="ConversationMemoryStore-57"><a href="#ConversationMemoryStore-57"><span class="linenos"> 57</span></a><span class="s2">                                 username</span>
</span><span id="ConversationMemoryStore-58"><a href="#ConversationMemoryStore-58"><span class="linenos"> 58</span></a><span class="s2">                                 TEXT</span>
</span><span id="ConversationMemoryStore-59"><a href="#ConversationMemoryStore-59"><span class="linenos"> 59</span></a><span class="s2">                                 NOT</span>
</span><span id="ConversationMemoryStore-60"><a href="#ConversationMemoryStore-60"><span class="linenos"> 60</span></a><span class="s2">                                 NULL,</span>
</span><span id="ConversationMemoryStore-61"><a href="#ConversationMemoryStore-61"><span class="linenos"> 61</span></a><span class="s2">                                 email</span>
</span><span id="ConversationMemoryStore-62"><a href="#ConversationMemoryStore-62"><span class="linenos"> 62</span></a><span class="s2">                                 TEXT</span>
</span><span id="ConversationMemoryStore-63"><a href="#ConversationMemoryStore-63"><span class="linenos"> 63</span></a><span class="s2">                                 NOT</span>
</span><span id="ConversationMemoryStore-64"><a href="#ConversationMemoryStore-64"><span class="linenos"> 64</span></a><span class="s2">                                 NULL,</span>
</span><span id="ConversationMemoryStore-65"><a href="#ConversationMemoryStore-65"><span class="linenos"> 65</span></a><span class="s2">                                 question</span>
</span><span id="ConversationMemoryStore-66"><a href="#ConversationMemoryStore-66"><span class="linenos"> 66</span></a><span class="s2">                                 TEXT</span>
</span><span id="ConversationMemoryStore-67"><a href="#ConversationMemoryStore-67"><span class="linenos"> 67</span></a><span class="s2">                                 NOT</span>
</span><span id="ConversationMemoryStore-68"><a href="#ConversationMemoryStore-68"><span class="linenos"> 68</span></a><span class="s2">                                 NULL,</span>
</span><span id="ConversationMemoryStore-69"><a href="#ConversationMemoryStore-69"><span class="linenos"> 69</span></a><span class="s2">                                 reponse</span>
</span><span id="ConversationMemoryStore-70"><a href="#ConversationMemoryStore-70"><span class="linenos"> 70</span></a><span class="s2">                                 TEXT</span>
</span><span id="ConversationMemoryStore-71"><a href="#ConversationMemoryStore-71"><span class="linenos"> 71</span></a><span class="s2">                                 NOT</span>
</span><span id="ConversationMemoryStore-72"><a href="#ConversationMemoryStore-72"><span class="linenos"> 72</span></a><span class="s2">                                 NULL,</span>
</span><span id="ConversationMemoryStore-73"><a href="#ConversationMemoryStore-73"><span class="linenos"> 73</span></a><span class="s2">                                 timestamp</span>
</span><span id="ConversationMemoryStore-74"><a href="#ConversationMemoryStore-74"><span class="linenos"> 74</span></a><span class="s2">                                 DATETIME</span>
</span><span id="ConversationMemoryStore-75"><a href="#ConversationMemoryStore-75"><span class="linenos"> 75</span></a><span class="s2">                                 NOT</span>
</span><span id="ConversationMemoryStore-76"><a href="#ConversationMemoryStore-76"><span class="linenos"> 76</span></a><span class="s2">                                 NULL,</span>
</span><span id="ConversationMemoryStore-77"><a href="#ConversationMemoryStore-77"><span class="linenos"> 77</span></a><span class="s2">                                 session_id</span>
</span><span id="ConversationMemoryStore-78"><a href="#ConversationMemoryStore-78"><span class="linenos"> 78</span></a><span class="s2">                                 TEXT,</span>
</span><span id="ConversationMemoryStore-79"><a href="#ConversationMemoryStore-79"><span class="linenos"> 79</span></a><span class="s2">                                 created_at</span>
</span><span id="ConversationMemoryStore-80"><a href="#ConversationMemoryStore-80"><span class="linenos"> 80</span></a><span class="s2">                                 DATETIME</span>
</span><span id="ConversationMemoryStore-81"><a href="#ConversationMemoryStore-81"><span class="linenos"> 81</span></a><span class="s2">                                 DEFAULT</span>
</span><span id="ConversationMemoryStore-82"><a href="#ConversationMemoryStore-82"><span class="linenos"> 82</span></a><span class="s2">                                 CURRENT_TIMESTAMP</span>
</span><span id="ConversationMemoryStore-83"><a href="#ConversationMemoryStore-83"><span class="linenos"> 83</span></a><span class="s2">                             )</span>
</span><span id="ConversationMemoryStore-84"><a href="#ConversationMemoryStore-84"><span class="linenos"> 84</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-85"><a href="#ConversationMemoryStore-85"><span class="linenos"> 85</span></a>
</span><span id="ConversationMemoryStore-86"><a href="#ConversationMemoryStore-86"><span class="linenos"> 86</span></a>                <span class="c1"># Index pour optimiser les requêtes fréquentes</span>
</span><span id="ConversationMemoryStore-87"><a href="#ConversationMemoryStore-87"><span class="linenos"> 87</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-88"><a href="#ConversationMemoryStore-88"><span class="linenos"> 88</span></a><span class="s2">                             CREATE INDEX IF NOT EXISTS idx_user_timestamp</span>
</span><span id="ConversationMemoryStore-89"><a href="#ConversationMemoryStore-89"><span class="linenos"> 89</span></a><span class="s2">                                 ON conversations(username, email, timestamp DESC)</span>
</span><span id="ConversationMemoryStore-90"><a href="#ConversationMemoryStore-90"><span class="linenos"> 90</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-91"><a href="#ConversationMemoryStore-91"><span class="linenos"> 91</span></a>
</span><span id="ConversationMemoryStore-92"><a href="#ConversationMemoryStore-92"><span class="linenos"> 92</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-93"><a href="#ConversationMemoryStore-93"><span class="linenos"> 93</span></a><span class="s2">                             CREATE INDEX IF NOT EXISTS idx_session</span>
</span><span id="ConversationMemoryStore-94"><a href="#ConversationMemoryStore-94"><span class="linenos"> 94</span></a><span class="s2">                                 ON conversations(session_id)</span>
</span><span id="ConversationMemoryStore-95"><a href="#ConversationMemoryStore-95"><span class="linenos"> 95</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-96"><a href="#ConversationMemoryStore-96"><span class="linenos"> 96</span></a>
</span><span id="ConversationMemoryStore-97"><a href="#ConversationMemoryStore-97"><span class="linenos"> 97</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-98"><a href="#ConversationMemoryStore-98"><span class="linenos"> 98</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Base de données conversations initialisée&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-99"><a href="#ConversationMemoryStore-99"><span class="linenos"> 99</span></a>
</span><span id="ConversationMemoryStore-100"><a href="#ConversationMemoryStore-100"><span class="linenos">100</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-101"><a href="#ConversationMemoryStore-101"><span class="linenos">101</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur initialisation DB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-102"><a href="#ConversationMemoryStore-102"><span class="linenos">102</span></a>            <span class="k">raise</span>
</span><span id="ConversationMemoryStore-103"><a href="#ConversationMemoryStore-103"><span class="linenos">103</span></a>
</span><span id="ConversationMemoryStore-104"><a href="#ConversationMemoryStore-104"><span class="linenos">104</span></a>    <span class="nd">@contextmanager</span>
</span><span id="ConversationMemoryStore-105"><a href="#ConversationMemoryStore-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ConversationMemoryStore-106"><a href="#ConversationMemoryStore-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-107"><a href="#ConversationMemoryStore-107"><span class="linenos">107</span></a><span class="sd">        Fournit un gestionnaire de contexte pour obtenir une connexion à une base de</span>
</span><span id="ConversationMemoryStore-108"><a href="#ConversationMemoryStore-108"><span class="linenos">108</span></a><span class="sd">        données SQLite, avec gestion automatisée des transactions et nettoyage en</span>
</span><span id="ConversationMemoryStore-109"><a href="#ConversationMemoryStore-109"><span class="linenos">109</span></a><span class="sd">        cas d&#39;erreur.</span>
</span><span id="ConversationMemoryStore-110"><a href="#ConversationMemoryStore-110"><span class="linenos">110</span></a>
</span><span id="ConversationMemoryStore-111"><a href="#ConversationMemoryStore-111"><span class="linenos">111</span></a><span class="sd">        Lorsque le gestionnaire de contexte est utilisé, il établit une connexion avec la</span>
</span><span id="ConversationMemoryStore-112"><a href="#ConversationMemoryStore-112"><span class="linenos">112</span></a><span class="sd">        base de données, permet son utilisation à l&#39;intérieur du bloc de code, et se charge</span>
</span><span id="ConversationMemoryStore-113"><a href="#ConversationMemoryStore-113"><span class="linenos">113</span></a><span class="sd">        de fermer la connexion une fois que le bloc de code est terminé ou en cas</span>
</span><span id="ConversationMemoryStore-114"><a href="#ConversationMemoryStore-114"><span class="linenos">114</span></a><span class="sd">        d&#39;exception.</span>
</span><span id="ConversationMemoryStore-115"><a href="#ConversationMemoryStore-115"><span class="linenos">115</span></a>
</span><span id="ConversationMemoryStore-116"><a href="#ConversationMemoryStore-116"><span class="linenos">116</span></a><span class="sd">        :raises Exception: Si une erreur survient pendant l&#39;utilisation de la connexion.</span>
</span><span id="ConversationMemoryStore-117"><a href="#ConversationMemoryStore-117"><span class="linenos">117</span></a><span class="sd">        :return: Un objet connexion SQLite avec `row_factory` configuré pour permettre</span>
</span><span id="ConversationMemoryStore-118"><a href="#ConversationMemoryStore-118"><span class="linenos">118</span></a><span class="sd">                 l&#39;accès aux colonnes par nom.</span>
</span><span id="ConversationMemoryStore-119"><a href="#ConversationMemoryStore-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-120"><a href="#ConversationMemoryStore-120"><span class="linenos">120</span></a>        <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ConversationMemoryStore-121"><a href="#ConversationMemoryStore-121"><span class="linenos">121</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-122"><a href="#ConversationMemoryStore-122"><span class="linenos">122</span></a>            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-123"><a href="#ConversationMemoryStore-123"><span class="linenos">123</span></a>            <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>  <span class="c1"># Pour accéder aux colonnes par nom</span>
</span><span id="ConversationMemoryStore-124"><a href="#ConversationMemoryStore-124"><span class="linenos">124</span></a>            <span class="k">yield</span> <span class="n">conn</span>
</span><span id="ConversationMemoryStore-125"><a href="#ConversationMemoryStore-125"><span class="linenos">125</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-126"><a href="#ConversationMemoryStore-126"><span class="linenos">126</span></a>            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-127"><a href="#ConversationMemoryStore-127"><span class="linenos">127</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-128"><a href="#ConversationMemoryStore-128"><span class="linenos">128</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="ConversationMemoryStore-129"><a href="#ConversationMemoryStore-129"><span class="linenos">129</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-130"><a href="#ConversationMemoryStore-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-131"><a href="#ConversationMemoryStore-131"><span class="linenos">131</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-132"><a href="#ConversationMemoryStore-132"><span class="linenos">132</span></a>
</span><span id="ConversationMemoryStore-133"><a href="#ConversationMemoryStore-133"><span class="linenos">133</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-134"><a href="#ConversationMemoryStore-134"><span class="linenos">134</span></a>                          <span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-135"><a href="#ConversationMemoryStore-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-136"><a href="#ConversationMemoryStore-136"><span class="linenos">136</span></a><span class="sd">        Enregistre une conversation dans la base de données. La fonction enregistre</span>
</span><span id="ConversationMemoryStore-137"><a href="#ConversationMemoryStore-137"><span class="linenos">137</span></a><span class="sd">        les informations fournies, telles que le nom d&#39;utilisateur, l&#39;adresse email,</span>
</span><span id="ConversationMemoryStore-138"><a href="#ConversationMemoryStore-138"><span class="linenos">138</span></a><span class="sd">        la question posée, la réponse donnée ainsi qu&#39;un éventuel identifiant de</span>
</span><span id="ConversationMemoryStore-139"><a href="#ConversationMemoryStore-139"><span class="linenos">139</span></a><span class="sd">        session. Le timestamp est automatiquement ajouté lors de l&#39;insertion.</span>
</span><span id="ConversationMemoryStore-140"><a href="#ConversationMemoryStore-140"><span class="linenos">140</span></a>
</span><span id="ConversationMemoryStore-141"><a href="#ConversationMemoryStore-141"><span class="linenos">141</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur qui a posé la question</span>
</span><span id="ConversationMemoryStore-142"><a href="#ConversationMemoryStore-142"><span class="linenos">142</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore-143"><a href="#ConversationMemoryStore-143"><span class="linenos">143</span></a><span class="sd">        :param email: L&#39;adresse email de l&#39;utilisateur</span>
</span><span id="ConversationMemoryStore-144"><a href="#ConversationMemoryStore-144"><span class="linenos">144</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore-145"><a href="#ConversationMemoryStore-145"><span class="linenos">145</span></a><span class="sd">        :param question: La question posée par l&#39;utilisateur</span>
</span><span id="ConversationMemoryStore-146"><a href="#ConversationMemoryStore-146"><span class="linenos">146</span></a><span class="sd">        :type question: str</span>
</span><span id="ConversationMemoryStore-147"><a href="#ConversationMemoryStore-147"><span class="linenos">147</span></a><span class="sd">        :param reponse: La réponse donnée à l&#39;utilisateur</span>
</span><span id="ConversationMemoryStore-148"><a href="#ConversationMemoryStore-148"><span class="linenos">148</span></a><span class="sd">        :type reponse: str</span>
</span><span id="ConversationMemoryStore-149"><a href="#ConversationMemoryStore-149"><span class="linenos">149</span></a><span class="sd">        :param session_id: L&#39;identifiant de session associé, optionnel</span>
</span><span id="ConversationMemoryStore-150"><a href="#ConversationMemoryStore-150"><span class="linenos">150</span></a><span class="sd">        :type session_id: str, optional</span>
</span><span id="ConversationMemoryStore-151"><a href="#ConversationMemoryStore-151"><span class="linenos">151</span></a><span class="sd">        :return: Retourne True si la conversation a été enregistrée avec succès,</span>
</span><span id="ConversationMemoryStore-152"><a href="#ConversationMemoryStore-152"><span class="linenos">152</span></a><span class="sd">                 False en cas d&#39;échec</span>
</span><span id="ConversationMemoryStore-153"><a href="#ConversationMemoryStore-153"><span class="linenos">153</span></a><span class="sd">        :rtype: bool</span>
</span><span id="ConversationMemoryStore-154"><a href="#ConversationMemoryStore-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-155"><a href="#ConversationMemoryStore-155"><span class="linenos">155</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-156"><a href="#ConversationMemoryStore-156"><span class="linenos">156</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-157"><a href="#ConversationMemoryStore-157"><span class="linenos">157</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-158"><a href="#ConversationMemoryStore-158"><span class="linenos">158</span></a><span class="s2">                             INSERT INTO conversations</span>
</span><span id="ConversationMemoryStore-159"><a href="#ConversationMemoryStore-159"><span class="linenos">159</span></a><span class="s2">                                 (username, email, question, reponse, timestamp, session_id)</span>
</span><span id="ConversationMemoryStore-160"><a href="#ConversationMemoryStore-160"><span class="linenos">160</span></a><span class="s2">                             VALUES (?, ?, ?, ?, ?, ?)</span>
</span><span id="ConversationMemoryStore-161"><a href="#ConversationMemoryStore-161"><span class="linenos">161</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ConversationMemoryStore-162"><a href="#ConversationMemoryStore-162"><span class="linenos">162</span></a>                                 <span class="n">username</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-163"><a href="#ConversationMemoryStore-163"><span class="linenos">163</span></a>                                 <span class="n">email</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-164"><a href="#ConversationMemoryStore-164"><span class="linenos">164</span></a>                                 <span class="n">question</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-165"><a href="#ConversationMemoryStore-165"><span class="linenos">165</span></a>                                 <span class="n">reponse</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-166"><a href="#ConversationMemoryStore-166"><span class="linenos">166</span></a>                                 <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="ConversationMemoryStore-167"><a href="#ConversationMemoryStore-167"><span class="linenos">167</span></a>                                 <span class="n">session_id</span>
</span><span id="ConversationMemoryStore-168"><a href="#ConversationMemoryStore-168"><span class="linenos">168</span></a>                             <span class="p">))</span>
</span><span id="ConversationMemoryStore-169"><a href="#ConversationMemoryStore-169"><span class="linenos">169</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-170"><a href="#ConversationMemoryStore-170"><span class="linenos">170</span></a>
</span><span id="ConversationMemoryStore-171"><a href="#ConversationMemoryStore-171"><span class="linenos">171</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Conversation sauvegardée: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-172"><a href="#ConversationMemoryStore-172"><span class="linenos">172</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="ConversationMemoryStore-173"><a href="#ConversationMemoryStore-173"><span class="linenos">173</span></a>
</span><span id="ConversationMemoryStore-174"><a href="#ConversationMemoryStore-174"><span class="linenos">174</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-175"><a href="#ConversationMemoryStore-175"><span class="linenos">175</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur sauvegarde conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-176"><a href="#ConversationMemoryStore-176"><span class="linenos">176</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="ConversationMemoryStore-177"><a href="#ConversationMemoryStore-177"><span class="linenos">177</span></a>
</span><span id="ConversationMemoryStore-178"><a href="#ConversationMemoryStore-178"><span class="linenos">178</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_history_24h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="ConversationMemoryStore-179"><a href="#ConversationMemoryStore-179"><span class="linenos">179</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-180"><a href="#ConversationMemoryStore-180"><span class="linenos">180</span></a><span class="sd">        Récupère l&#39;historique des conversations de l&#39;utilisateur spécifié au cours des</span>
</span><span id="ConversationMemoryStore-181"><a href="#ConversationMemoryStore-181"><span class="linenos">181</span></a><span class="sd">        dernières 24 heures. Les conversations sont triées par ordre décroissant de</span>
</span><span id="ConversationMemoryStore-182"><a href="#ConversationMemoryStore-182"><span class="linenos">182</span></a><span class="sd">        timestamp.</span>
</span><span id="ConversationMemoryStore-183"><a href="#ConversationMemoryStore-183"><span class="linenos">183</span></a>
</span><span id="ConversationMemoryStore-184"><a href="#ConversationMemoryStore-184"><span class="linenos">184</span></a><span class="sd">        L&#39;historique est limité par un nombre spécifié.</span>
</span><span id="ConversationMemoryStore-185"><a href="#ConversationMemoryStore-185"><span class="linenos">185</span></a>
</span><span id="ConversationMemoryStore-186"><a href="#ConversationMemoryStore-186"><span class="linenos">186</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur de l&#39;utilisateur pour lequel récupérer</span>
</span><span id="ConversationMemoryStore-187"><a href="#ConversationMemoryStore-187"><span class="linenos">187</span></a><span class="sd">            l&#39;historique des conversations.</span>
</span><span id="ConversationMemoryStore-188"><a href="#ConversationMemoryStore-188"><span class="linenos">188</span></a><span class="sd">        :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="ConversationMemoryStore-189"><a href="#ConversationMemoryStore-189"><span class="linenos">189</span></a><span class="sd">        :param limit: (optionnel) Le nombre maximum de conversations à récupérer. La</span>
</span><span id="ConversationMemoryStore-190"><a href="#ConversationMemoryStore-190"><span class="linenos">190</span></a><span class="sd">            valeur par défaut est 20.</span>
</span><span id="ConversationMemoryStore-191"><a href="#ConversationMemoryStore-191"><span class="linenos">191</span></a><span class="sd">        :return: Une liste de dictionnaires contenant les informations des conversations</span>
</span><span id="ConversationMemoryStore-192"><a href="#ConversationMemoryStore-192"><span class="linenos">192</span></a><span class="sd">            récupérées. Chaque dictionnaire inclut les clés suivantes : &#39;question&#39;,</span>
</span><span id="ConversationMemoryStore-193"><a href="#ConversationMemoryStore-193"><span class="linenos">193</span></a><span class="sd">            &#39;reponse&#39;, &#39;timestamp&#39;, et &#39;session_id&#39;.</span>
</span><span id="ConversationMemoryStore-194"><a href="#ConversationMemoryStore-194"><span class="linenos">194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-195"><a href="#ConversationMemoryStore-195"><span class="linenos">195</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-196"><a href="#ConversationMemoryStore-196"><span class="linenos">196</span></a>            <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-197"><a href="#ConversationMemoryStore-197"><span class="linenos">197</span></a>
</span><span id="ConversationMemoryStore-198"><a href="#ConversationMemoryStore-198"><span class="linenos">198</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-199"><a href="#ConversationMemoryStore-199"><span class="linenos">199</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-200"><a href="#ConversationMemoryStore-200"><span class="linenos">200</span></a><span class="s2">                                      SELECT question, reponse, timestamp, session_id</span>
</span><span id="ConversationMemoryStore-201"><a href="#ConversationMemoryStore-201"><span class="linenos">201</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-202"><a href="#ConversationMemoryStore-202"><span class="linenos">202</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore-203"><a href="#ConversationMemoryStore-203"><span class="linenos">203</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore-204"><a href="#ConversationMemoryStore-204"><span class="linenos">204</span></a><span class="s2">                                        AND timestamp &gt;= ?</span>
</span><span id="ConversationMemoryStore-205"><a href="#ConversationMemoryStore-205"><span class="linenos">205</span></a><span class="s2">                                      ORDER BY timestamp DESC</span>
</span><span id="ConversationMemoryStore-206"><a href="#ConversationMemoryStore-206"><span class="linenos">206</span></a><span class="s2">                                          LIMIT ?</span>
</span><span id="ConversationMemoryStore-207"><a href="#ConversationMemoryStore-207"><span class="linenos">207</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-208"><a href="#ConversationMemoryStore-208"><span class="linenos">208</span></a>
</span><span id="ConversationMemoryStore-209"><a href="#ConversationMemoryStore-209"><span class="linenos">209</span></a>                <span class="n">conversations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore-210"><a href="#ConversationMemoryStore-210"><span class="linenos">210</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span><span id="ConversationMemoryStore-211"><a href="#ConversationMemoryStore-211"><span class="linenos">211</span></a>                    <span class="n">conversations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="ConversationMemoryStore-212"><a href="#ConversationMemoryStore-212"><span class="linenos">212</span></a>                        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-213"><a href="#ConversationMemoryStore-213"><span class="linenos">213</span></a>                        <span class="s1">&#39;reponse&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-214"><a href="#ConversationMemoryStore-214"><span class="linenos">214</span></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-215"><a href="#ConversationMemoryStore-215"><span class="linenos">215</span></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-216"><a href="#ConversationMemoryStore-216"><span class="linenos">216</span></a>                    <span class="p">})</span>
</span><span id="ConversationMemoryStore-217"><a href="#ConversationMemoryStore-217"><span class="linenos">217</span></a>
</span><span id="ConversationMemoryStore-218"><a href="#ConversationMemoryStore-218"><span class="linenos">218</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Historique récupéré: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversations pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-219"><a href="#ConversationMemoryStore-219"><span class="linenos">219</span></a>            <span class="k">return</span> <span class="n">conversations</span>
</span><span id="ConversationMemoryStore-220"><a href="#ConversationMemoryStore-220"><span class="linenos">220</span></a>
</span><span id="ConversationMemoryStore-221"><a href="#ConversationMemoryStore-221"><span class="linenos">221</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-222"><a href="#ConversationMemoryStore-222"><span class="linenos">222</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur récupération historique: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-223"><a href="#ConversationMemoryStore-223"><span class="linenos">223</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore-224"><a href="#ConversationMemoryStore-224"><span class="linenos">224</span></a>
</span><span id="ConversationMemoryStore-225"><a href="#ConversationMemoryStore-225"><span class="linenos">225</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_history_for_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_conversations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-226"><a href="#ConversationMemoryStore-226"><span class="linenos">226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-227"><a href="#ConversationMemoryStore-227"><span class="linenos">227</span></a><span class="sd">        Formate l&#39;historique des conversations pour un contexte spécifique en affichant les détails des</span>
</span><span id="ConversationMemoryStore-228"><a href="#ConversationMemoryStore-228"><span class="linenos">228</span></a><span class="sd">        conversations d&#39;un utilisateur au cours des dernières 24 heures.</span>
</span><span id="ConversationMemoryStore-229"><a href="#ConversationMemoryStore-229"><span class="linenos">229</span></a>
</span><span id="ConversationMemoryStore-230"><a href="#ConversationMemoryStore-230"><span class="linenos">230</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel extraire l&#39;historique des conversations.</span>
</span><span id="ConversationMemoryStore-231"><a href="#ConversationMemoryStore-231"><span class="linenos">231</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore-232"><a href="#ConversationMemoryStore-232"><span class="linenos">232</span></a><span class="sd">        :param email: L&#39;email de l&#39;utilisateur correspondant au nom d&#39;utilisateur donné.</span>
</span><span id="ConversationMemoryStore-233"><a href="#ConversationMemoryStore-233"><span class="linenos">233</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore-234"><a href="#ConversationMemoryStore-234"><span class="linenos">234</span></a><span class="sd">        :param max_conversations: Le nombre maximum de conversations à inclure dans le contexte.</span>
</span><span id="ConversationMemoryStore-235"><a href="#ConversationMemoryStore-235"><span class="linenos">235</span></a><span class="sd">            Par défaut, 5.</span>
</span><span id="ConversationMemoryStore-236"><a href="#ConversationMemoryStore-236"><span class="linenos">236</span></a><span class="sd">        :type max_conversations: int</span>
</span><span id="ConversationMemoryStore-237"><a href="#ConversationMemoryStore-237"><span class="linenos">237</span></a><span class="sd">        :return: Une chaîne de caractères formatée contenant l&#39;historique des conversations, ou</span>
</span><span id="ConversationMemoryStore-238"><a href="#ConversationMemoryStore-238"><span class="linenos">238</span></a><span class="sd">            un message indiquant l&#39;absence d&#39;historique.</span>
</span><span id="ConversationMemoryStore-239"><a href="#ConversationMemoryStore-239"><span class="linenos">239</span></a><span class="sd">        :rtype: str</span>
</span><span id="ConversationMemoryStore-240"><a href="#ConversationMemoryStore-240"><span class="linenos">240</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-241"><a href="#ConversationMemoryStore-241"><span class="linenos">241</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_history_24h</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">max_conversations</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-242"><a href="#ConversationMemoryStore-242"><span class="linenos">242</span></a>
</span><span id="ConversationMemoryStore-243"><a href="#ConversationMemoryStore-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-244"><a href="#ConversationMemoryStore-244"><span class="linenos">244</span></a>            <span class="k">return</span> <span class="s2">&quot;HISTORIQUE: Aucune conversation précédente dans les 24h.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-245"><a href="#ConversationMemoryStore-245"><span class="linenos">245</span></a>
</span><span id="ConversationMemoryStore-246"><a href="#ConversationMemoryStore-246"><span class="linenos">246</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HISTORIQUE DES CONVERSATIONS (24h) - Utilisateur: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-247"><a href="#ConversationMemoryStore-247"><span class="linenos">247</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-248"><a href="#ConversationMemoryStore-248"><span class="linenos">248</span></a>
</span><span id="ConversationMemoryStore-249"><a href="#ConversationMemoryStore-249"><span class="linenos">249</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="ConversationMemoryStore-250"><a href="#ConversationMemoryStore-250"><span class="linenos">250</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-251"><a href="#ConversationMemoryStore-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ConversationMemoryStore-252"><a href="#ConversationMemoryStore-252"><span class="linenos">252</span></a>                <span class="c1"># Parse si c&#39;est une string</span>
</span><span id="ConversationMemoryStore-253"><a href="#ConversationMemoryStore-253"><span class="linenos">253</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-254"><a href="#ConversationMemoryStore-254"><span class="linenos">254</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-255"><a href="#ConversationMemoryStore-255"><span class="linenos">255</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-256"><a href="#ConversationMemoryStore-256"><span class="linenos">256</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="ConversationMemoryStore-257"><a href="#ConversationMemoryStore-257"><span class="linenos">257</span></a>
</span><span id="ConversationMemoryStore-258"><a href="#ConversationMemoryStore-258"><span class="linenos">258</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CONVERSATION </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] - </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-259"><a href="#ConversationMemoryStore-259"><span class="linenos">259</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Q: </span><span class="si">{</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-260"><a href="#ConversationMemoryStore-260"><span class="linenos">260</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;R: </span><span class="si">{</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-261"><a href="#ConversationMemoryStore-261"><span class="linenos">261</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-262"><a href="#ConversationMemoryStore-262"><span class="linenos">262</span></a>
</span><span id="ConversationMemoryStore-263"><a href="#ConversationMemoryStore-263"><span class="linenos">263</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversation(s) récente(s)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-264"><a href="#ConversationMemoryStore-264"><span class="linenos">264</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore-265"><a href="#ConversationMemoryStore-265"><span class="linenos">265</span></a>
</span><span id="ConversationMemoryStore-266"><a href="#ConversationMemoryStore-266"><span class="linenos">266</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="ConversationMemoryStore-267"><a href="#ConversationMemoryStore-267"><span class="linenos">267</span></a>
</span><span id="ConversationMemoryStore-268"><a href="#ConversationMemoryStore-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-269"><a href="#ConversationMemoryStore-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-270"><a href="#ConversationMemoryStore-270"><span class="linenos">270</span></a><span class="sd">        Récupère les statistiques liées aux conversations d&#39;un utilisateur, y compris le total des conversations,</span>
</span><span id="ConversationMemoryStore-271"><a href="#ConversationMemoryStore-271"><span class="linenos">271</span></a><span class="sd">        le nombre de conversations dans les dernières 24 heures et les détails de la dernière conversation.</span>
</span><span id="ConversationMemoryStore-272"><a href="#ConversationMemoryStore-272"><span class="linenos">272</span></a>
</span><span id="ConversationMemoryStore-273"><a href="#ConversationMemoryStore-273"><span class="linenos">273</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel rechercher les statistiques</span>
</span><span id="ConversationMemoryStore-274"><a href="#ConversationMemoryStore-274"><span class="linenos">274</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore-275"><a href="#ConversationMemoryStore-275"><span class="linenos">275</span></a><span class="sd">        :param email: L&#39;adresse email de l&#39;utilisateur pour lequel rechercher les statistiques</span>
</span><span id="ConversationMemoryStore-276"><a href="#ConversationMemoryStore-276"><span class="linenos">276</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore-277"><a href="#ConversationMemoryStore-277"><span class="linenos">277</span></a><span class="sd">        :return: Un dictionnaire contenant les statistiques suivantes :</span>
</span><span id="ConversationMemoryStore-278"><a href="#ConversationMemoryStore-278"><span class="linenos">278</span></a><span class="sd">                 - &#39;total_conversations&#39;: nombre total de conversations</span>
</span><span id="ConversationMemoryStore-279"><a href="#ConversationMemoryStore-279"><span class="linenos">279</span></a><span class="sd">                 - &#39;conversations_24h&#39;: nombre de conversations dans les 24 dernières heures</span>
</span><span id="ConversationMemoryStore-280"><a href="#ConversationMemoryStore-280"><span class="linenos">280</span></a><span class="sd">                 - &#39;last_conversation&#39;: détails de la dernière conversation incluant &#39;timestamp&#39; et &#39;question&#39;</span>
</span><span id="ConversationMemoryStore-281"><a href="#ConversationMemoryStore-281"><span class="linenos">281</span></a><span class="sd">        :rtype: Dict</span>
</span><span id="ConversationMemoryStore-282"><a href="#ConversationMemoryStore-282"><span class="linenos">282</span></a><span class="sd">        :raises Exception: En cas d&#39;erreur lors de l&#39;exécution des requêtes ou de la connexion à la base de données</span>
</span><span id="ConversationMemoryStore-283"><a href="#ConversationMemoryStore-283"><span class="linenos">283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-284"><a href="#ConversationMemoryStore-284"><span class="linenos">284</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-285"><a href="#ConversationMemoryStore-285"><span class="linenos">285</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-286"><a href="#ConversationMemoryStore-286"><span class="linenos">286</span></a>                <span class="c1"># Total conversations</span>
</span><span id="ConversationMemoryStore-287"><a href="#ConversationMemoryStore-287"><span class="linenos">287</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-288"><a href="#ConversationMemoryStore-288"><span class="linenos">288</span></a><span class="s2">                                      SELECT COUNT(*) as total</span>
</span><span id="ConversationMemoryStore-289"><a href="#ConversationMemoryStore-289"><span class="linenos">289</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-290"><a href="#ConversationMemoryStore-290"><span class="linenos">290</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore-291"><a href="#ConversationMemoryStore-291"><span class="linenos">291</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore-292"><a href="#ConversationMemoryStore-292"><span class="linenos">292</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-293"><a href="#ConversationMemoryStore-293"><span class="linenos">293</span></a>                <span class="n">total</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-294"><a href="#ConversationMemoryStore-294"><span class="linenos">294</span></a>
</span><span id="ConversationMemoryStore-295"><a href="#ConversationMemoryStore-295"><span class="linenos">295</span></a>                <span class="c1"># Conversations 24h</span>
</span><span id="ConversationMemoryStore-296"><a href="#ConversationMemoryStore-296"><span class="linenos">296</span></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-297"><a href="#ConversationMemoryStore-297"><span class="linenos">297</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-298"><a href="#ConversationMemoryStore-298"><span class="linenos">298</span></a><span class="s2">                                      SELECT COUNT(*) as recent</span>
</span><span id="ConversationMemoryStore-299"><a href="#ConversationMemoryStore-299"><span class="linenos">299</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-300"><a href="#ConversationMemoryStore-300"><span class="linenos">300</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore-301"><a href="#ConversationMemoryStore-301"><span class="linenos">301</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore-302"><a href="#ConversationMemoryStore-302"><span class="linenos">302</span></a><span class="s2">                                        AND timestamp &gt;= ?</span>
</span><span id="ConversationMemoryStore-303"><a href="#ConversationMemoryStore-303"><span class="linenos">303</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-304"><a href="#ConversationMemoryStore-304"><span class="linenos">304</span></a>                <span class="n">recent</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;recent&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-305"><a href="#ConversationMemoryStore-305"><span class="linenos">305</span></a>
</span><span id="ConversationMemoryStore-306"><a href="#ConversationMemoryStore-306"><span class="linenos">306</span></a>                <span class="c1"># Dernière conversation</span>
</span><span id="ConversationMemoryStore-307"><a href="#ConversationMemoryStore-307"><span class="linenos">307</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-308"><a href="#ConversationMemoryStore-308"><span class="linenos">308</span></a><span class="s2">                                      SELECT timestamp, question</span>
</span><span id="ConversationMemoryStore-309"><a href="#ConversationMemoryStore-309"><span class="linenos">309</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-310"><a href="#ConversationMemoryStore-310"><span class="linenos">310</span></a><span class="s2">                                      WHERE username = ? AND email = ?</span>
</span><span id="ConversationMemoryStore-311"><a href="#ConversationMemoryStore-311"><span class="linenos">311</span></a><span class="s2">                                      ORDER BY timestamp DESC LIMIT 1</span>
</span><span id="ConversationMemoryStore-312"><a href="#ConversationMemoryStore-312"><span class="linenos">312</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-313"><a href="#ConversationMemoryStore-313"><span class="linenos">313</span></a>                <span class="n">last_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-314"><a href="#ConversationMemoryStore-314"><span class="linenos">314</span></a>                <span class="n">last_conversation</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore-315"><a href="#ConversationMemoryStore-315"><span class="linenos">315</span></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-316"><a href="#ConversationMemoryStore-316"><span class="linenos">316</span></a>                    <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ConversationMemoryStore-317"><a href="#ConversationMemoryStore-317"><span class="linenos">317</span></a>                <span class="p">}</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ConversationMemoryStore-318"><a href="#ConversationMemoryStore-318"><span class="linenos">318</span></a>
</span><span id="ConversationMemoryStore-319"><a href="#ConversationMemoryStore-319"><span class="linenos">319</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore-320"><a href="#ConversationMemoryStore-320"><span class="linenos">320</span></a>                <span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-321"><a href="#ConversationMemoryStore-321"><span class="linenos">321</span></a>                <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-322"><a href="#ConversationMemoryStore-322"><span class="linenos">322</span></a>                <span class="s1">&#39;last_conversation&#39;</span><span class="p">:</span> <span class="n">last_conversation</span>
</span><span id="ConversationMemoryStore-323"><a href="#ConversationMemoryStore-323"><span class="linenos">323</span></a>            <span class="p">}</span>
</span><span id="ConversationMemoryStore-324"><a href="#ConversationMemoryStore-324"><span class="linenos">324</span></a>
</span><span id="ConversationMemoryStore-325"><a href="#ConversationMemoryStore-325"><span class="linenos">325</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-326"><a href="#ConversationMemoryStore-326"><span class="linenos">326</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur statistiques: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-327"><a href="#ConversationMemoryStore-327"><span class="linenos">327</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;last_conversation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="ConversationMemoryStore-328"><a href="#ConversationMemoryStore-328"><span class="linenos">328</span></a>
</span><span id="ConversationMemoryStore-329"><a href="#ConversationMemoryStore-329"><span class="linenos">329</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_to_keep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-330"><a href="#ConversationMemoryStore-330"><span class="linenos">330</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-331"><a href="#ConversationMemoryStore-331"><span class="linenos">331</span></a><span class="sd">        Supprime les anciennes conversations de la base de données qui ont une date</span>
</span><span id="ConversationMemoryStore-332"><a href="#ConversationMemoryStore-332"><span class="linenos">332</span></a><span class="sd">        antérieure à un nombre de jours spécifié (days_to_keep). Cette méthode effectue</span>
</span><span id="ConversationMemoryStore-333"><a href="#ConversationMemoryStore-333"><span class="linenos">333</span></a><span class="sd">        un nettoyage des données en supprimant les enregistrements obsolètes d&#39;après</span>
</span><span id="ConversationMemoryStore-334"><a href="#ConversationMemoryStore-334"><span class="linenos">334</span></a><span class="sd">        la date limite calculée.</span>
</span><span id="ConversationMemoryStore-335"><a href="#ConversationMemoryStore-335"><span class="linenos">335</span></a>
</span><span id="ConversationMemoryStore-336"><a href="#ConversationMemoryStore-336"><span class="linenos">336</span></a><span class="sd">        :param days_to_keep: Nombre de jours avant lesquels les conversations</span>
</span><span id="ConversationMemoryStore-337"><a href="#ConversationMemoryStore-337"><span class="linenos">337</span></a><span class="sd">            doivent être supprimées (par défaut 30).</span>
</span><span id="ConversationMemoryStore-338"><a href="#ConversationMemoryStore-338"><span class="linenos">338</span></a><span class="sd">        :type days_to_keep: int</span>
</span><span id="ConversationMemoryStore-339"><a href="#ConversationMemoryStore-339"><span class="linenos">339</span></a><span class="sd">        :return: Le nombre de conversations supprimées.</span>
</span><span id="ConversationMemoryStore-340"><a href="#ConversationMemoryStore-340"><span class="linenos">340</span></a><span class="sd">        :rtype: int</span>
</span><span id="ConversationMemoryStore-341"><a href="#ConversationMemoryStore-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-342"><a href="#ConversationMemoryStore-342"><span class="linenos">342</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-343"><a href="#ConversationMemoryStore-343"><span class="linenos">343</span></a>            <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_to_keep</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-344"><a href="#ConversationMemoryStore-344"><span class="linenos">344</span></a>
</span><span id="ConversationMemoryStore-345"><a href="#ConversationMemoryStore-345"><span class="linenos">345</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-346"><a href="#ConversationMemoryStore-346"><span class="linenos">346</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-347"><a href="#ConversationMemoryStore-347"><span class="linenos">347</span></a><span class="s2">                                      DELETE</span>
</span><span id="ConversationMemoryStore-348"><a href="#ConversationMemoryStore-348"><span class="linenos">348</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-349"><a href="#ConversationMemoryStore-349"><span class="linenos">349</span></a><span class="s2">                                      WHERE timestamp &lt; ?</span>
</span><span id="ConversationMemoryStore-350"><a href="#ConversationMemoryStore-350"><span class="linenos">350</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cutoff_date</span><span class="p">,))</span>
</span><span id="ConversationMemoryStore-351"><a href="#ConversationMemoryStore-351"><span class="linenos">351</span></a>                <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="ConversationMemoryStore-352"><a href="#ConversationMemoryStore-352"><span class="linenos">352</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-353"><a href="#ConversationMemoryStore-353"><span class="linenos">353</span></a>
</span><span id="ConversationMemoryStore-354"><a href="#ConversationMemoryStore-354"><span class="linenos">354</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Nettoyage: </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> conversations supprimées (&gt; </span><span class="si">{</span><span class="n">days_to_keep</span><span class="si">}</span><span class="s2"> jours)&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-355"><a href="#ConversationMemoryStore-355"><span class="linenos">355</span></a>            <span class="k">return</span> <span class="n">deleted_count</span>
</span><span id="ConversationMemoryStore-356"><a href="#ConversationMemoryStore-356"><span class="linenos">356</span></a>
</span><span id="ConversationMemoryStore-357"><a href="#ConversationMemoryStore-357"><span class="linenos">357</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-358"><a href="#ConversationMemoryStore-358"><span class="linenos">358</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur nettoyage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-359"><a href="#ConversationMemoryStore-359"><span class="linenos">359</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="ConversationMemoryStore-360"><a href="#ConversationMemoryStore-360"><span class="linenos">360</span></a>
</span><span id="ConversationMemoryStore-361"><a href="#ConversationMemoryStore-361"><span class="linenos">361</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="ConversationMemoryStore-362"><a href="#ConversationMemoryStore-362"><span class="linenos">362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-363"><a href="#ConversationMemoryStore-363"><span class="linenos">363</span></a><span class="sd">        Récupère tous les utilisateurs distincts avec leurs noms d&#39;utilisateur et leurs</span>
</span><span id="ConversationMemoryStore-364"><a href="#ConversationMemoryStore-364"><span class="linenos">364</span></a><span class="sd">        adresses e-mail à partir de la base de données. Les utilisateurs sont renvoyés</span>
</span><span id="ConversationMemoryStore-365"><a href="#ConversationMemoryStore-365"><span class="linenos">365</span></a><span class="sd">        dans un ordre alphabétique basé sur leurs noms d&#39;utilisateur.</span>
</span><span id="ConversationMemoryStore-366"><a href="#ConversationMemoryStore-366"><span class="linenos">366</span></a>
</span><span id="ConversationMemoryStore-367"><a href="#ConversationMemoryStore-367"><span class="linenos">367</span></a><span class="sd">        :return: Une liste de tuples contenant les noms d&#39;utilisateur et adresses e-mail</span>
</span><span id="ConversationMemoryStore-368"><a href="#ConversationMemoryStore-368"><span class="linenos">368</span></a><span class="sd">                 de tous les utilisateurs distincts dans la base de données. Si une erreur</span>
</span><span id="ConversationMemoryStore-369"><a href="#ConversationMemoryStore-369"><span class="linenos">369</span></a><span class="sd">                 se produit, retourne une liste vide.</span>
</span><span id="ConversationMemoryStore-370"><a href="#ConversationMemoryStore-370"><span class="linenos">370</span></a><span class="sd">        :rtype: List[Tuple[str, str]]</span>
</span><span id="ConversationMemoryStore-371"><a href="#ConversationMemoryStore-371"><span class="linenos">371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-372"><a href="#ConversationMemoryStore-372"><span class="linenos">372</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-373"><a href="#ConversationMemoryStore-373"><span class="linenos">373</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-374"><a href="#ConversationMemoryStore-374"><span class="linenos">374</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-375"><a href="#ConversationMemoryStore-375"><span class="linenos">375</span></a><span class="s2">                                      SELECT DISTINCT username, email</span>
</span><span id="ConversationMemoryStore-376"><a href="#ConversationMemoryStore-376"><span class="linenos">376</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-377"><a href="#ConversationMemoryStore-377"><span class="linenos">377</span></a><span class="s2">                                      ORDER BY username</span>
</span><span id="ConversationMemoryStore-378"><a href="#ConversationMemoryStore-378"><span class="linenos">378</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-379"><a href="#ConversationMemoryStore-379"><span class="linenos">379</span></a>                <span class="k">return</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span><span id="ConversationMemoryStore-380"><a href="#ConversationMemoryStore-380"><span class="linenos">380</span></a>
</span><span id="ConversationMemoryStore-381"><a href="#ConversationMemoryStore-381"><span class="linenos">381</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-382"><a href="#ConversationMemoryStore-382"><span class="linenos">382</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur liste utilisateurs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-383"><a href="#ConversationMemoryStore-383"><span class="linenos">383</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore-384"><a href="#ConversationMemoryStore-384"><span class="linenos">384</span></a>
</span><span id="ConversationMemoryStore-385"><a href="#ConversationMemoryStore-385"><span class="linenos">385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-386"><a href="#ConversationMemoryStore-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-387"><a href="#ConversationMemoryStore-387"><span class="linenos">387</span></a><span class="sd">        Supprime les conversations associées à un utilisateur spécifique.</span>
</span><span id="ConversationMemoryStore-388"><a href="#ConversationMemoryStore-388"><span class="linenos">388</span></a>
</span><span id="ConversationMemoryStore-389"><a href="#ConversationMemoryStore-389"><span class="linenos">389</span></a><span class="sd">        Cette méthode permet de supprimer toutes les conversations d&#39;un utilisateur donné</span>
</span><span id="ConversationMemoryStore-390"><a href="#ConversationMemoryStore-390"><span class="linenos">390</span></a><span class="sd">        en fonction de son nom d&#39;utilisateur (username) et de son adresse e-mail.</span>
</span><span id="ConversationMemoryStore-391"><a href="#ConversationMemoryStore-391"><span class="linenos">391</span></a>
</span><span id="ConversationMemoryStore-392"><a href="#ConversationMemoryStore-392"><span class="linenos">392</span></a><span class="sd">        :param username: Nom d&#39;utilisateur de l&#39;individu dont les conversations doivent</span>
</span><span id="ConversationMemoryStore-393"><a href="#ConversationMemoryStore-393"><span class="linenos">393</span></a><span class="sd">            être supprimées.</span>
</span><span id="ConversationMemoryStore-394"><a href="#ConversationMemoryStore-394"><span class="linenos">394</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore-395"><a href="#ConversationMemoryStore-395"><span class="linenos">395</span></a><span class="sd">        :param email: Adresse e-mail de l&#39;utilisateur dont les conversations sont à</span>
</span><span id="ConversationMemoryStore-396"><a href="#ConversationMemoryStore-396"><span class="linenos">396</span></a><span class="sd">            supprimer.</span>
</span><span id="ConversationMemoryStore-397"><a href="#ConversationMemoryStore-397"><span class="linenos">397</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore-398"><a href="#ConversationMemoryStore-398"><span class="linenos">398</span></a><span class="sd">        :return: Le nombre total de conversations supprimées avec succès pour cet</span>
</span><span id="ConversationMemoryStore-399"><a href="#ConversationMemoryStore-399"><span class="linenos">399</span></a><span class="sd">            utilisateur. Retourne `0` en cas d&#39;échec ou si aucune conversation n&#39;a été</span>
</span><span id="ConversationMemoryStore-400"><a href="#ConversationMemoryStore-400"><span class="linenos">400</span></a><span class="sd">            supprimée.</span>
</span><span id="ConversationMemoryStore-401"><a href="#ConversationMemoryStore-401"><span class="linenos">401</span></a><span class="sd">        :rtype: int</span>
</span><span id="ConversationMemoryStore-402"><a href="#ConversationMemoryStore-402"><span class="linenos">402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-403"><a href="#ConversationMemoryStore-403"><span class="linenos">403</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-404"><a href="#ConversationMemoryStore-404"><span class="linenos">404</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-405"><a href="#ConversationMemoryStore-405"><span class="linenos">405</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-406"><a href="#ConversationMemoryStore-406"><span class="linenos">406</span></a><span class="s2">                                      DELETE</span>
</span><span id="ConversationMemoryStore-407"><a href="#ConversationMemoryStore-407"><span class="linenos">407</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-408"><a href="#ConversationMemoryStore-408"><span class="linenos">408</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore-409"><a href="#ConversationMemoryStore-409"><span class="linenos">409</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore-410"><a href="#ConversationMemoryStore-410"><span class="linenos">410</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-411"><a href="#ConversationMemoryStore-411"><span class="linenos">411</span></a>                <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="ConversationMemoryStore-412"><a href="#ConversationMemoryStore-412"><span class="linenos">412</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore-413"><a href="#ConversationMemoryStore-413"><span class="linenos">413</span></a>
</span><span id="ConversationMemoryStore-414"><a href="#ConversationMemoryStore-414"><span class="linenos">414</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> conversations supprimées pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-415"><a href="#ConversationMemoryStore-415"><span class="linenos">415</span></a>            <span class="k">return</span> <span class="n">deleted_count</span>
</span><span id="ConversationMemoryStore-416"><a href="#ConversationMemoryStore-416"><span class="linenos">416</span></a>
</span><span id="ConversationMemoryStore-417"><a href="#ConversationMemoryStore-417"><span class="linenos">417</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-418"><a href="#ConversationMemoryStore-418"><span class="linenos">418</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur suppression utilisateur: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-419"><a href="#ConversationMemoryStore-419"><span class="linenos">419</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="ConversationMemoryStore-420"><a href="#ConversationMemoryStore-420"><span class="linenos">420</span></a>
</span><span id="ConversationMemoryStore-421"><a href="#ConversationMemoryStore-421"><span class="linenos">421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_user_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="ConversationMemoryStore-422"><a href="#ConversationMemoryStore-422"><span class="linenos">422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-423"><a href="#ConversationMemoryStore-423"><span class="linenos">423</span></a><span class="sd">        Exporte les conversations d&#39;un utilisateur à partir de la base de données en fonction de son</span>
</span><span id="ConversationMemoryStore-424"><a href="#ConversationMemoryStore-424"><span class="linenos">424</span></a><span class="sd">        nom d&#39;utilisateur et de son email. Les conversations sont triées par ordre décroissant de leur</span>
</span><span id="ConversationMemoryStore-425"><a href="#ConversationMemoryStore-425"><span class="linenos">425</span></a><span class="sd">        horodatage.</span>
</span><span id="ConversationMemoryStore-426"><a href="#ConversationMemoryStore-426"><span class="linenos">426</span></a>
</span><span id="ConversationMemoryStore-427"><a href="#ConversationMemoryStore-427"><span class="linenos">427</span></a><span class="sd">        Cette méthode effectue une requête SQL pour récupérer les conversations correspondantes dans la</span>
</span><span id="ConversationMemoryStore-428"><a href="#ConversationMemoryStore-428"><span class="linenos">428</span></a><span class="sd">        base de données, puis les formate sous forme de liste de dictionnaires, où chaque dictionnaire</span>
</span><span id="ConversationMemoryStore-429"><a href="#ConversationMemoryStore-429"><span class="linenos">429</span></a><span class="sd">        représente une conversation.</span>
</span><span id="ConversationMemoryStore-430"><a href="#ConversationMemoryStore-430"><span class="linenos">430</span></a>
</span><span id="ConversationMemoryStore-431"><a href="#ConversationMemoryStore-431"><span class="linenos">431</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel les conversations doivent être exportées.</span>
</span><span id="ConversationMemoryStore-432"><a href="#ConversationMemoryStore-432"><span class="linenos">432</span></a><span class="sd">        :param email: L&#39;adresse e-mail associée à l&#39;utilisateur pour l&#39;extraction des conversations.</span>
</span><span id="ConversationMemoryStore-433"><a href="#ConversationMemoryStore-433"><span class="linenos">433</span></a><span class="sd">        :return: Une liste de dictionnaires représentant les conversations de l&#39;utilisateur, ou une</span>
</span><span id="ConversationMemoryStore-434"><a href="#ConversationMemoryStore-434"><span class="linenos">434</span></a><span class="sd">                 liste vide en cas d&#39;erreur.</span>
</span><span id="ConversationMemoryStore-435"><a href="#ConversationMemoryStore-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-436"><a href="#ConversationMemoryStore-436"><span class="linenos">436</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-437"><a href="#ConversationMemoryStore-437"><span class="linenos">437</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-438"><a href="#ConversationMemoryStore-438"><span class="linenos">438</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-439"><a href="#ConversationMemoryStore-439"><span class="linenos">439</span></a><span class="s2">                                      SELECT *</span>
</span><span id="ConversationMemoryStore-440"><a href="#ConversationMemoryStore-440"><span class="linenos">440</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore-441"><a href="#ConversationMemoryStore-441"><span class="linenos">441</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore-442"><a href="#ConversationMemoryStore-442"><span class="linenos">442</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore-443"><a href="#ConversationMemoryStore-443"><span class="linenos">443</span></a><span class="s2">                                      ORDER BY timestamp DESC</span>
</span><span id="ConversationMemoryStore-444"><a href="#ConversationMemoryStore-444"><span class="linenos">444</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore-445"><a href="#ConversationMemoryStore-445"><span class="linenos">445</span></a>
</span><span id="ConversationMemoryStore-446"><a href="#ConversationMemoryStore-446"><span class="linenos">446</span></a>                <span class="n">conversations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore-447"><a href="#ConversationMemoryStore-447"><span class="linenos">447</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span><span id="ConversationMemoryStore-448"><a href="#ConversationMemoryStore-448"><span class="linenos">448</span></a>                    <span class="n">conversations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="ConversationMemoryStore-449"><a href="#ConversationMemoryStore-449"><span class="linenos">449</span></a>                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-450"><a href="#ConversationMemoryStore-450"><span class="linenos">450</span></a>                        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-451"><a href="#ConversationMemoryStore-451"><span class="linenos">451</span></a>                        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-452"><a href="#ConversationMemoryStore-452"><span class="linenos">452</span></a>                        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-453"><a href="#ConversationMemoryStore-453"><span class="linenos">453</span></a>                        <span class="s1">&#39;reponse&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-454"><a href="#ConversationMemoryStore-454"><span class="linenos">454</span></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-455"><a href="#ConversationMemoryStore-455"><span class="linenos">455</span></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore-456"><a href="#ConversationMemoryStore-456"><span class="linenos">456</span></a>                        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-457"><a href="#ConversationMemoryStore-457"><span class="linenos">457</span></a>                    <span class="p">})</span>
</span><span id="ConversationMemoryStore-458"><a href="#ConversationMemoryStore-458"><span class="linenos">458</span></a>
</span><span id="ConversationMemoryStore-459"><a href="#ConversationMemoryStore-459"><span class="linenos">459</span></a>            <span class="k">return</span> <span class="n">conversations</span>
</span><span id="ConversationMemoryStore-460"><a href="#ConversationMemoryStore-460"><span class="linenos">460</span></a>
</span><span id="ConversationMemoryStore-461"><a href="#ConversationMemoryStore-461"><span class="linenos">461</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-462"><a href="#ConversationMemoryStore-462"><span class="linenos">462</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur export: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-463"><a href="#ConversationMemoryStore-463"><span class="linenos">463</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore-464"><a href="#ConversationMemoryStore-464"><span class="linenos">464</span></a>
</span><span id="ConversationMemoryStore-465"><a href="#ConversationMemoryStore-465"><span class="linenos">465</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_database_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-466"><a href="#ConversationMemoryStore-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-467"><a href="#ConversationMemoryStore-467"><span class="linenos">467</span></a><span class="sd">        Vérifie l&#39;état de santé de la base de données et retourne des statistiques détaillées sur son utilisation. Cette</span>
</span><span id="ConversationMemoryStore-468"><a href="#ConversationMemoryStore-468"><span class="linenos">468</span></a><span class="sd">        fonction évalue la taille de la base, le nombre total de conversations stockées, les utilisateurs uniques,</span>
</span><span id="ConversationMemoryStore-469"><a href="#ConversationMemoryStore-469"><span class="linenos">469</span></a><span class="sd">        ainsi que le nombre de conversations enregistrées durant les dernières 24 heures.</span>
</span><span id="ConversationMemoryStore-470"><a href="#ConversationMemoryStore-470"><span class="linenos">470</span></a>
</span><span id="ConversationMemoryStore-471"><a href="#ConversationMemoryStore-471"><span class="linenos">471</span></a><span class="sd">        :return: Un dictionnaire contenant des informations sur la santé de la base de données, y compris</span>
</span><span id="ConversationMemoryStore-472"><a href="#ConversationMemoryStore-472"><span class="linenos">472</span></a><span class="sd">            le chemin absolu de la base, sa taille en octets et mégaoctets, le nombre total de conversations</span>
</span><span id="ConversationMemoryStore-473"><a href="#ConversationMemoryStore-473"><span class="linenos">473</span></a><span class="sd">            enregistrées, le total d&#39;utilisateurs uniques et le nombre de conversations dans les dernières 24 heures.</span>
</span><span id="ConversationMemoryStore-474"><a href="#ConversationMemoryStore-474"><span class="linenos">474</span></a><span class="sd">            Si une erreur survient lors du diagnostic, elle inclut l&#39;erreur et marque l&#39;état de la base comme</span>
</span><span id="ConversationMemoryStore-475"><a href="#ConversationMemoryStore-475"><span class="linenos">475</span></a><span class="sd">            « error ».</span>
</span><span id="ConversationMemoryStore-476"><a href="#ConversationMemoryStore-476"><span class="linenos">476</span></a><span class="sd">        :rtype: Dict</span>
</span><span id="ConversationMemoryStore-477"><a href="#ConversationMemoryStore-477"><span class="linenos">477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore-478"><a href="#ConversationMemoryStore-478"><span class="linenos">478</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-479"><a href="#ConversationMemoryStore-479"><span class="linenos">479</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-480"><a href="#ConversationMemoryStore-480"><span class="linenos">480</span></a>                <span class="c1"># Taille de la base</span>
</span><span id="ConversationMemoryStore-481"><a href="#ConversationMemoryStore-481"><span class="linenos">481</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) as total FROM conversations&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-482"><a href="#ConversationMemoryStore-482"><span class="linenos">482</span></a>                <span class="n">total_conversations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-483"><a href="#ConversationMemoryStore-483"><span class="linenos">483</span></a>
</span><span id="ConversationMemoryStore-484"><a href="#ConversationMemoryStore-484"><span class="linenos">484</span></a>                <span class="c1"># Utilisateurs uniques</span>
</span><span id="ConversationMemoryStore-485"><a href="#ConversationMemoryStore-485"><span class="linenos">485</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(DISTINCT username, email) as users FROM conversations&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-486"><a href="#ConversationMemoryStore-486"><span class="linenos">486</span></a>                <span class="n">total_users</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-487"><a href="#ConversationMemoryStore-487"><span class="linenos">487</span></a>
</span><span id="ConversationMemoryStore-488"><a href="#ConversationMemoryStore-488"><span class="linenos">488</span></a>                <span class="c1"># Conversations récentes (24h)</span>
</span><span id="ConversationMemoryStore-489"><a href="#ConversationMemoryStore-489"><span class="linenos">489</span></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-490"><a href="#ConversationMemoryStore-490"><span class="linenos">490</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) as recent FROM conversations WHERE timestamp &gt;= ?&quot;</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-491"><a href="#ConversationMemoryStore-491"><span class="linenos">491</span></a>                                      <span class="p">(</span><span class="n">cutoff_time</span><span class="p">,))</span>
</span><span id="ConversationMemoryStore-492"><a href="#ConversationMemoryStore-492"><span class="linenos">492</span></a>                <span class="n">recent_conversations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;recent&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore-493"><a href="#ConversationMemoryStore-493"><span class="linenos">493</span></a>
</span><span id="ConversationMemoryStore-494"><a href="#ConversationMemoryStore-494"><span class="linenos">494</span></a>                <span class="c1"># Taille du fichier</span>
</span><span id="ConversationMemoryStore-495"><a href="#ConversationMemoryStore-495"><span class="linenos">495</span></a>                <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="ConversationMemoryStore-496"><a href="#ConversationMemoryStore-496"><span class="linenos">496</span></a>
</span><span id="ConversationMemoryStore-497"><a href="#ConversationMemoryStore-497"><span class="linenos">497</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore-498"><a href="#ConversationMemoryStore-498"><span class="linenos">498</span></a>                <span class="s1">&#39;database_path&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">),</span>
</span><span id="ConversationMemoryStore-499"><a href="#ConversationMemoryStore-499"><span class="linenos">499</span></a>                <span class="s1">&#39;file_size_bytes&#39;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-500"><a href="#ConversationMemoryStore-500"><span class="linenos">500</span></a>                <span class="s1">&#39;file_size_mb&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="ConversationMemoryStore-501"><a href="#ConversationMemoryStore-501"><span class="linenos">501</span></a>                <span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="n">total_conversations</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-502"><a href="#ConversationMemoryStore-502"><span class="linenos">502</span></a>                <span class="s1">&#39;total_users&#39;</span><span class="p">:</span> <span class="n">total_users</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-503"><a href="#ConversationMemoryStore-503"><span class="linenos">503</span></a>                <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="n">recent_conversations</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-504"><a href="#ConversationMemoryStore-504"><span class="linenos">504</span></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span>
</span><span id="ConversationMemoryStore-505"><a href="#ConversationMemoryStore-505"><span class="linenos">505</span></a>            <span class="p">}</span>
</span><span id="ConversationMemoryStore-506"><a href="#ConversationMemoryStore-506"><span class="linenos">506</span></a>
</span><span id="ConversationMemoryStore-507"><a href="#ConversationMemoryStore-507"><span class="linenos">507</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore-508"><a href="#ConversationMemoryStore-508"><span class="linenos">508</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur vérification santé DB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-509"><a href="#ConversationMemoryStore-509"><span class="linenos">509</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore-510"><a href="#ConversationMemoryStore-510"><span class="linenos">510</span></a>                <span class="s1">&#39;database_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-511"><a href="#ConversationMemoryStore-511"><span class="linenos">511</span></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
</span><span id="ConversationMemoryStore-512"><a href="#ConversationMemoryStore-512"><span class="linenos">512</span></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="ConversationMemoryStore-513"><a href="#ConversationMemoryStore-513"><span class="linenos">513</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Classe pour gérer le stockage des conversations en utilisant SQLite.</p>

<p>Cette classe fournit des fonctionnalités pour enregistrer, récupérer et analyser
les conversations des utilisateurs. Elle inclut également des méthodes pour nettoyer
les conversations anciennes et formater les données pour des besoins spécifiques,
comme le contexte des agents d'intelligence artificielle.</p>

<p>:ivar db_path: Chemin vers la base de données SQLite utilisée pour stocker les conversations.</p>
</div>


                            <div id="ConversationMemoryStore.__init__" class="classattr">
                                        <input id="ConversationMemoryStore.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ConversationMemoryStore</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;conversations.db&#39;</span></span>)</span>

                <label class="view-source-button" for="ConversationMemoryStore.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.__init__-25"><a href="#ConversationMemoryStore.__init__-25"><span class="linenos">25</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;conversations.db&quot;</span><span class="p">):</span>
</span><span id="ConversationMemoryStore.__init__-26"><a href="#ConversationMemoryStore.__init__-26"><span class="linenos">26</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.__init__-27"><a href="#ConversationMemoryStore.__init__-27"><span class="linenos">27</span></a><span class="sd">        Initialise le store SQLite</span>
</span><span id="ConversationMemoryStore.__init__-28"><a href="#ConversationMemoryStore.__init__-28"><span class="linenos">28</span></a>
</span><span id="ConversationMemoryStore.__init__-29"><a href="#ConversationMemoryStore.__init__-29"><span class="linenos">29</span></a><span class="sd">        Args:</span>
</span><span id="ConversationMemoryStore.__init__-30"><a href="#ConversationMemoryStore.__init__-30"><span class="linenos">30</span></a><span class="sd">            db_path: Chemin vers la base de données SQLite</span>
</span><span id="ConversationMemoryStore.__init__-31"><a href="#ConversationMemoryStore.__init__-31"><span class="linenos">31</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.__init__-32"><a href="#ConversationMemoryStore.__init__-32"><span class="linenos">32</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
</span><span id="ConversationMemoryStore.__init__-33"><a href="#ConversationMemoryStore.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_database</span><span class="p">()</span>
</span><span id="ConversationMemoryStore.__init__-34"><a href="#ConversationMemoryStore.__init__-34"><span class="linenos">34</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ConversationMemoryStore initialisé: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialise le store SQLite</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>db_path:</strong>  Chemin vers la base de données SQLite</li>
</ul>
</div>


                            </div>
                            <div id="ConversationMemoryStore.db_path" class="classattr">
                                <div class="attr variable">
            <span class="name">db_path</span>

        
    </div>
    <a class="headerlink" href="#ConversationMemoryStore.db_path"></a>
    
    

                            </div>
                            <div id="ConversationMemoryStore.save_conversation" class="classattr">
                                        <input id="ConversationMemoryStore.save_conversation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_conversation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">username</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">email</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">question</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.save_conversation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.save_conversation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.save_conversation-133"><a href="#ConversationMemoryStore.save_conversation-133"><span class="linenos">133</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.save_conversation-134"><a href="#ConversationMemoryStore.save_conversation-134"><span class="linenos">134</span></a>                          <span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.save_conversation-135"><a href="#ConversationMemoryStore.save_conversation-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.save_conversation-136"><a href="#ConversationMemoryStore.save_conversation-136"><span class="linenos">136</span></a><span class="sd">        Enregistre une conversation dans la base de données. La fonction enregistre</span>
</span><span id="ConversationMemoryStore.save_conversation-137"><a href="#ConversationMemoryStore.save_conversation-137"><span class="linenos">137</span></a><span class="sd">        les informations fournies, telles que le nom d&#39;utilisateur, l&#39;adresse email,</span>
</span><span id="ConversationMemoryStore.save_conversation-138"><a href="#ConversationMemoryStore.save_conversation-138"><span class="linenos">138</span></a><span class="sd">        la question posée, la réponse donnée ainsi qu&#39;un éventuel identifiant de</span>
</span><span id="ConversationMemoryStore.save_conversation-139"><a href="#ConversationMemoryStore.save_conversation-139"><span class="linenos">139</span></a><span class="sd">        session. Le timestamp est automatiquement ajouté lors de l&#39;insertion.</span>
</span><span id="ConversationMemoryStore.save_conversation-140"><a href="#ConversationMemoryStore.save_conversation-140"><span class="linenos">140</span></a>
</span><span id="ConversationMemoryStore.save_conversation-141"><a href="#ConversationMemoryStore.save_conversation-141"><span class="linenos">141</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur qui a posé la question</span>
</span><span id="ConversationMemoryStore.save_conversation-142"><a href="#ConversationMemoryStore.save_conversation-142"><span class="linenos">142</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore.save_conversation-143"><a href="#ConversationMemoryStore.save_conversation-143"><span class="linenos">143</span></a><span class="sd">        :param email: L&#39;adresse email de l&#39;utilisateur</span>
</span><span id="ConversationMemoryStore.save_conversation-144"><a href="#ConversationMemoryStore.save_conversation-144"><span class="linenos">144</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore.save_conversation-145"><a href="#ConversationMemoryStore.save_conversation-145"><span class="linenos">145</span></a><span class="sd">        :param question: La question posée par l&#39;utilisateur</span>
</span><span id="ConversationMemoryStore.save_conversation-146"><a href="#ConversationMemoryStore.save_conversation-146"><span class="linenos">146</span></a><span class="sd">        :type question: str</span>
</span><span id="ConversationMemoryStore.save_conversation-147"><a href="#ConversationMemoryStore.save_conversation-147"><span class="linenos">147</span></a><span class="sd">        :param reponse: La réponse donnée à l&#39;utilisateur</span>
</span><span id="ConversationMemoryStore.save_conversation-148"><a href="#ConversationMemoryStore.save_conversation-148"><span class="linenos">148</span></a><span class="sd">        :type reponse: str</span>
</span><span id="ConversationMemoryStore.save_conversation-149"><a href="#ConversationMemoryStore.save_conversation-149"><span class="linenos">149</span></a><span class="sd">        :param session_id: L&#39;identifiant de session associé, optionnel</span>
</span><span id="ConversationMemoryStore.save_conversation-150"><a href="#ConversationMemoryStore.save_conversation-150"><span class="linenos">150</span></a><span class="sd">        :type session_id: str, optional</span>
</span><span id="ConversationMemoryStore.save_conversation-151"><a href="#ConversationMemoryStore.save_conversation-151"><span class="linenos">151</span></a><span class="sd">        :return: Retourne True si la conversation a été enregistrée avec succès,</span>
</span><span id="ConversationMemoryStore.save_conversation-152"><a href="#ConversationMemoryStore.save_conversation-152"><span class="linenos">152</span></a><span class="sd">                 False en cas d&#39;échec</span>
</span><span id="ConversationMemoryStore.save_conversation-153"><a href="#ConversationMemoryStore.save_conversation-153"><span class="linenos">153</span></a><span class="sd">        :rtype: bool</span>
</span><span id="ConversationMemoryStore.save_conversation-154"><a href="#ConversationMemoryStore.save_conversation-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.save_conversation-155"><a href="#ConversationMemoryStore.save_conversation-155"><span class="linenos">155</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.save_conversation-156"><a href="#ConversationMemoryStore.save_conversation-156"><span class="linenos">156</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.save_conversation-157"><a href="#ConversationMemoryStore.save_conversation-157"><span class="linenos">157</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.save_conversation-158"><a href="#ConversationMemoryStore.save_conversation-158"><span class="linenos">158</span></a><span class="s2">                             INSERT INTO conversations</span>
</span><span id="ConversationMemoryStore.save_conversation-159"><a href="#ConversationMemoryStore.save_conversation-159"><span class="linenos">159</span></a><span class="s2">                                 (username, email, question, reponse, timestamp, session_id)</span>
</span><span id="ConversationMemoryStore.save_conversation-160"><a href="#ConversationMemoryStore.save_conversation-160"><span class="linenos">160</span></a><span class="s2">                             VALUES (?, ?, ?, ?, ?, ?)</span>
</span><span id="ConversationMemoryStore.save_conversation-161"><a href="#ConversationMemoryStore.save_conversation-161"><span class="linenos">161</span></a><span class="s2">                             &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ConversationMemoryStore.save_conversation-162"><a href="#ConversationMemoryStore.save_conversation-162"><span class="linenos">162</span></a>                                 <span class="n">username</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.save_conversation-163"><a href="#ConversationMemoryStore.save_conversation-163"><span class="linenos">163</span></a>                                 <span class="n">email</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.save_conversation-164"><a href="#ConversationMemoryStore.save_conversation-164"><span class="linenos">164</span></a>                                 <span class="n">question</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.save_conversation-165"><a href="#ConversationMemoryStore.save_conversation-165"><span class="linenos">165</span></a>                                 <span class="n">reponse</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.save_conversation-166"><a href="#ConversationMemoryStore.save_conversation-166"><span class="linenos">166</span></a>                                 <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="ConversationMemoryStore.save_conversation-167"><a href="#ConversationMemoryStore.save_conversation-167"><span class="linenos">167</span></a>                                 <span class="n">session_id</span>
</span><span id="ConversationMemoryStore.save_conversation-168"><a href="#ConversationMemoryStore.save_conversation-168"><span class="linenos">168</span></a>                             <span class="p">))</span>
</span><span id="ConversationMemoryStore.save_conversation-169"><a href="#ConversationMemoryStore.save_conversation-169"><span class="linenos">169</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore.save_conversation-170"><a href="#ConversationMemoryStore.save_conversation-170"><span class="linenos">170</span></a>
</span><span id="ConversationMemoryStore.save_conversation-171"><a href="#ConversationMemoryStore.save_conversation-171"><span class="linenos">171</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Conversation sauvegardée: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.save_conversation-172"><a href="#ConversationMemoryStore.save_conversation-172"><span class="linenos">172</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="ConversationMemoryStore.save_conversation-173"><a href="#ConversationMemoryStore.save_conversation-173"><span class="linenos">173</span></a>
</span><span id="ConversationMemoryStore.save_conversation-174"><a href="#ConversationMemoryStore.save_conversation-174"><span class="linenos">174</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.save_conversation-175"><a href="#ConversationMemoryStore.save_conversation-175"><span class="linenos">175</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur sauvegarde conversation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.save_conversation-176"><a href="#ConversationMemoryStore.save_conversation-176"><span class="linenos">176</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Enregistre une conversation dans la base de données. La fonction enregistre
les informations fournies, telles que le nom d'utilisateur, l'adresse email,
la question posée, la réponse donnée ainsi qu'un éventuel identifiant de
session. Le timestamp est automatiquement ajouté lors de l'insertion.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur qui a posé la question</li>
<li><strong>email</strong>:  L'adresse email de l'utilisateur</li>
<li><strong>question</strong>:  La question posée par l'utilisateur</li>
<li><strong>reponse</strong>:  La réponse donnée à l'utilisateur</li>
<li><strong>session_id</strong>:  L'identifiant de session associé, optionnel</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Retourne True si la conversation a été enregistrée avec succès,
           False en cas d'échec</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.get_user_history_24h" class="classattr">
                                        <input id="ConversationMemoryStore.get_user_history_24h-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_history_24h</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.get_user_history_24h-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.get_user_history_24h"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.get_user_history_24h-178"><a href="#ConversationMemoryStore.get_user_history_24h-178"><span class="linenos">178</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_history_24h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-179"><a href="#ConversationMemoryStore.get_user_history_24h-179"><span class="linenos">179</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-180"><a href="#ConversationMemoryStore.get_user_history_24h-180"><span class="linenos">180</span></a><span class="sd">        Récupère l&#39;historique des conversations de l&#39;utilisateur spécifié au cours des</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-181"><a href="#ConversationMemoryStore.get_user_history_24h-181"><span class="linenos">181</span></a><span class="sd">        dernières 24 heures. Les conversations sont triées par ordre décroissant de</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-182"><a href="#ConversationMemoryStore.get_user_history_24h-182"><span class="linenos">182</span></a><span class="sd">        timestamp.</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-183"><a href="#ConversationMemoryStore.get_user_history_24h-183"><span class="linenos">183</span></a>
</span><span id="ConversationMemoryStore.get_user_history_24h-184"><a href="#ConversationMemoryStore.get_user_history_24h-184"><span class="linenos">184</span></a><span class="sd">        L&#39;historique est limité par un nombre spécifié.</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-185"><a href="#ConversationMemoryStore.get_user_history_24h-185"><span class="linenos">185</span></a>
</span><span id="ConversationMemoryStore.get_user_history_24h-186"><a href="#ConversationMemoryStore.get_user_history_24h-186"><span class="linenos">186</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur de l&#39;utilisateur pour lequel récupérer</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-187"><a href="#ConversationMemoryStore.get_user_history_24h-187"><span class="linenos">187</span></a><span class="sd">            l&#39;historique des conversations.</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-188"><a href="#ConversationMemoryStore.get_user_history_24h-188"><span class="linenos">188</span></a><span class="sd">        :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-189"><a href="#ConversationMemoryStore.get_user_history_24h-189"><span class="linenos">189</span></a><span class="sd">        :param limit: (optionnel) Le nombre maximum de conversations à récupérer. La</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-190"><a href="#ConversationMemoryStore.get_user_history_24h-190"><span class="linenos">190</span></a><span class="sd">            valeur par défaut est 20.</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-191"><a href="#ConversationMemoryStore.get_user_history_24h-191"><span class="linenos">191</span></a><span class="sd">        :return: Une liste de dictionnaires contenant les informations des conversations</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-192"><a href="#ConversationMemoryStore.get_user_history_24h-192"><span class="linenos">192</span></a><span class="sd">            récupérées. Chaque dictionnaire inclut les clés suivantes : &#39;question&#39;,</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-193"><a href="#ConversationMemoryStore.get_user_history_24h-193"><span class="linenos">193</span></a><span class="sd">            &#39;reponse&#39;, &#39;timestamp&#39;, et &#39;session_id&#39;.</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-194"><a href="#ConversationMemoryStore.get_user_history_24h-194"><span class="linenos">194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-195"><a href="#ConversationMemoryStore.get_user_history_24h-195"><span class="linenos">195</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-196"><a href="#ConversationMemoryStore.get_user_history_24h-196"><span class="linenos">196</span></a>            <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-197"><a href="#ConversationMemoryStore.get_user_history_24h-197"><span class="linenos">197</span></a>
</span><span id="ConversationMemoryStore.get_user_history_24h-198"><a href="#ConversationMemoryStore.get_user_history_24h-198"><span class="linenos">198</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-199"><a href="#ConversationMemoryStore.get_user_history_24h-199"><span class="linenos">199</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-200"><a href="#ConversationMemoryStore.get_user_history_24h-200"><span class="linenos">200</span></a><span class="s2">                                      SELECT question, reponse, timestamp, session_id</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-201"><a href="#ConversationMemoryStore.get_user_history_24h-201"><span class="linenos">201</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-202"><a href="#ConversationMemoryStore.get_user_history_24h-202"><span class="linenos">202</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-203"><a href="#ConversationMemoryStore.get_user_history_24h-203"><span class="linenos">203</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-204"><a href="#ConversationMemoryStore.get_user_history_24h-204"><span class="linenos">204</span></a><span class="s2">                                        AND timestamp &gt;= ?</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-205"><a href="#ConversationMemoryStore.get_user_history_24h-205"><span class="linenos">205</span></a><span class="s2">                                      ORDER BY timestamp DESC</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-206"><a href="#ConversationMemoryStore.get_user_history_24h-206"><span class="linenos">206</span></a><span class="s2">                                          LIMIT ?</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-207"><a href="#ConversationMemoryStore.get_user_history_24h-207"><span class="linenos">207</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-208"><a href="#ConversationMemoryStore.get_user_history_24h-208"><span class="linenos">208</span></a>
</span><span id="ConversationMemoryStore.get_user_history_24h-209"><a href="#ConversationMemoryStore.get_user_history_24h-209"><span class="linenos">209</span></a>                <span class="n">conversations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-210"><a href="#ConversationMemoryStore.get_user_history_24h-210"><span class="linenos">210</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-211"><a href="#ConversationMemoryStore.get_user_history_24h-211"><span class="linenos">211</span></a>                    <span class="n">conversations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-212"><a href="#ConversationMemoryStore.get_user_history_24h-212"><span class="linenos">212</span></a>                        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-213"><a href="#ConversationMemoryStore.get_user_history_24h-213"><span class="linenos">213</span></a>                        <span class="s1">&#39;reponse&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-214"><a href="#ConversationMemoryStore.get_user_history_24h-214"><span class="linenos">214</span></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-215"><a href="#ConversationMemoryStore.get_user_history_24h-215"><span class="linenos">215</span></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-216"><a href="#ConversationMemoryStore.get_user_history_24h-216"><span class="linenos">216</span></a>                    <span class="p">})</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-217"><a href="#ConversationMemoryStore.get_user_history_24h-217"><span class="linenos">217</span></a>
</span><span id="ConversationMemoryStore.get_user_history_24h-218"><a href="#ConversationMemoryStore.get_user_history_24h-218"><span class="linenos">218</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Historique récupéré: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conversations</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversations pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-219"><a href="#ConversationMemoryStore.get_user_history_24h-219"><span class="linenos">219</span></a>            <span class="k">return</span> <span class="n">conversations</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-220"><a href="#ConversationMemoryStore.get_user_history_24h-220"><span class="linenos">220</span></a>
</span><span id="ConversationMemoryStore.get_user_history_24h-221"><a href="#ConversationMemoryStore.get_user_history_24h-221"><span class="linenos">221</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-222"><a href="#ConversationMemoryStore.get_user_history_24h-222"><span class="linenos">222</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur récupération historique: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_user_history_24h-223"><a href="#ConversationMemoryStore.get_user_history_24h-223"><span class="linenos">223</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Récupère l'historique des conversations de l'utilisateur spécifié au cours des
dernières 24 heures. Les conversations sont triées par ordre décroissant de
timestamp.</p>

<p>L'historique est limité par un nombre spécifié.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur de l'utilisateur pour lequel récupérer
l'historique des conversations.</li>
<li><strong>email</strong>:  L'adresse email associée à l'utilisateur.</li>
<li><strong>limit</strong>:  (optionnel) Le nombre maximum de conversations à récupérer. La
valeur par défaut est 20.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Une liste de dictionnaires contenant les informations des conversations
      récupérées. Chaque dictionnaire inclut les clés suivantes : 'question',
      'reponse', 'timestamp', et 'session_id'.</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.format_history_for_context" class="classattr">
                                        <input id="ConversationMemoryStore.format_history_for_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">format_history_for_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">max_conversations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.format_history_for_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.format_history_for_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.format_history_for_context-225"><a href="#ConversationMemoryStore.format_history_for_context-225"><span class="linenos">225</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_history_for_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_conversations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.format_history_for_context-226"><a href="#ConversationMemoryStore.format_history_for_context-226"><span class="linenos">226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-227"><a href="#ConversationMemoryStore.format_history_for_context-227"><span class="linenos">227</span></a><span class="sd">        Formate l&#39;historique des conversations pour un contexte spécifique en affichant les détails des</span>
</span><span id="ConversationMemoryStore.format_history_for_context-228"><a href="#ConversationMemoryStore.format_history_for_context-228"><span class="linenos">228</span></a><span class="sd">        conversations d&#39;un utilisateur au cours des dernières 24 heures.</span>
</span><span id="ConversationMemoryStore.format_history_for_context-229"><a href="#ConversationMemoryStore.format_history_for_context-229"><span class="linenos">229</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-230"><a href="#ConversationMemoryStore.format_history_for_context-230"><span class="linenos">230</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel extraire l&#39;historique des conversations.</span>
</span><span id="ConversationMemoryStore.format_history_for_context-231"><a href="#ConversationMemoryStore.format_history_for_context-231"><span class="linenos">231</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore.format_history_for_context-232"><a href="#ConversationMemoryStore.format_history_for_context-232"><span class="linenos">232</span></a><span class="sd">        :param email: L&#39;email de l&#39;utilisateur correspondant au nom d&#39;utilisateur donné.</span>
</span><span id="ConversationMemoryStore.format_history_for_context-233"><a href="#ConversationMemoryStore.format_history_for_context-233"><span class="linenos">233</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore.format_history_for_context-234"><a href="#ConversationMemoryStore.format_history_for_context-234"><span class="linenos">234</span></a><span class="sd">        :param max_conversations: Le nombre maximum de conversations à inclure dans le contexte.</span>
</span><span id="ConversationMemoryStore.format_history_for_context-235"><a href="#ConversationMemoryStore.format_history_for_context-235"><span class="linenos">235</span></a><span class="sd">            Par défaut, 5.</span>
</span><span id="ConversationMemoryStore.format_history_for_context-236"><a href="#ConversationMemoryStore.format_history_for_context-236"><span class="linenos">236</span></a><span class="sd">        :type max_conversations: int</span>
</span><span id="ConversationMemoryStore.format_history_for_context-237"><a href="#ConversationMemoryStore.format_history_for_context-237"><span class="linenos">237</span></a><span class="sd">        :return: Une chaîne de caractères formatée contenant l&#39;historique des conversations, ou</span>
</span><span id="ConversationMemoryStore.format_history_for_context-238"><a href="#ConversationMemoryStore.format_history_for_context-238"><span class="linenos">238</span></a><span class="sd">            un message indiquant l&#39;absence d&#39;historique.</span>
</span><span id="ConversationMemoryStore.format_history_for_context-239"><a href="#ConversationMemoryStore.format_history_for_context-239"><span class="linenos">239</span></a><span class="sd">        :rtype: str</span>
</span><span id="ConversationMemoryStore.format_history_for_context-240"><a href="#ConversationMemoryStore.format_history_for_context-240"><span class="linenos">240</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-241"><a href="#ConversationMemoryStore.format_history_for_context-241"><span class="linenos">241</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_history_24h</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">max_conversations</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.format_history_for_context-242"><a href="#ConversationMemoryStore.format_history_for_context-242"><span class="linenos">242</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-243"><a href="#ConversationMemoryStore.format_history_for_context-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.format_history_for_context-244"><a href="#ConversationMemoryStore.format_history_for_context-244"><span class="linenos">244</span></a>            <span class="k">return</span> <span class="s2">&quot;HISTORIQUE: Aucune conversation précédente dans les 24h.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-245"><a href="#ConversationMemoryStore.format_history_for_context-245"><span class="linenos">245</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-246"><a href="#ConversationMemoryStore.format_history_for_context-246"><span class="linenos">246</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HISTORIQUE DES CONVERSATIONS (24h) - Utilisateur: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-247"><a href="#ConversationMemoryStore.format_history_for_context-247"><span class="linenos">247</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-248"><a href="#ConversationMemoryStore.format_history_for_context-248"><span class="linenos">248</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-249"><a href="#ConversationMemoryStore.format_history_for_context-249"><span class="linenos">249</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="ConversationMemoryStore.format_history_for_context-250"><a href="#ConversationMemoryStore.format_history_for_context-250"><span class="linenos">250</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.format_history_for_context-251"><a href="#ConversationMemoryStore.format_history_for_context-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ConversationMemoryStore.format_history_for_context-252"><a href="#ConversationMemoryStore.format_history_for_context-252"><span class="linenos">252</span></a>                <span class="c1"># Parse si c&#39;est une string</span>
</span><span id="ConversationMemoryStore.format_history_for_context-253"><a href="#ConversationMemoryStore.format_history_for_context-253"><span class="linenos">253</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.format_history_for_context-254"><a href="#ConversationMemoryStore.format_history_for_context-254"><span class="linenos">254</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.format_history_for_context-255"><a href="#ConversationMemoryStore.format_history_for_context-255"><span class="linenos">255</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.format_history_for_context-256"><a href="#ConversationMemoryStore.format_history_for_context-256"><span class="linenos">256</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-257"><a href="#ConversationMemoryStore.format_history_for_context-257"><span class="linenos">257</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-258"><a href="#ConversationMemoryStore.format_history_for_context-258"><span class="linenos">258</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CONVERSATION </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] - </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-259"><a href="#ConversationMemoryStore.format_history_for_context-259"><span class="linenos">259</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Q: </span><span class="si">{</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-260"><a href="#ConversationMemoryStore.format_history_for_context-260"><span class="linenos">260</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;R: </span><span class="si">{</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-261"><a href="#ConversationMemoryStore.format_history_for_context-261"><span class="linenos">261</span></a>            <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-262"><a href="#ConversationMemoryStore.format_history_for_context-262"><span class="linenos">262</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-263"><a href="#ConversationMemoryStore.format_history_for_context-263"><span class="linenos">263</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> conversation(s) récente(s)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-264"><a href="#ConversationMemoryStore.format_history_for_context-264"><span class="linenos">264</span></a>        <span class="n">context</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="ConversationMemoryStore.format_history_for_context-265"><a href="#ConversationMemoryStore.format_history_for_context-265"><span class="linenos">265</span></a>
</span><span id="ConversationMemoryStore.format_history_for_context-266"><a href="#ConversationMemoryStore.format_history_for_context-266"><span class="linenos">266</span></a>        <span class="k">return</span> <span class="n">context</span>
</span></pre></div>


            <div class="docstring"><p>Formate l'historique des conversations pour un contexte spécifique en affichant les détails des
conversations d'un utilisateur au cours des dernières 24 heures.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur pour lequel extraire l'historique des conversations.</li>
<li><strong>email</strong>:  L'email de l'utilisateur correspondant au nom d'utilisateur donné.</li>
<li><strong>max_conversations</strong>:  Le nombre maximum de conversations à inclure dans le contexte.
Par défaut, 5.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Une chaîne de caractères formatée contenant l'historique des conversations, ou
      un message indiquant l'absence d'historique.</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.get_conversation_stats" class="classattr">
                                        <input id="ConversationMemoryStore.get_conversation_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_conversation_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.get_conversation_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.get_conversation_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.get_conversation_stats-268"><a href="#ConversationMemoryStore.get_conversation_stats-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-269"><a href="#ConversationMemoryStore.get_conversation_stats-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-270"><a href="#ConversationMemoryStore.get_conversation_stats-270"><span class="linenos">270</span></a><span class="sd">        Récupère les statistiques liées aux conversations d&#39;un utilisateur, y compris le total des conversations,</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-271"><a href="#ConversationMemoryStore.get_conversation_stats-271"><span class="linenos">271</span></a><span class="sd">        le nombre de conversations dans les dernières 24 heures et les détails de la dernière conversation.</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-272"><a href="#ConversationMemoryStore.get_conversation_stats-272"><span class="linenos">272</span></a>
</span><span id="ConversationMemoryStore.get_conversation_stats-273"><a href="#ConversationMemoryStore.get_conversation_stats-273"><span class="linenos">273</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel rechercher les statistiques</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-274"><a href="#ConversationMemoryStore.get_conversation_stats-274"><span class="linenos">274</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-275"><a href="#ConversationMemoryStore.get_conversation_stats-275"><span class="linenos">275</span></a><span class="sd">        :param email: L&#39;adresse email de l&#39;utilisateur pour lequel rechercher les statistiques</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-276"><a href="#ConversationMemoryStore.get_conversation_stats-276"><span class="linenos">276</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-277"><a href="#ConversationMemoryStore.get_conversation_stats-277"><span class="linenos">277</span></a><span class="sd">        :return: Un dictionnaire contenant les statistiques suivantes :</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-278"><a href="#ConversationMemoryStore.get_conversation_stats-278"><span class="linenos">278</span></a><span class="sd">                 - &#39;total_conversations&#39;: nombre total de conversations</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-279"><a href="#ConversationMemoryStore.get_conversation_stats-279"><span class="linenos">279</span></a><span class="sd">                 - &#39;conversations_24h&#39;: nombre de conversations dans les 24 dernières heures</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-280"><a href="#ConversationMemoryStore.get_conversation_stats-280"><span class="linenos">280</span></a><span class="sd">                 - &#39;last_conversation&#39;: détails de la dernière conversation incluant &#39;timestamp&#39; et &#39;question&#39;</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-281"><a href="#ConversationMemoryStore.get_conversation_stats-281"><span class="linenos">281</span></a><span class="sd">        :rtype: Dict</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-282"><a href="#ConversationMemoryStore.get_conversation_stats-282"><span class="linenos">282</span></a><span class="sd">        :raises Exception: En cas d&#39;erreur lors de l&#39;exécution des requêtes ou de la connexion à la base de données</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-283"><a href="#ConversationMemoryStore.get_conversation_stats-283"><span class="linenos">283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-284"><a href="#ConversationMemoryStore.get_conversation_stats-284"><span class="linenos">284</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-285"><a href="#ConversationMemoryStore.get_conversation_stats-285"><span class="linenos">285</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-286"><a href="#ConversationMemoryStore.get_conversation_stats-286"><span class="linenos">286</span></a>                <span class="c1"># Total conversations</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-287"><a href="#ConversationMemoryStore.get_conversation_stats-287"><span class="linenos">287</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-288"><a href="#ConversationMemoryStore.get_conversation_stats-288"><span class="linenos">288</span></a><span class="s2">                                      SELECT COUNT(*) as total</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-289"><a href="#ConversationMemoryStore.get_conversation_stats-289"><span class="linenos">289</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-290"><a href="#ConversationMemoryStore.get_conversation_stats-290"><span class="linenos">290</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-291"><a href="#ConversationMemoryStore.get_conversation_stats-291"><span class="linenos">291</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-292"><a href="#ConversationMemoryStore.get_conversation_stats-292"><span class="linenos">292</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-293"><a href="#ConversationMemoryStore.get_conversation_stats-293"><span class="linenos">293</span></a>                <span class="n">total</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-294"><a href="#ConversationMemoryStore.get_conversation_stats-294"><span class="linenos">294</span></a>
</span><span id="ConversationMemoryStore.get_conversation_stats-295"><a href="#ConversationMemoryStore.get_conversation_stats-295"><span class="linenos">295</span></a>                <span class="c1"># Conversations 24h</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-296"><a href="#ConversationMemoryStore.get_conversation_stats-296"><span class="linenos">296</span></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-297"><a href="#ConversationMemoryStore.get_conversation_stats-297"><span class="linenos">297</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-298"><a href="#ConversationMemoryStore.get_conversation_stats-298"><span class="linenos">298</span></a><span class="s2">                                      SELECT COUNT(*) as recent</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-299"><a href="#ConversationMemoryStore.get_conversation_stats-299"><span class="linenos">299</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-300"><a href="#ConversationMemoryStore.get_conversation_stats-300"><span class="linenos">300</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-301"><a href="#ConversationMemoryStore.get_conversation_stats-301"><span class="linenos">301</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-302"><a href="#ConversationMemoryStore.get_conversation_stats-302"><span class="linenos">302</span></a><span class="s2">                                        AND timestamp &gt;= ?</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-303"><a href="#ConversationMemoryStore.get_conversation_stats-303"><span class="linenos">303</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-304"><a href="#ConversationMemoryStore.get_conversation_stats-304"><span class="linenos">304</span></a>                <span class="n">recent</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;recent&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-305"><a href="#ConversationMemoryStore.get_conversation_stats-305"><span class="linenos">305</span></a>
</span><span id="ConversationMemoryStore.get_conversation_stats-306"><a href="#ConversationMemoryStore.get_conversation_stats-306"><span class="linenos">306</span></a>                <span class="c1"># Dernière conversation</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-307"><a href="#ConversationMemoryStore.get_conversation_stats-307"><span class="linenos">307</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-308"><a href="#ConversationMemoryStore.get_conversation_stats-308"><span class="linenos">308</span></a><span class="s2">                                      SELECT timestamp, question</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-309"><a href="#ConversationMemoryStore.get_conversation_stats-309"><span class="linenos">309</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-310"><a href="#ConversationMemoryStore.get_conversation_stats-310"><span class="linenos">310</span></a><span class="s2">                                      WHERE username = ? AND email = ?</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-311"><a href="#ConversationMemoryStore.get_conversation_stats-311"><span class="linenos">311</span></a><span class="s2">                                      ORDER BY timestamp DESC LIMIT 1</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-312"><a href="#ConversationMemoryStore.get_conversation_stats-312"><span class="linenos">312</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-313"><a href="#ConversationMemoryStore.get_conversation_stats-313"><span class="linenos">313</span></a>                <span class="n">last_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-314"><a href="#ConversationMemoryStore.get_conversation_stats-314"><span class="linenos">314</span></a>                <span class="n">last_conversation</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-315"><a href="#ConversationMemoryStore.get_conversation_stats-315"><span class="linenos">315</span></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-316"><a href="#ConversationMemoryStore.get_conversation_stats-316"><span class="linenos">316</span></a>                    <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-317"><a href="#ConversationMemoryStore.get_conversation_stats-317"><span class="linenos">317</span></a>                <span class="p">}</span> <span class="k">if</span> <span class="n">last_row</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-318"><a href="#ConversationMemoryStore.get_conversation_stats-318"><span class="linenos">318</span></a>
</span><span id="ConversationMemoryStore.get_conversation_stats-319"><a href="#ConversationMemoryStore.get_conversation_stats-319"><span class="linenos">319</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-320"><a href="#ConversationMemoryStore.get_conversation_stats-320"><span class="linenos">320</span></a>                <span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-321"><a href="#ConversationMemoryStore.get_conversation_stats-321"><span class="linenos">321</span></a>                <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-322"><a href="#ConversationMemoryStore.get_conversation_stats-322"><span class="linenos">322</span></a>                <span class="s1">&#39;last_conversation&#39;</span><span class="p">:</span> <span class="n">last_conversation</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-323"><a href="#ConversationMemoryStore.get_conversation_stats-323"><span class="linenos">323</span></a>            <span class="p">}</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-324"><a href="#ConversationMemoryStore.get_conversation_stats-324"><span class="linenos">324</span></a>
</span><span id="ConversationMemoryStore.get_conversation_stats-325"><a href="#ConversationMemoryStore.get_conversation_stats-325"><span class="linenos">325</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-326"><a href="#ConversationMemoryStore.get_conversation_stats-326"><span class="linenos">326</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur statistiques: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_conversation_stats-327"><a href="#ConversationMemoryStore.get_conversation_stats-327"><span class="linenos">327</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;last_conversation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Récupère les statistiques liées aux conversations d'un utilisateur, y compris le total des conversations,
le nombre de conversations dans les dernières 24 heures et les détails de la dernière conversation.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur pour lequel rechercher les statistiques</li>
<li><strong>email</strong>:  L'adresse email de l'utilisateur pour lequel rechercher les statistiques</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Un dictionnaire contenant les statistiques suivantes :
           - 'total_conversations': nombre total de conversations
           - 'conversations_24h': nombre de conversations dans les 24 dernières heures
           - 'last_conversation': détails de la dernière conversation incluant 'timestamp' et 'question'</p>
</blockquote>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>Exception</strong>:  En cas d'erreur lors de l'exécution des requêtes ou de la connexion à la base de données</li>
</ul>
</div>


                            </div>
                            <div id="ConversationMemoryStore.cleanup_old_conversations" class="classattr">
                                        <input id="ConversationMemoryStore.cleanup_old_conversations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cleanup_old_conversations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">days_to_keep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.cleanup_old_conversations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.cleanup_old_conversations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.cleanup_old_conversations-329"><a href="#ConversationMemoryStore.cleanup_old_conversations-329"><span class="linenos">329</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_to_keep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-330"><a href="#ConversationMemoryStore.cleanup_old_conversations-330"><span class="linenos">330</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-331"><a href="#ConversationMemoryStore.cleanup_old_conversations-331"><span class="linenos">331</span></a><span class="sd">        Supprime les anciennes conversations de la base de données qui ont une date</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-332"><a href="#ConversationMemoryStore.cleanup_old_conversations-332"><span class="linenos">332</span></a><span class="sd">        antérieure à un nombre de jours spécifié (days_to_keep). Cette méthode effectue</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-333"><a href="#ConversationMemoryStore.cleanup_old_conversations-333"><span class="linenos">333</span></a><span class="sd">        un nettoyage des données en supprimant les enregistrements obsolètes d&#39;après</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-334"><a href="#ConversationMemoryStore.cleanup_old_conversations-334"><span class="linenos">334</span></a><span class="sd">        la date limite calculée.</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-335"><a href="#ConversationMemoryStore.cleanup_old_conversations-335"><span class="linenos">335</span></a>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-336"><a href="#ConversationMemoryStore.cleanup_old_conversations-336"><span class="linenos">336</span></a><span class="sd">        :param days_to_keep: Nombre de jours avant lesquels les conversations</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-337"><a href="#ConversationMemoryStore.cleanup_old_conversations-337"><span class="linenos">337</span></a><span class="sd">            doivent être supprimées (par défaut 30).</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-338"><a href="#ConversationMemoryStore.cleanup_old_conversations-338"><span class="linenos">338</span></a><span class="sd">        :type days_to_keep: int</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-339"><a href="#ConversationMemoryStore.cleanup_old_conversations-339"><span class="linenos">339</span></a><span class="sd">        :return: Le nombre de conversations supprimées.</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-340"><a href="#ConversationMemoryStore.cleanup_old_conversations-340"><span class="linenos">340</span></a><span class="sd">        :rtype: int</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-341"><a href="#ConversationMemoryStore.cleanup_old_conversations-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-342"><a href="#ConversationMemoryStore.cleanup_old_conversations-342"><span class="linenos">342</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-343"><a href="#ConversationMemoryStore.cleanup_old_conversations-343"><span class="linenos">343</span></a>            <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_to_keep</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-344"><a href="#ConversationMemoryStore.cleanup_old_conversations-344"><span class="linenos">344</span></a>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-345"><a href="#ConversationMemoryStore.cleanup_old_conversations-345"><span class="linenos">345</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-346"><a href="#ConversationMemoryStore.cleanup_old_conversations-346"><span class="linenos">346</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-347"><a href="#ConversationMemoryStore.cleanup_old_conversations-347"><span class="linenos">347</span></a><span class="s2">                                      DELETE</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-348"><a href="#ConversationMemoryStore.cleanup_old_conversations-348"><span class="linenos">348</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-349"><a href="#ConversationMemoryStore.cleanup_old_conversations-349"><span class="linenos">349</span></a><span class="s2">                                      WHERE timestamp &lt; ?</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-350"><a href="#ConversationMemoryStore.cleanup_old_conversations-350"><span class="linenos">350</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cutoff_date</span><span class="p">,))</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-351"><a href="#ConversationMemoryStore.cleanup_old_conversations-351"><span class="linenos">351</span></a>                <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-352"><a href="#ConversationMemoryStore.cleanup_old_conversations-352"><span class="linenos">352</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-353"><a href="#ConversationMemoryStore.cleanup_old_conversations-353"><span class="linenos">353</span></a>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-354"><a href="#ConversationMemoryStore.cleanup_old_conversations-354"><span class="linenos">354</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Nettoyage: </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> conversations supprimées (&gt; </span><span class="si">{</span><span class="n">days_to_keep</span><span class="si">}</span><span class="s2"> jours)&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-355"><a href="#ConversationMemoryStore.cleanup_old_conversations-355"><span class="linenos">355</span></a>            <span class="k">return</span> <span class="n">deleted_count</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-356"><a href="#ConversationMemoryStore.cleanup_old_conversations-356"><span class="linenos">356</span></a>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-357"><a href="#ConversationMemoryStore.cleanup_old_conversations-357"><span class="linenos">357</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-358"><a href="#ConversationMemoryStore.cleanup_old_conversations-358"><span class="linenos">358</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur nettoyage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.cleanup_old_conversations-359"><a href="#ConversationMemoryStore.cleanup_old_conversations-359"><span class="linenos">359</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Supprime les anciennes conversations de la base de données qui ont une date
antérieure à un nombre de jours spécifié (days_to_keep). Cette méthode effectue
un nettoyage des données en supprimant les enregistrements obsolètes d'après
la date limite calculée.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>days_to_keep</strong>:  Nombre de jours avant lesquels les conversations
doivent être supprimées (par défaut 30).</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Le nombre de conversations supprimées.</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.get_all_users" class="classattr">
                                        <input id="ConversationMemoryStore.get_all_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_all_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.get_all_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.get_all_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.get_all_users-361"><a href="#ConversationMemoryStore.get_all_users-361"><span class="linenos">361</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="ConversationMemoryStore.get_all_users-362"><a href="#ConversationMemoryStore.get_all_users-362"><span class="linenos">362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_all_users-363"><a href="#ConversationMemoryStore.get_all_users-363"><span class="linenos">363</span></a><span class="sd">        Récupère tous les utilisateurs distincts avec leurs noms d&#39;utilisateur et leurs</span>
</span><span id="ConversationMemoryStore.get_all_users-364"><a href="#ConversationMemoryStore.get_all_users-364"><span class="linenos">364</span></a><span class="sd">        adresses e-mail à partir de la base de données. Les utilisateurs sont renvoyés</span>
</span><span id="ConversationMemoryStore.get_all_users-365"><a href="#ConversationMemoryStore.get_all_users-365"><span class="linenos">365</span></a><span class="sd">        dans un ordre alphabétique basé sur leurs noms d&#39;utilisateur.</span>
</span><span id="ConversationMemoryStore.get_all_users-366"><a href="#ConversationMemoryStore.get_all_users-366"><span class="linenos">366</span></a>
</span><span id="ConversationMemoryStore.get_all_users-367"><a href="#ConversationMemoryStore.get_all_users-367"><span class="linenos">367</span></a><span class="sd">        :return: Une liste de tuples contenant les noms d&#39;utilisateur et adresses e-mail</span>
</span><span id="ConversationMemoryStore.get_all_users-368"><a href="#ConversationMemoryStore.get_all_users-368"><span class="linenos">368</span></a><span class="sd">                 de tous les utilisateurs distincts dans la base de données. Si une erreur</span>
</span><span id="ConversationMemoryStore.get_all_users-369"><a href="#ConversationMemoryStore.get_all_users-369"><span class="linenos">369</span></a><span class="sd">                 se produit, retourne une liste vide.</span>
</span><span id="ConversationMemoryStore.get_all_users-370"><a href="#ConversationMemoryStore.get_all_users-370"><span class="linenos">370</span></a><span class="sd">        :rtype: List[Tuple[str, str]]</span>
</span><span id="ConversationMemoryStore.get_all_users-371"><a href="#ConversationMemoryStore.get_all_users-371"><span class="linenos">371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_all_users-372"><a href="#ConversationMemoryStore.get_all_users-372"><span class="linenos">372</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_all_users-373"><a href="#ConversationMemoryStore.get_all_users-373"><span class="linenos">373</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_all_users-374"><a href="#ConversationMemoryStore.get_all_users-374"><span class="linenos">374</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.get_all_users-375"><a href="#ConversationMemoryStore.get_all_users-375"><span class="linenos">375</span></a><span class="s2">                                      SELECT DISTINCT username, email</span>
</span><span id="ConversationMemoryStore.get_all_users-376"><a href="#ConversationMemoryStore.get_all_users-376"><span class="linenos">376</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.get_all_users-377"><a href="#ConversationMemoryStore.get_all_users-377"><span class="linenos">377</span></a><span class="s2">                                      ORDER BY username</span>
</span><span id="ConversationMemoryStore.get_all_users-378"><a href="#ConversationMemoryStore.get_all_users-378"><span class="linenos">378</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_all_users-379"><a href="#ConversationMemoryStore.get_all_users-379"><span class="linenos">379</span></a>                <span class="k">return</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span><span id="ConversationMemoryStore.get_all_users-380"><a href="#ConversationMemoryStore.get_all_users-380"><span class="linenos">380</span></a>
</span><span id="ConversationMemoryStore.get_all_users-381"><a href="#ConversationMemoryStore.get_all_users-381"><span class="linenos">381</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.get_all_users-382"><a href="#ConversationMemoryStore.get_all_users-382"><span class="linenos">382</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur liste utilisateurs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.get_all_users-383"><a href="#ConversationMemoryStore.get_all_users-383"><span class="linenos">383</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Récupère tous les utilisateurs distincts avec leurs noms d'utilisateur et leurs
adresses e-mail à partir de la base de données. Les utilisateurs sont renvoyés
dans un ordre alphabétique basé sur leurs noms d'utilisateur.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Une liste de tuples contenant les noms d'utilisateur et adresses e-mail
           de tous les utilisateurs distincts dans la base de données. Si une erreur
           se produit, retourne une liste vide.</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.delete_user_conversations" class="classattr">
                                        <input id="ConversationMemoryStore.delete_user_conversations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_user_conversations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.delete_user_conversations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.delete_user_conversations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.delete_user_conversations-385"><a href="#ConversationMemoryStore.delete_user_conversations-385"><span class="linenos">385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-386"><a href="#ConversationMemoryStore.delete_user_conversations-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-387"><a href="#ConversationMemoryStore.delete_user_conversations-387"><span class="linenos">387</span></a><span class="sd">        Supprime les conversations associées à un utilisateur spécifique.</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-388"><a href="#ConversationMemoryStore.delete_user_conversations-388"><span class="linenos">388</span></a>
</span><span id="ConversationMemoryStore.delete_user_conversations-389"><a href="#ConversationMemoryStore.delete_user_conversations-389"><span class="linenos">389</span></a><span class="sd">        Cette méthode permet de supprimer toutes les conversations d&#39;un utilisateur donné</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-390"><a href="#ConversationMemoryStore.delete_user_conversations-390"><span class="linenos">390</span></a><span class="sd">        en fonction de son nom d&#39;utilisateur (username) et de son adresse e-mail.</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-391"><a href="#ConversationMemoryStore.delete_user_conversations-391"><span class="linenos">391</span></a>
</span><span id="ConversationMemoryStore.delete_user_conversations-392"><a href="#ConversationMemoryStore.delete_user_conversations-392"><span class="linenos">392</span></a><span class="sd">        :param username: Nom d&#39;utilisateur de l&#39;individu dont les conversations doivent</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-393"><a href="#ConversationMemoryStore.delete_user_conversations-393"><span class="linenos">393</span></a><span class="sd">            être supprimées.</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-394"><a href="#ConversationMemoryStore.delete_user_conversations-394"><span class="linenos">394</span></a><span class="sd">        :type username: str</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-395"><a href="#ConversationMemoryStore.delete_user_conversations-395"><span class="linenos">395</span></a><span class="sd">        :param email: Adresse e-mail de l&#39;utilisateur dont les conversations sont à</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-396"><a href="#ConversationMemoryStore.delete_user_conversations-396"><span class="linenos">396</span></a><span class="sd">            supprimer.</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-397"><a href="#ConversationMemoryStore.delete_user_conversations-397"><span class="linenos">397</span></a><span class="sd">        :type email: str</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-398"><a href="#ConversationMemoryStore.delete_user_conversations-398"><span class="linenos">398</span></a><span class="sd">        :return: Le nombre total de conversations supprimées avec succès pour cet</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-399"><a href="#ConversationMemoryStore.delete_user_conversations-399"><span class="linenos">399</span></a><span class="sd">            utilisateur. Retourne `0` en cas d&#39;échec ou si aucune conversation n&#39;a été</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-400"><a href="#ConversationMemoryStore.delete_user_conversations-400"><span class="linenos">400</span></a><span class="sd">            supprimée.</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-401"><a href="#ConversationMemoryStore.delete_user_conversations-401"><span class="linenos">401</span></a><span class="sd">        :rtype: int</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-402"><a href="#ConversationMemoryStore.delete_user_conversations-402"><span class="linenos">402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-403"><a href="#ConversationMemoryStore.delete_user_conversations-403"><span class="linenos">403</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-404"><a href="#ConversationMemoryStore.delete_user_conversations-404"><span class="linenos">404</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-405"><a href="#ConversationMemoryStore.delete_user_conversations-405"><span class="linenos">405</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-406"><a href="#ConversationMemoryStore.delete_user_conversations-406"><span class="linenos">406</span></a><span class="s2">                                      DELETE</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-407"><a href="#ConversationMemoryStore.delete_user_conversations-407"><span class="linenos">407</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-408"><a href="#ConversationMemoryStore.delete_user_conversations-408"><span class="linenos">408</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-409"><a href="#ConversationMemoryStore.delete_user_conversations-409"><span class="linenos">409</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-410"><a href="#ConversationMemoryStore.delete_user_conversations-410"><span class="linenos">410</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-411"><a href="#ConversationMemoryStore.delete_user_conversations-411"><span class="linenos">411</span></a>                <span class="n">deleted_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-412"><a href="#ConversationMemoryStore.delete_user_conversations-412"><span class="linenos">412</span></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-413"><a href="#ConversationMemoryStore.delete_user_conversations-413"><span class="linenos">413</span></a>
</span><span id="ConversationMemoryStore.delete_user_conversations-414"><a href="#ConversationMemoryStore.delete_user_conversations-414"><span class="linenos">414</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> conversations supprimées pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-415"><a href="#ConversationMemoryStore.delete_user_conversations-415"><span class="linenos">415</span></a>            <span class="k">return</span> <span class="n">deleted_count</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-416"><a href="#ConversationMemoryStore.delete_user_conversations-416"><span class="linenos">416</span></a>
</span><span id="ConversationMemoryStore.delete_user_conversations-417"><a href="#ConversationMemoryStore.delete_user_conversations-417"><span class="linenos">417</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-418"><a href="#ConversationMemoryStore.delete_user_conversations-418"><span class="linenos">418</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur suppression utilisateur: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.delete_user_conversations-419"><a href="#ConversationMemoryStore.delete_user_conversations-419"><span class="linenos">419</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Supprime les conversations associées à un utilisateur spécifique.</p>

<p>Cette méthode permet de supprimer toutes les conversations d'un utilisateur donné
en fonction de son nom d'utilisateur (username) et de son adresse e-mail.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Nom d'utilisateur de l'individu dont les conversations doivent
être supprimées.</li>
<li><strong>email</strong>:  Adresse e-mail de l'utilisateur dont les conversations sont à
supprimer.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Le nombre total de conversations supprimées avec succès pour cet
      utilisateur. Retourne <code>0</code> en cas d'échec ou si aucune conversation n'a été
      supprimée.</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.export_user_conversations" class="classattr">
                                        <input id="ConversationMemoryStore.export_user_conversations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_user_conversations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.export_user_conversations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.export_user_conversations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.export_user_conversations-421"><a href="#ConversationMemoryStore.export_user_conversations-421"><span class="linenos">421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_user_conversations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="ConversationMemoryStore.export_user_conversations-422"><a href="#ConversationMemoryStore.export_user_conversations-422"><span class="linenos">422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.export_user_conversations-423"><a href="#ConversationMemoryStore.export_user_conversations-423"><span class="linenos">423</span></a><span class="sd">        Exporte les conversations d&#39;un utilisateur à partir de la base de données en fonction de son</span>
</span><span id="ConversationMemoryStore.export_user_conversations-424"><a href="#ConversationMemoryStore.export_user_conversations-424"><span class="linenos">424</span></a><span class="sd">        nom d&#39;utilisateur et de son email. Les conversations sont triées par ordre décroissant de leur</span>
</span><span id="ConversationMemoryStore.export_user_conversations-425"><a href="#ConversationMemoryStore.export_user_conversations-425"><span class="linenos">425</span></a><span class="sd">        horodatage.</span>
</span><span id="ConversationMemoryStore.export_user_conversations-426"><a href="#ConversationMemoryStore.export_user_conversations-426"><span class="linenos">426</span></a>
</span><span id="ConversationMemoryStore.export_user_conversations-427"><a href="#ConversationMemoryStore.export_user_conversations-427"><span class="linenos">427</span></a><span class="sd">        Cette méthode effectue une requête SQL pour récupérer les conversations correspondantes dans la</span>
</span><span id="ConversationMemoryStore.export_user_conversations-428"><a href="#ConversationMemoryStore.export_user_conversations-428"><span class="linenos">428</span></a><span class="sd">        base de données, puis les formate sous forme de liste de dictionnaires, où chaque dictionnaire</span>
</span><span id="ConversationMemoryStore.export_user_conversations-429"><a href="#ConversationMemoryStore.export_user_conversations-429"><span class="linenos">429</span></a><span class="sd">        représente une conversation.</span>
</span><span id="ConversationMemoryStore.export_user_conversations-430"><a href="#ConversationMemoryStore.export_user_conversations-430"><span class="linenos">430</span></a>
</span><span id="ConversationMemoryStore.export_user_conversations-431"><a href="#ConversationMemoryStore.export_user_conversations-431"><span class="linenos">431</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour lequel les conversations doivent être exportées.</span>
</span><span id="ConversationMemoryStore.export_user_conversations-432"><a href="#ConversationMemoryStore.export_user_conversations-432"><span class="linenos">432</span></a><span class="sd">        :param email: L&#39;adresse e-mail associée à l&#39;utilisateur pour l&#39;extraction des conversations.</span>
</span><span id="ConversationMemoryStore.export_user_conversations-433"><a href="#ConversationMemoryStore.export_user_conversations-433"><span class="linenos">433</span></a><span class="sd">        :return: Une liste de dictionnaires représentant les conversations de l&#39;utilisateur, ou une</span>
</span><span id="ConversationMemoryStore.export_user_conversations-434"><a href="#ConversationMemoryStore.export_user_conversations-434"><span class="linenos">434</span></a><span class="sd">                 liste vide en cas d&#39;erreur.</span>
</span><span id="ConversationMemoryStore.export_user_conversations-435"><a href="#ConversationMemoryStore.export_user_conversations-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.export_user_conversations-436"><a href="#ConversationMemoryStore.export_user_conversations-436"><span class="linenos">436</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.export_user_conversations-437"><a href="#ConversationMemoryStore.export_user_conversations-437"><span class="linenos">437</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.export_user_conversations-438"><a href="#ConversationMemoryStore.export_user_conversations-438"><span class="linenos">438</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.export_user_conversations-439"><a href="#ConversationMemoryStore.export_user_conversations-439"><span class="linenos">439</span></a><span class="s2">                                      SELECT *</span>
</span><span id="ConversationMemoryStore.export_user_conversations-440"><a href="#ConversationMemoryStore.export_user_conversations-440"><span class="linenos">440</span></a><span class="s2">                                      FROM conversations</span>
</span><span id="ConversationMemoryStore.export_user_conversations-441"><a href="#ConversationMemoryStore.export_user_conversations-441"><span class="linenos">441</span></a><span class="s2">                                      WHERE username = ?</span>
</span><span id="ConversationMemoryStore.export_user_conversations-442"><a href="#ConversationMemoryStore.export_user_conversations-442"><span class="linenos">442</span></a><span class="s2">                                        AND email = ?</span>
</span><span id="ConversationMemoryStore.export_user_conversations-443"><a href="#ConversationMemoryStore.export_user_conversations-443"><span class="linenos">443</span></a><span class="s2">                                      ORDER BY timestamp DESC</span>
</span><span id="ConversationMemoryStore.export_user_conversations-444"><a href="#ConversationMemoryStore.export_user_conversations-444"><span class="linenos">444</span></a><span class="s2">                                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
</span><span id="ConversationMemoryStore.export_user_conversations-445"><a href="#ConversationMemoryStore.export_user_conversations-445"><span class="linenos">445</span></a>
</span><span id="ConversationMemoryStore.export_user_conversations-446"><a href="#ConversationMemoryStore.export_user_conversations-446"><span class="linenos">446</span></a>                <span class="n">conversations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ConversationMemoryStore.export_user_conversations-447"><a href="#ConversationMemoryStore.export_user_conversations-447"><span class="linenos">447</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span><span id="ConversationMemoryStore.export_user_conversations-448"><a href="#ConversationMemoryStore.export_user_conversations-448"><span class="linenos">448</span></a>                    <span class="n">conversations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="ConversationMemoryStore.export_user_conversations-449"><a href="#ConversationMemoryStore.export_user_conversations-449"><span class="linenos">449</span></a>                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-450"><a href="#ConversationMemoryStore.export_user_conversations-450"><span class="linenos">450</span></a>                        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-451"><a href="#ConversationMemoryStore.export_user_conversations-451"><span class="linenos">451</span></a>                        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-452"><a href="#ConversationMemoryStore.export_user_conversations-452"><span class="linenos">452</span></a>                        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-453"><a href="#ConversationMemoryStore.export_user_conversations-453"><span class="linenos">453</span></a>                        <span class="s1">&#39;reponse&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reponse&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-454"><a href="#ConversationMemoryStore.export_user_conversations-454"><span class="linenos">454</span></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-455"><a href="#ConversationMemoryStore.export_user_conversations-455"><span class="linenos">455</span></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">],</span>
</span><span id="ConversationMemoryStore.export_user_conversations-456"><a href="#ConversationMemoryStore.export_user_conversations-456"><span class="linenos">456</span></a>                        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.export_user_conversations-457"><a href="#ConversationMemoryStore.export_user_conversations-457"><span class="linenos">457</span></a>                    <span class="p">})</span>
</span><span id="ConversationMemoryStore.export_user_conversations-458"><a href="#ConversationMemoryStore.export_user_conversations-458"><span class="linenos">458</span></a>
</span><span id="ConversationMemoryStore.export_user_conversations-459"><a href="#ConversationMemoryStore.export_user_conversations-459"><span class="linenos">459</span></a>            <span class="k">return</span> <span class="n">conversations</span>
</span><span id="ConversationMemoryStore.export_user_conversations-460"><a href="#ConversationMemoryStore.export_user_conversations-460"><span class="linenos">460</span></a>
</span><span id="ConversationMemoryStore.export_user_conversations-461"><a href="#ConversationMemoryStore.export_user_conversations-461"><span class="linenos">461</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.export_user_conversations-462"><a href="#ConversationMemoryStore.export_user_conversations-462"><span class="linenos">462</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur export: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.export_user_conversations-463"><a href="#ConversationMemoryStore.export_user_conversations-463"><span class="linenos">463</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Exporte les conversations d'un utilisateur à partir de la base de données en fonction de son
nom d'utilisateur et de son email. Les conversations sont triées par ordre décroissant de leur
horodatage.</p>

<p>Cette méthode effectue une requête SQL pour récupérer les conversations correspondantes dans la
base de données, puis les formate sous forme de liste de dictionnaires, où chaque dictionnaire
représente une conversation.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur pour lequel les conversations doivent être exportées.</li>
<li><strong>email</strong>:  L'adresse e-mail associée à l'utilisateur pour l'extraction des conversations.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Une liste de dictionnaires représentant les conversations de l'utilisateur, ou une
           liste vide en cas d'erreur.</p>
</blockquote>
</div>


                            </div>
                            <div id="ConversationMemoryStore.check_database_health" class="classattr">
                                        <input id="ConversationMemoryStore.check_database_health-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_database_health</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="ConversationMemoryStore.check_database_health-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConversationMemoryStore.check_database_health"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConversationMemoryStore.check_database_health-465"><a href="#ConversationMemoryStore.check_database_health-465"><span class="linenos">465</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_database_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.check_database_health-466"><a href="#ConversationMemoryStore.check_database_health-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.check_database_health-467"><a href="#ConversationMemoryStore.check_database_health-467"><span class="linenos">467</span></a><span class="sd">        Vérifie l&#39;état de santé de la base de données et retourne des statistiques détaillées sur son utilisation. Cette</span>
</span><span id="ConversationMemoryStore.check_database_health-468"><a href="#ConversationMemoryStore.check_database_health-468"><span class="linenos">468</span></a><span class="sd">        fonction évalue la taille de la base, le nombre total de conversations stockées, les utilisateurs uniques,</span>
</span><span id="ConversationMemoryStore.check_database_health-469"><a href="#ConversationMemoryStore.check_database_health-469"><span class="linenos">469</span></a><span class="sd">        ainsi que le nombre de conversations enregistrées durant les dernières 24 heures.</span>
</span><span id="ConversationMemoryStore.check_database_health-470"><a href="#ConversationMemoryStore.check_database_health-470"><span class="linenos">470</span></a>
</span><span id="ConversationMemoryStore.check_database_health-471"><a href="#ConversationMemoryStore.check_database_health-471"><span class="linenos">471</span></a><span class="sd">        :return: Un dictionnaire contenant des informations sur la santé de la base de données, y compris</span>
</span><span id="ConversationMemoryStore.check_database_health-472"><a href="#ConversationMemoryStore.check_database_health-472"><span class="linenos">472</span></a><span class="sd">            le chemin absolu de la base, sa taille en octets et mégaoctets, le nombre total de conversations</span>
</span><span id="ConversationMemoryStore.check_database_health-473"><a href="#ConversationMemoryStore.check_database_health-473"><span class="linenos">473</span></a><span class="sd">            enregistrées, le total d&#39;utilisateurs uniques et le nombre de conversations dans les dernières 24 heures.</span>
</span><span id="ConversationMemoryStore.check_database_health-474"><a href="#ConversationMemoryStore.check_database_health-474"><span class="linenos">474</span></a><span class="sd">            Si une erreur survient lors du diagnostic, elle inclut l&#39;erreur et marque l&#39;état de la base comme</span>
</span><span id="ConversationMemoryStore.check_database_health-475"><a href="#ConversationMemoryStore.check_database_health-475"><span class="linenos">475</span></a><span class="sd">            « error ».</span>
</span><span id="ConversationMemoryStore.check_database_health-476"><a href="#ConversationMemoryStore.check_database_health-476"><span class="linenos">476</span></a><span class="sd">        :rtype: Dict</span>
</span><span id="ConversationMemoryStore.check_database_health-477"><a href="#ConversationMemoryStore.check_database_health-477"><span class="linenos">477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConversationMemoryStore.check_database_health-478"><a href="#ConversationMemoryStore.check_database_health-478"><span class="linenos">478</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.check_database_health-479"><a href="#ConversationMemoryStore.check_database_health-479"><span class="linenos">479</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.check_database_health-480"><a href="#ConversationMemoryStore.check_database_health-480"><span class="linenos">480</span></a>                <span class="c1"># Taille de la base</span>
</span><span id="ConversationMemoryStore.check_database_health-481"><a href="#ConversationMemoryStore.check_database_health-481"><span class="linenos">481</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) as total FROM conversations&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.check_database_health-482"><a href="#ConversationMemoryStore.check_database_health-482"><span class="linenos">482</span></a>                <span class="n">total_conversations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.check_database_health-483"><a href="#ConversationMemoryStore.check_database_health-483"><span class="linenos">483</span></a>
</span><span id="ConversationMemoryStore.check_database_health-484"><a href="#ConversationMemoryStore.check_database_health-484"><span class="linenos">484</span></a>                <span class="c1"># Utilisateurs uniques</span>
</span><span id="ConversationMemoryStore.check_database_health-485"><a href="#ConversationMemoryStore.check_database_health-485"><span class="linenos">485</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(DISTINCT username, email) as users FROM conversations&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.check_database_health-486"><a href="#ConversationMemoryStore.check_database_health-486"><span class="linenos">486</span></a>                <span class="n">total_users</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.check_database_health-487"><a href="#ConversationMemoryStore.check_database_health-487"><span class="linenos">487</span></a>
</span><span id="ConversationMemoryStore.check_database_health-488"><a href="#ConversationMemoryStore.check_database_health-488"><span class="linenos">488</span></a>                <span class="c1"># Conversations récentes (24h)</span>
</span><span id="ConversationMemoryStore.check_database_health-489"><a href="#ConversationMemoryStore.check_database_health-489"><span class="linenos">489</span></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.check_database_health-490"><a href="#ConversationMemoryStore.check_database_health-490"><span class="linenos">490</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) as recent FROM conversations WHERE timestamp &gt;= ?&quot;</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-491"><a href="#ConversationMemoryStore.check_database_health-491"><span class="linenos">491</span></a>                                      <span class="p">(</span><span class="n">cutoff_time</span><span class="p">,))</span>
</span><span id="ConversationMemoryStore.check_database_health-492"><a href="#ConversationMemoryStore.check_database_health-492"><span class="linenos">492</span></a>                <span class="n">recent_conversations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s1">&#39;recent&#39;</span><span class="p">]</span>
</span><span id="ConversationMemoryStore.check_database_health-493"><a href="#ConversationMemoryStore.check_database_health-493"><span class="linenos">493</span></a>
</span><span id="ConversationMemoryStore.check_database_health-494"><a href="#ConversationMemoryStore.check_database_health-494"><span class="linenos">494</span></a>                <span class="c1"># Taille du fichier</span>
</span><span id="ConversationMemoryStore.check_database_health-495"><a href="#ConversationMemoryStore.check_database_health-495"><span class="linenos">495</span></a>                <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="ConversationMemoryStore.check_database_health-496"><a href="#ConversationMemoryStore.check_database_health-496"><span class="linenos">496</span></a>
</span><span id="ConversationMemoryStore.check_database_health-497"><a href="#ConversationMemoryStore.check_database_health-497"><span class="linenos">497</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore.check_database_health-498"><a href="#ConversationMemoryStore.check_database_health-498"><span class="linenos">498</span></a>                <span class="s1">&#39;database_path&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">),</span>
</span><span id="ConversationMemoryStore.check_database_health-499"><a href="#ConversationMemoryStore.check_database_health-499"><span class="linenos">499</span></a>                <span class="s1">&#39;file_size_bytes&#39;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-500"><a href="#ConversationMemoryStore.check_database_health-500"><span class="linenos">500</span></a>                <span class="s1">&#39;file_size_mb&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="ConversationMemoryStore.check_database_health-501"><a href="#ConversationMemoryStore.check_database_health-501"><span class="linenos">501</span></a>                <span class="s1">&#39;total_conversations&#39;</span><span class="p">:</span> <span class="n">total_conversations</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-502"><a href="#ConversationMemoryStore.check_database_health-502"><span class="linenos">502</span></a>                <span class="s1">&#39;total_users&#39;</span><span class="p">:</span> <span class="n">total_users</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-503"><a href="#ConversationMemoryStore.check_database_health-503"><span class="linenos">503</span></a>                <span class="s1">&#39;conversations_24h&#39;</span><span class="p">:</span> <span class="n">recent_conversations</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-504"><a href="#ConversationMemoryStore.check_database_health-504"><span class="linenos">504</span></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span>
</span><span id="ConversationMemoryStore.check_database_health-505"><a href="#ConversationMemoryStore.check_database_health-505"><span class="linenos">505</span></a>            <span class="p">}</span>
</span><span id="ConversationMemoryStore.check_database_health-506"><a href="#ConversationMemoryStore.check_database_health-506"><span class="linenos">506</span></a>
</span><span id="ConversationMemoryStore.check_database_health-507"><a href="#ConversationMemoryStore.check_database_health-507"><span class="linenos">507</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ConversationMemoryStore.check_database_health-508"><a href="#ConversationMemoryStore.check_database_health-508"><span class="linenos">508</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur vérification santé DB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.check_database_health-509"><a href="#ConversationMemoryStore.check_database_health-509"><span class="linenos">509</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ConversationMemoryStore.check_database_health-510"><a href="#ConversationMemoryStore.check_database_health-510"><span class="linenos">510</span></a>                <span class="s1">&#39;database_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-511"><a href="#ConversationMemoryStore.check_database_health-511"><span class="linenos">511</span></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
</span><span id="ConversationMemoryStore.check_database_health-512"><a href="#ConversationMemoryStore.check_database_health-512"><span class="linenos">512</span></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="ConversationMemoryStore.check_database_health-513"><a href="#ConversationMemoryStore.check_database_health-513"><span class="linenos">513</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Vérifie l'état de santé de la base de données et retourne des statistiques détaillées sur son utilisation. Cette
fonction évalue la taille de la base, le nombre total de conversations stockées, les utilisateurs uniques,
ainsi que le nombre de conversations enregistrées durant les dernières 24 heures.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Un dictionnaire contenant des informations sur la santé de la base de données, y compris
      le chemin absolu de la base, sa taille en octets et mégaoctets, le nombre total de conversations
      enregistrées, le total d'utilisateurs uniques et le nombre de conversations dans les dernières 24 heures.
      Si une erreur survient lors du diagnostic, elle inclut l'erreur et marque l'état de la base comme
      « error ».</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="conversation_memory">
                    <div class="attr variable">
            <span class="name">conversation_memory</span>        =
<span class="default_value">&lt;<a href="#ConversationMemoryStore">ConversationMemoryStore</a> object&gt;</span>

        
    </div>
    <a class="headerlink" href="#conversation_memory"></a>
    
    

                </section>
                <section id="save_conversation">
                            <input id="save_conversation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_conversation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">username</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">email</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">question</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="save_conversation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#save_conversation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="save_conversation-521"><a href="#save_conversation-521"><span class="linenos">521</span></a><span class="k">def</span><span class="w"> </span><span class="nf">save_conversation</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reponse</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="save_conversation-522"><a href="#save_conversation-522"><span class="linenos">522</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="save_conversation-523"><a href="#save_conversation-523"><span class="linenos">523</span></a><span class="sd">    Sauvegarde une conversation dans la mémoire persistante. Cette fonction permet</span>
</span><span id="save_conversation-524"><a href="#save_conversation-524"><span class="linenos">524</span></a><span class="sd">    de stocker les informations pertinentes d&#39;une conversation pour un usage</span>
</span><span id="save_conversation-525"><a href="#save_conversation-525"><span class="linenos">525</span></a><span class="sd">    ultérieur. Les informations sauvegardées incluent le nom d&#39;utilisateur, l&#39;email,</span>
</span><span id="save_conversation-526"><a href="#save_conversation-526"><span class="linenos">526</span></a><span class="sd">    la question posée, la réponse et un identifiant de session facultatif.</span>
</span><span id="save_conversation-527"><a href="#save_conversation-527"><span class="linenos">527</span></a>
</span><span id="save_conversation-528"><a href="#save_conversation-528"><span class="linenos">528</span></a><span class="sd">    :param username: Le nom d&#39;utilisateur qui a participé à la conversation.</span>
</span><span id="save_conversation-529"><a href="#save_conversation-529"><span class="linenos">529</span></a><span class="sd">    :type username: str</span>
</span><span id="save_conversation-530"><a href="#save_conversation-530"><span class="linenos">530</span></a><span class="sd">    :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="save_conversation-531"><a href="#save_conversation-531"><span class="linenos">531</span></a><span class="sd">    :type email: str</span>
</span><span id="save_conversation-532"><a href="#save_conversation-532"><span class="linenos">532</span></a><span class="sd">    :param question: La question posée par l&#39;utilisateur pendant la conversation.</span>
</span><span id="save_conversation-533"><a href="#save_conversation-533"><span class="linenos">533</span></a><span class="sd">    :type question: str</span>
</span><span id="save_conversation-534"><a href="#save_conversation-534"><span class="linenos">534</span></a><span class="sd">    :param reponse: La réponse apportée à la question de l&#39;utilisateur.</span>
</span><span id="save_conversation-535"><a href="#save_conversation-535"><span class="linenos">535</span></a><span class="sd">    :type reponse: str</span>
</span><span id="save_conversation-536"><a href="#save_conversation-536"><span class="linenos">536</span></a><span class="sd">    :param session_id: L&#39;identifiant unique de la session de conversation</span>
</span><span id="save_conversation-537"><a href="#save_conversation-537"><span class="linenos">537</span></a><span class="sd">        (facultatif, peut être None si non fourni).</span>
</span><span id="save_conversation-538"><a href="#save_conversation-538"><span class="linenos">538</span></a><span class="sd">    :type session_id: str, optionnel</span>
</span><span id="save_conversation-539"><a href="#save_conversation-539"><span class="linenos">539</span></a><span class="sd">    :return: Retourne True si la conversation a été sauvegardée avec succès,</span>
</span><span id="save_conversation-540"><a href="#save_conversation-540"><span class="linenos">540</span></a><span class="sd">        False sinon.</span>
</span><span id="save_conversation-541"><a href="#save_conversation-541"><span class="linenos">541</span></a><span class="sd">    :rtype: bool</span>
</span><span id="save_conversation-542"><a href="#save_conversation-542"><span class="linenos">542</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="save_conversation-543"><a href="#save_conversation-543"><span class="linenos">543</span></a>    <span class="k">return</span> <span class="n">conversation_memory</span><span class="o">.</span><span class="n">save_conversation</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">reponse</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sauvegarde une conversation dans la mémoire persistante. Cette fonction permet
de stocker les informations pertinentes d'une conversation pour un usage
ultérieur. Les informations sauvegardées incluent le nom d'utilisateur, l'email,
la question posée, la réponse et un identifiant de session facultatif.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur qui a participé à la conversation.</li>
<li><strong>email</strong>:  L'adresse email associée à l'utilisateur.</li>
<li><strong>question</strong>:  La question posée par l'utilisateur pendant la conversation.</li>
<li><strong>reponse</strong>:  La réponse apportée à la question de l'utilisateur.</li>
<li><strong>session_id</strong>:  L'identifiant unique de la session de conversation
(facultatif, peut être None si non fourni).</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Retourne True si la conversation a été sauvegardée avec succès,
      False sinon.</p>
</blockquote>
</div>


                </section>
                <section id="get_user_context">
                            <input id="get_user_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="get_user_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_user_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_user_context-546"><a href="#get_user_context-546"><span class="linenos">546</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="get_user_context-547"><a href="#get_user_context-547"><span class="linenos">547</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_user_context-548"><a href="#get_user_context-548"><span class="linenos">548</span></a><span class="sd">    Récupère le contexte utilisateur pour formater l&#39;historique de la conversation.</span>
</span><span id="get_user_context-549"><a href="#get_user_context-549"><span class="linenos">549</span></a>
</span><span id="get_user_context-550"><a href="#get_user_context-550"><span class="linenos">550</span></a><span class="sd">    Cette fonction utilise la mémoire de conversation pour retourner un contexte</span>
</span><span id="get_user_context-551"><a href="#get_user_context-551"><span class="linenos">551</span></a><span class="sd">    formaté basé sur l&#39;historique et les informations utilisateur fournies.</span>
</span><span id="get_user_context-552"><a href="#get_user_context-552"><span class="linenos">552</span></a>
</span><span id="get_user_context-553"><a href="#get_user_context-553"><span class="linenos">553</span></a><span class="sd">    :param username: Le nom d&#39;utilisateur utilisé pour le contexte.</span>
</span><span id="get_user_context-554"><a href="#get_user_context-554"><span class="linenos">554</span></a><span class="sd">    :type username: str</span>
</span><span id="get_user_context-555"><a href="#get_user_context-555"><span class="linenos">555</span></a><span class="sd">    :param email: L&#39;adresse e-mail associée à l&#39;utilisateur.</span>
</span><span id="get_user_context-556"><a href="#get_user_context-556"><span class="linenos">556</span></a><span class="sd">    :type email: str</span>
</span><span id="get_user_context-557"><a href="#get_user_context-557"><span class="linenos">557</span></a><span class="sd">    :return: Une chaîne formatée représentant le contexte utilisateur.</span>
</span><span id="get_user_context-558"><a href="#get_user_context-558"><span class="linenos">558</span></a><span class="sd">    :rtype: str</span>
</span><span id="get_user_context-559"><a href="#get_user_context-559"><span class="linenos">559</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_user_context-560"><a href="#get_user_context-560"><span class="linenos">560</span></a>    <span class="k">return</span> <span class="n">conversation_memory</span><span class="o">.</span><span class="n">format_history_for_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Récupère le contexte utilisateur pour formater l'historique de la conversation.</p>

<p>Cette fonction utilise la mémoire de conversation pour retourner un contexte
formaté basé sur l'historique et les informations utilisateur fournies.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Le nom d'utilisateur utilisé pour le contexte.</li>
<li><strong>email</strong>:  L'adresse e-mail associée à l'utilisateur.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Une chaîne formatée représentant le contexte utilisateur.</p>
</blockquote>
</div>


                </section>
                <section id="get_user_stats">
                            <input id="get_user_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">username</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">email</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="get_user_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_user_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_user_stats-563"><a href="#get_user_stats-563"><span class="linenos">563</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_stats</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="get_user_stats-564"><a href="#get_user_stats-564"><span class="linenos">564</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_user_stats-565"><a href="#get_user_stats-565"><span class="linenos">565</span></a><span class="sd">    Récupère les statistiques de conversation d&#39;un utilisateur donné.</span>
</span><span id="get_user_stats-566"><a href="#get_user_stats-566"><span class="linenos">566</span></a>
</span><span id="get_user_stats-567"><a href="#get_user_stats-567"><span class="linenos">567</span></a><span class="sd">    Cette fonction interagit avec une mémoire de conversation pour obtenir</span>
</span><span id="get_user_stats-568"><a href="#get_user_stats-568"><span class="linenos">568</span></a><span class="sd">    des statistiques spécifiques à un utilisateur identifiable par son nom</span>
</span><span id="get_user_stats-569"><a href="#get_user_stats-569"><span class="linenos">569</span></a><span class="sd">    d&#39;utilisateur et son adresse e-mail.</span>
</span><span id="get_user_stats-570"><a href="#get_user_stats-570"><span class="linenos">570</span></a>
</span><span id="get_user_stats-571"><a href="#get_user_stats-571"><span class="linenos">571</span></a><span class="sd">    :param username: Nom d&#39;utilisateur pour identifier l&#39;utilisateur cible.</span>
</span><span id="get_user_stats-572"><a href="#get_user_stats-572"><span class="linenos">572</span></a><span class="sd">    :type username: str</span>
</span><span id="get_user_stats-573"><a href="#get_user_stats-573"><span class="linenos">573</span></a><span class="sd">    :param email: Adresse e-mail associée à l&#39;utilisateur.</span>
</span><span id="get_user_stats-574"><a href="#get_user_stats-574"><span class="linenos">574</span></a><span class="sd">    :type email: str</span>
</span><span id="get_user_stats-575"><a href="#get_user_stats-575"><span class="linenos">575</span></a><span class="sd">    :return: Un dictionnaire contenant les statistiques de conversation</span>
</span><span id="get_user_stats-576"><a href="#get_user_stats-576"><span class="linenos">576</span></a><span class="sd">        associées à l&#39;utilisateur.</span>
</span><span id="get_user_stats-577"><a href="#get_user_stats-577"><span class="linenos">577</span></a><span class="sd">    :rtype: Dict</span>
</span><span id="get_user_stats-578"><a href="#get_user_stats-578"><span class="linenos">578</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_user_stats-579"><a href="#get_user_stats-579"><span class="linenos">579</span></a>    <span class="k">return</span> <span class="n">conversation_memory</span><span class="o">.</span><span class="n">get_conversation_stats</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Récupère les statistiques de conversation d'un utilisateur donné.</p>

<p>Cette fonction interagit avec une mémoire de conversation pour obtenir
des statistiques spécifiques à un utilisateur identifiable par son nom
d'utilisateur et son adresse e-mail.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong>:  Nom d'utilisateur pour identifier l'utilisateur cible.</li>
<li><strong>email</strong>:  Adresse e-mail associée à l'utilisateur.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Un dictionnaire contenant les statistiques de conversation
      associées à l'utilisateur.</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>