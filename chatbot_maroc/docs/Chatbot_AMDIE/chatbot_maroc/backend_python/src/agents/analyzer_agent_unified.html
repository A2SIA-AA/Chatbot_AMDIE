<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>Chatbot_AMDIE.chatbot_maroc.backend_python.src.agents.analyzer_agent_unified API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../agents.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;Chatbot_AMDIE.chatbot_maroc.backend_python.src.agents</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#AnalyzerAgentUnified">AnalyzerAgentUnified</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AnalyzerAgentUnified.__init__">AnalyzerAgentUnified</a>
                        </li>
                        <li>
                                <a class="variable" href="#AnalyzerAgentUnified.gemini_model">gemini_model</a>
                        </li>
                        <li>
                                <a class="variable" href="#AnalyzerAgentUnified.chatbot">chatbot</a>
                        </li>
                        <li>
                                <a class="function" href="#AnalyzerAgentUnified.execute">execute</a>
                        </li>
                        <li>
                                <a class="function" href="#AnalyzerAgentUnified.agent_analyseur_unifie">agent_analyseur_unifie</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
Chatbot_AMDIE<wbr>.chatbot_maroc<wbr>.<a href="./../../../backend_python.html">backend_python</a><wbr>.<a href="./../../src.html">src</a><wbr>.<a href="./../agents.html">agents</a><wbr>.analyzer_agent_unified    </h1>

                
                        <input id="mod-analyzer_agent_unified-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-analyzer_agent_unified-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">google</span><span class="w"> </span><span class="kn">import</span> <span class="n">genai</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">..core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatbotState</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">..utils.message_to_front</span><span class="w"> </span><span class="kn">import</span> <span class="n">_send_to_frontend</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">..core.memory_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_context</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AnalyzerAgentUnified</span><span class="p">:</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    La classe AnalyzerAgentUnified est responsable d&#39;exécuter des tâches d&#39;analyse complexes sur des données Excel</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    et PDF en utilisant des modèles d&#39;IA et des outils d&#39;automatisation. Elle gère également la communication avec</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">    un chatbot et garantit une analyse robuste avec des étapes définies de traitement des données.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">    :ivar gemini_model: Référence au modèle Gemini utilisé pour les opérations d&#39;analyse.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">    :ivar chatbot: Instance de chatbot utilisée pour la journalisation et les interactions avec l&#39;utilisateur.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gemini_model</span><span class="p">,</span> <span class="n">chatbot_instance</span><span class="p">):</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gemini_model</span> <span class="o">=</span> <span class="n">gemini_model</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span> <span class="o">=</span> <span class="n">chatbot_instance</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">        Exécute une analyse sur l&#39;état actuel du chatbot et retourne un nouvel état</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">        après traitement par l&#39;agent analyseur unifié.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">        Le comportement de cette méthode dépend de la logique d&#39;analyse définie</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">        par l&#39;agent analyseur unifié. Elle prend en entrée l&#39;état actuel du chatbot et</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">        le traite pour retourner un état mis à jour.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot à traiter.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">        :return: Le nouvel état du chatbot après traitement par l&#39;agent analyseur unifié.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">        :rtype: ChatbotState</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_analyseur_unifie</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">agent_analyseur_unifie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">        Analyse et traitement unifiés des documents Excel et PDF basés sur l&#39;état actuel</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">        du chatbot. Ce processus intègre l&#39;historique de l&#39;utilisateur et finalise l&#39;état</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        après traitement des documents.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot, encapsulant les données nécessaires au</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">            traitement et à l&#39;analyse des documents.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        :return: L&#39;état mis à jour du chatbot après l&#39;exécution complète des analyses</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">            Excel et PDF.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">        :rtype: ChatbotState</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Agent Analyseur Unifié: Début de l&#39;analyse Excel + PDF&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="n">session_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>            <span class="n">_send_to_frontend</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;Agent Analyseur Unifié: Traitement Excel + PDF...&quot;</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Envoi frontend échoué: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="c1"># Récupérer les informations utilisateur</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>        <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_user_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="c1"># Récupérer l&#39;historique utilisateur</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="n">historique_contexte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="c1"># ========== PARTIE 1: ANALYSE EXCEL ==========</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="n">excel_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_excel_documents</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="c1"># ========== PARTIE 2: ANALYSE PDF  ==========</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">pdf_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_pdf_documents</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="c1"># ========== PARTIE 3: ÉTAT FINAL ==========</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_analysis_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">excel_processed</span><span class="p">,</span> <span class="n">pdf_processed</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="k">return</span> <span class="n">state</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_excel_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        Analyse et traite les documents Excel pour identifier les données valides, les traiter et</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">        préparer une réponse basée sur leur contenu.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        Cette méthode prend en charge plusieurs étapes, incluant la création des DataFrames à partir</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">        des fichiers Excel, la préparation du contexte pour traitement, la gestion des erreurs durant</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">        les processus d&#39;analyse, et l&#39;envoi des données pour une analyse approfondie via un système</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        externe. Une fois analysées, les données retournées peuvent être traitées et interprétées pour</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">        en extraire les informations pertinentes.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        :param state: Instance d&#39;état contenant les informations de la session en cours.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        :param historique_contexte: Historique contextuel pour enrichir le prompt d&#39;analyse.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        :return: Un booléen indiquant si l&#39;analyse des documents Excel a été effectuée avec succès.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="c1"># Vérifier s&#39;il y a des Excel à traiter</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="n">tableaux_pour_upload</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tableaux_pour_upload&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tableaux_pour_upload</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Aucun tableau Excel à analyser&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;excel_empty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyse de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tableaux_pour_upload</span><span class="p">)</span><span class="si">}</span><span class="s2"> tableaux Excel&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>            <span class="c1"># Création des DataFrames avec validation</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creer_dataframes_valides</span><span class="p">(</span><span class="n">tableaux_pour_upload</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">]:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Impossible de traiter les données Excel trouvées.&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">contexte_complet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preparer_contexte_excel_avec_metadata</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="c1"># Variables pour le nettoyage</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>            <span class="n">fichier_gemini</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>            <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>                <span class="n">fichier_csv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creer_csvs_pour_gemini</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">],</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">fichier_csv</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Aucun fichier CSV créé&quot;</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>                <span class="n">fichier_gemini</span><span class="p">,</span> <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_fichier_to_gemini</span><span class="p">(</span><span class="n">fichier_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fichiers_gemini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fichier_gemini</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>                <span class="n">prompt_excel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creer_prompt_excel_unifie</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">contexte_complet</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                    <span class="n">_send_to_frontend</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">),</span> <span class="s2">&quot;Génération de réponse Excel...&quot;</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>                    <span class="k">pass</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt_excel</span><span class="p">]</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                <span class="n">content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fichier_gemini</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PROMPT EXCEL: </span><span class="si">{</span><span class="n">prompt_excel</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; FICHIERS GEMINI: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fichier_gemini</span><span class="p">)</span><span class="si">}</span><span class="s2"> fichiers&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_gemini_with_retry</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; FINISH_REASON: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">finish_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; HAS PARTS: </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;parts&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>                <span class="n">answer_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_contenu_gemini_robuste</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; REPONSE EXTRAITE: </span><span class="si">{</span><span class="n">answer_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_text</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_excel_fallback</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_analyseur_brute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_text</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                <span class="n">calculs_detected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_excel_response_avec_garantie_calculs</span><span class="p">(</span><span class="n">answer_text</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                                                                                    <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">calculs_detected</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_excel_fallback</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyse Excel terminée - Calculs nécessaires: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>                                  <span class="n">state</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur analyse Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_excel_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                <span class="c1"># Nettoyage garanti</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                <span class="k">if</span> <span class="n">fichier_gemini</span> <span class="ow">and</span> <span class="n">client</span><span class="p">:</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_nettoyer_fichiers_gemini</span><span class="p">(</span><span class="n">fichier_gemini</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur nettoyage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur création DataFrames Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Erreur lors du traitement des données Excel.&quot;</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_pdf_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        Analyse les documents PDF spécifiés dans l&#39;état du chatbot et génère des réponses</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">        en fonction de leur contenu en utilisant le service Gemini.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        Cette méthode vérifie d&#39;abord l&#39;existence des documents PDF à analyser. Les documents</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        sont ensuite téléchargés sur le service Gemini pour une analyse approfondie selon une</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        question fournie par l&#39;utilisateur. Si l&#39;analyse est réussie, la réponse correspondante</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        et les sources des documents sont stockées dans l&#39;état. En cas d&#39;échec, aucune réponse</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        n&#39;est générée.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">        :param state: Un objet représentant l&#39;état actuel du chatbot, contenant des</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">                      informations nécessaires pour l&#39;analyse.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        :param historique_contexte: Une chaîne représentant l&#39;historique contextuel du</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">                                     chatbot durant l&#39;interaction.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        :type historique_contexte: str</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">        :return: Indique si l&#39;analyse des documents PDF a réussi ou échoué.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">        :rtype: bool</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">        :raises Exception: Si une erreur inattendue survient lors de l&#39;analyse ou du</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">                           téléchargement des documents.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="n">pdfs_pour_upload</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdfs_pour_upload&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdfs_pour_upload</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Aucun document PDF à analyser&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sources_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DEBUG PDF: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pdfs_pour_upload</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDFs à analyser&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="c1"># Upload des PDFs vers Gemini</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>            <span class="n">fichiers_pdf_gemini</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>            <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdf_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdfs_pour_upload</span><span class="p">):</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DEBUG PDF </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pdf_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>                <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">pdf_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdf_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pdf_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tableau_path&#39;</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF path: </span><span class="si">{</span><span class="n">pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                <span class="k">if</span> <span class="n">pdf_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF existe: </span><span class="si">{</span><span class="n">pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                            <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>                            <span class="n">client</span> <span class="o">=</span> <span class="n">genai</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                        <span class="c1"># Upload du PDF vers Gemini</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Upload PDF vers Gemini...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                        <span class="n">fichier_pdf</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">pdf_path</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                        <span class="n">fichiers_pdf_gemini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fichier_pdf</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> uploadé: </span><span class="si">{</span><span class="n">fichier_pdf</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur upload PDF </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> inexistant: </span><span class="si">{</span><span class="n">pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">fichiers_pdf_gemini</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Aucun PDF uploadé avec succès&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fichiers_pdf_gemini</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDFs uploadés, analyse...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="c1"># Créer le prompt avec les PDFs uploadés</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="n">prompt_pdf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Tu es un expert qui analyse le contenu COMPLET des documents PDF.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="s2">    QUESTION: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="s2">    INSTRUCTIONS:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="s2">    1. Lis attentivement le contenu de tous les PDFs fournis</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="s2">    2. Réponds directement à la question avec les informations des PDFs</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="s2">    3. Si les PDFs ne contiennent pas d&#39;info pertinente, dis-le clairement</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="s2">    RÉPONSE:&quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="c1"># Appel Gemini avec les PDFs</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt_pdf</span><span class="p">]</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="n">content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fichiers_pdf_gemini</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Appel Gemini avec PDFs...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-2.5-pro&quot;</span><span class="p">,</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>                <span class="n">contents</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                <span class="n">config</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">GenerateContentConfig</span><span class="p">(</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>                    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>                    <span class="n">candidate_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                    <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">8192</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                <span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>            <span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>            <span class="c1"># Extraction et stockage</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>            <span class="c1">#self.chatbot._log(f&quot;REPONSE GEMINI : {response}&quot;,state)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="n">answer_text_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_contenu_gemini_robuste</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Réponse PDF: </span><span class="si">{</span><span class="n">answer_text_pdf</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">answer_text_pdf</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>            <span class="k">if</span> <span class="n">answer_text_pdf</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_text_pdf</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sources_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titre_contextuel&#39;</span><span class="p">,</span> <span class="s1">&#39;PDF&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">pdfs_pour_upload</span><span class="p">]</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyse PDF réussie&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>                <span class="c1"># Nettoyage Gemini</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                <span class="k">for</span> <span class="n">fichier</span> <span class="ow">in</span> <span class="n">fichiers_pdf_gemini</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                        <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fichier</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                        <span class="k">pass</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Extraction réponse PDF échouée&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur analyse PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traceback: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_excel_response_avec_garantie_calculs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer_text</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">):</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        Analyse et traite une réponse Excel fournie afin de déterminer si elle nécessite des</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">        calculs ou si elle contient une réponse directe. Si des calculs sont nécessaires,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">        génère des étapes d&#39;instructions et un algorithme correspondant. En cas de réponse</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">        directe, extrait et retourne cette réponse. Garantit une analyse ou une réponse</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">        adéquate même en cas d&#39;erreur.</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">        :param answer_text: Texte de réponse à analyser et traiter</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        :type answer_text: str</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">        :param state: Dictionnaire contenant l&#39;état courant, incluant la question, les résultats</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">                      intermédiaires et les données contextuelles</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        :param historique_contexte: Historique des interactions ou contexte supplémentaire</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">        :type historique_contexte: list</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        :return: Indique si une analyse ou un traitement des calculs ont été réalisés</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        :rtype: bool</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">answer_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="s2">&quot;answer_text invalide pour parsing Excel&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DEBUT PARSING - Longueur: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">answer_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; APERÇU RÉPONSE: &#39;</span><span class="si">{</span><span class="n">answer_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing Excel de &#39;</span><span class="si">{</span><span class="n">answer_text</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>            <span class="n">patterns_calculs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*CALCULS&#39;</span><span class="p">,</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="sa">r</span><span class="s1">&#39;CALCULS_NECESSAIRES&#39;</span><span class="p">,</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                <span class="sa">r</span><span class="s1">&#39;FORMAT\s*1&#39;</span><span class="p">,</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                <span class="sa">r</span><span class="s1">&#39;ETAPES?\s*:&#39;</span><span class="p">,</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                <span class="sa">r</span><span class="s1">&#39;ALGORITHME\s*:&#39;</span><span class="p">,</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                <span class="sa">r</span><span class="s1">&#39;```python&#39;</span><span class="p">,</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                <span class="sa">r</span><span class="s1">&#39;df\d+\.&#39;</span><span class="p">,</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                <span class="sa">r</span><span class="s1">&#39;besoin.*calcul&#39;</span><span class="p">,</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                <span class="sa">r</span><span class="s1">&#39;exécuter.*code&#39;</span><span class="p">,</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="sa">r</span><span class="s1">&#39;analyser.*données&#39;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="p">]</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="n">patterns_direct</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT&#39;</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                <span class="sa">r</span><span class="s1">&#39;REPONSE_DIRECTE&#39;</span><span class="p">,</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                <span class="sa">r</span><span class="s1">&#39;FORMAT\s*2&#39;</span><span class="p">,</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                <span class="sa">r</span><span class="s1">&#39;REPONSE\s*:&#39;</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="p">]</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="n">is_calculs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="n">is_direct</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_calculs</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">answer_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                    <span class="n">is_calculs</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                    <span class="k">break</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_direct</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">answer_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="n">is_direct</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                    <span class="k">break</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="n">question</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="n">question_needs_calculs</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                <span class="s1">&#39;combien&#39;</span><span class="p">,</span> <span class="s1">&#39;pourcentage&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;moyenne&#39;</span><span class="p">,</span> <span class="s1">&#39;maximum&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum&#39;</span><span class="p">,</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                <span class="s1">&#39;calcul&#39;</span><span class="p">,</span> <span class="s1">&#39;analyse&#39;</span><span class="p">,</span> <span class="s1">&#39;compare&#39;</span><span class="p">,</span> <span class="s1">&#39;évolution&#39;</span><span class="p">,</span> <span class="s1">&#39;statistique&#39;</span><span class="p">,</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                <span class="s1">&#39;quelle ville&#39;</span><span class="p">,</span> <span class="s1">&#39;plus élevé&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion&#39;</span><span class="p">,</span> <span class="s1">&#39;tendance&#39;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="p">])</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PATTERNS - CALCULS: </span><span class="si">{</span><span class="n">is_calculs</span><span class="si">}</span><span class="s2">, DIRECT: </span><span class="si">{</span><span class="n">is_direct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="k">if</span> <span class="n">is_calculs</span> <span class="ow">or</span> <span class="p">(</span><span class="n">question_needs_calculs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_direct</span><span class="p">):</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; BRANCHE CALCULS ACTIVÉE&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;CALCULS DÉTECTÉS - Extraction des étapes&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="n">etapes</span><span class="p">,</span> <span class="n">algorithme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_etapes_et_algo_flexible</span><span class="p">(</span><span class="n">answer_text</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="k">if</span> <span class="n">etapes</span> <span class="ow">and</span> <span class="n">algorithme</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etapes</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithme</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; CALCULS GARANTIS - Étapes et algo extraits&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; FALLBACK CALCULS - Génération automatique&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                    <span class="n">state</span><span class="p">[</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                        <span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour répondre à : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                    <span class="c1"># Algo intelligent basé sur la question</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                    <span class="k">if</span> <span class="s1">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">question</span> <span class="ow">or</span> <span class="s1">&#39;somme&#39;</span> <span class="ow">in</span> <span class="n">question</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Calculer les totaux</span><span class="se">\n</span><span class="s2">resultat = df0.sum(numeric_only=True)&quot;</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>                    <span class="k">elif</span> <span class="s1">&#39;moyenne&#39;</span> <span class="ow">in</span> <span class="n">question</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Calculer les moyennes</span><span class="se">\n</span><span class="s2">resultat = df0.mean(numeric_only=True)&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>                    <span class="k">elif</span> <span class="s1">&#39;compare&#39;</span> <span class="ow">in</span> <span class="n">question</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Comparer les données</span><span class="se">\n</span><span class="s2">resultat = df0.groupby(df0.columns[0]).sum()&quot;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyser les données selon la question</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; CALCULS GARANTIS - Fallback appliqué&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>            <span class="k">elif</span> <span class="n">is_direct</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;RÉPONSE DIRECTE DÉTECTÉE&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                <span class="n">reponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_reponse_directe_flexible</span><span class="p">(</span><span class="n">answer_text</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                <span class="k">if</span> <span class="n">reponse</span><span class="p">:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reponse</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Réponse directe Excel extraite&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>            <span class="c1"># FALLBACK FINAL BASÉ SUR LA QUESTION</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>            <span class="k">if</span> <span class="n">question_needs_calculs</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; GARANTIE FINALE - Question nécessite des calculs&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyser les dataframes selon la question</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Question factuelle - pas de calculs nécessaires&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur parsing Excel: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="c1"># MÊME EN CAS D&#39;ERREUR, SI LA QUESTION NÉCESSITE DES CALCULS, ON LES FAIT</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">question</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;combien&#39;</span><span class="p">,</span> <span class="s1">&#39;pourcentage&#39;</span><span class="p">,</span> <span class="s1">&#39;calcul&#39;</span><span class="p">,</span> <span class="s1">&#39;analyse&#39;</span><span class="p">]):</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; ERREUR MAIS CALCULS FORCÉS&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyse de base</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_analysis_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">,</span> <span class="n">excel_processed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">pdf_processed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        Met à jour et enregistre l&#39;état final de l&#39;analyse en fonction des résultats</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">        des traitements effectués sur les fichiers Excel et PDF. Cette méthode</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        enregistre des messages de journalisation en fonction des conditions remplies</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">        et vérifie également la présence des réponses issues des analyses Excel, PDF,</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">        ainsi que des calculs éventuels.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot. Contient des informations sur les calculs</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">            et les réponses déjà générées.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">        :param excel_processed: Indique si le fichier Excel a été traité avec succès.</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">        :type excel_processed: bool</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        :param pdf_processed: Indique si le fichier PDF a été traité avec succès.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">        :type pdf_processed: bool</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">        :return: Aucun résultat n&#39;est retourné.</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">        :rtype: None</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="k">if</span> <span class="n">excel_processed</span> <span class="ow">and</span> <span class="n">pdf_processed</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyses Excel + PDF terminées avec succès&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="k">elif</span> <span class="n">excel_processed</span><span class="p">:</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyse Excel seule terminée&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="k">elif</span> <span class="n">pdf_processed</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyse PDF seule terminée&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Aucune analyse n&#39;a abouti&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="c1"># Debug des résultats</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">has_calculs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="n">has_excel_response</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="n">has_pdf_response</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reponse_finale_pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="sa">f</span><span class="s2">&quot;État final: calculs=</span><span class="si">{</span><span class="n">has_calculs</span><span class="si">}</span><span class="s2">, excel_response=</span><span class="si">{</span><span class="n">has_excel_response</span><span class="si">}</span><span class="s2">, pdf_response=</span><span class="si">{</span><span class="n">has_pdf_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="n">state</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_user_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">        Récupère le contexte utilisateur basé sur le nom d&#39;utilisateur et l&#39;email. Si le contexte</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        peut être récupéré et qu&#39;il n&#39;indique aucune conversation précédente, un message de</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">        journalisation est enregistré. En cas d&#39;erreur, un message d&#39;erreur est enregistré</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">        et une chaîne vide est retournée.</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour identifier l&#39;utilisateur.</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">        :type username: str</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">        :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">        :type email: str</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">        :param state: L&#39;état actuel ou contexte d&#39;exécution en cours.</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">        :type state: Any</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">        :return: Une chaîne contenant le contexte utilisateur ou une chaîne vide si le contexte</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">                 ne peut pas être récupéré.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">        :rtype: str</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="n">historique_contexte</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>            <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">email</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="n">historique_contexte</span> <span class="o">=</span> <span class="n">get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                <span class="k">if</span> <span class="n">historique_contexte</span> <span class="ow">and</span> <span class="s2">&quot;Aucune conversation précédente&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">historique_contexte</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Historique utilisateur récupéré pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Première conversation pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Récupération historique: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="n">historique_contexte</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="k">return</span> <span class="n">historique_contexte</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        Extrait les informations de l&#39;utilisateur depuis l&#39;état d&#39;un chatbot. Cette méthode analyse</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">        l&#39;état fourni pour identifier et retourner le nom d&#39;utilisateur et l&#39;adresse email correspondante.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">        Si les informations ne sont pas directement disponibles, elle établit des valeurs par défaut en</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        fonction du rôle d&#39;utilisateur trouvé dans l&#39;état. En cas d&#39;erreur, une journalisation est effectuée.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        :param state: Représente l&#39;état actuel du chatbot contenant les informations de l&#39;utilisateur.</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        :return: Une paire (tuple) contenant le nom d&#39;utilisateur et son adresse email. Retourne</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">                 (None, None) en cas d&#39;échec ou si les informations ne sont pas disponibles.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        :rtype: tuple</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="n">session_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            <span class="n">username</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">email</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="n">user_role</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_role&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                    <span class="k">return</span> <span class="s1">&#39;admin_user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin@amdie.ma&#39;</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                <span class="k">elif</span> <span class="s1">&#39;employee&#39;</span> <span class="ow">in</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s1">&#39;employee&#39;</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                    <span class="k">return</span> <span class="s1">&#39;employee_user&#39;</span><span class="p">,</span> <span class="s1">&#39;employee@amdie.ma&#39;</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                    <span class="k">return</span> <span class="s1">&#39;public_user&#39;</span><span class="p">,</span> <span class="s1">&#39;public@amdie.ma&#39;</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur extraction info utilisateur: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_creer_prompt_excel_unifie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">contexte_complet</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">):</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a><span class="sd">        Crée un prompt unifié pour une analyse de données basée sur le contexte donné. Le prompt généré</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="sd">        fournit une structure strictement formatée pour répondre aux questions des utilisateurs sur des</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="sd">        données Excel avec une perspective spécifique au Maroc.</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">        :param state: Dictionnaire contenant la question de l&#39;utilisateur sous la clé</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">            &#39;question_utilisateur&#39;.</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">        :param contexte_complet: Chaîne représentant le contexte complet qui sera intégré au prompt.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">        :type contexte_complet: str</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">        :param historique_contexte: Historique ou contexte supplémentaire qui peut être utilisé pour</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">            enrichir le prompt.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">        :type historique_contexte: str</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">        :return: Une chaîne formatée qui constitue le prompt pour répondre à la question utilisateur.</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">        :rtype: str</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Tu es un expert en analyse de données du Maroc.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="s2">    QUESTION: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="s2">    </span><span class="si">{</span><span class="n">contexte_complet</span><span class="si">}</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="s2">    RÈGLE SIMPLE: </span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="s2">    - Si la question nécessite des CALCULS (pourcentage, total, comparaison) → réponds &quot;TYPE: CALCULS&quot;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="s2">    - Sinon → réponds &quot;TYPE: DIRECT&quot; suivi de ta réponse</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="s2">    FORMAT DE RÉPONSE OBLIGATOIRE:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="s2">TYPE: CALCULS</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="s2">INSTRUCTION_CALCUL: [description des étapes]</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="s2">ALGORITHME: [étapes détaillées]</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="s2">SOURCES_UTILISEES: [sources]</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="k">return</span> <span class="n">prompt</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extraire_contenu_gemini_robuste</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        Extrait de manière robuste le contenu textuel depuis la réponse d&#39;un service Gemini.</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        Ce traitement analyse les composants de la réponse pour extraire toutes les parties textuelles</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        disponibles et les concatène en une seule chaîne de caractères. Si aucune partie textuelle</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">        n&#39;est disponible ou si une erreur se produit durant cette extraction, la fonction retourne `None`.</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">        :param response: La réponse du service Gemini contenant potentiellement des données candidates</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">            avec du contenu structuré.</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        :type response: object</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">        :param state: État courant de l&#39;application ou de la session permettant de journaliser les informations.</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">        :type state: object</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        :return: Une chaîne de texte combinée issue des parties disponibles, ou `None` si rien n&#39;est extrait</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">            ou qu&#39;une erreur survient.</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">        :rtype: Optional[str]</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;candidates&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                <span class="n">candidate</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;parts&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PARTS COUNT: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PART </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="si">}</span><span class="s2"> - hasattr text: </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                                              <span class="n">state</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">):</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PART </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> TEXT: </span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                        <span class="n">all_text</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                                <span class="n">all_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                        <span class="k">if</span> <span class="n">all_text</span><span class="p">:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extraire_etapes_et_algo_flexible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texte</span><span class="p">):</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">        Extrait les étapes et l&#39;algorithme d&#39;un texte donné en utilisant des expressions</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        régulières pour garantir une extraction flexible et robuste. Cette méthode</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="sd">        accepte un texte structuré contenant des sections telles que &quot;ETAPES&quot; et</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">        &quot;ALGORITHME&quot;. Elle tente de localiser et de découper ces sections en fonction</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        de plusieurs motifs prédéfinis.</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">        Si aucune section valide n&#39;est trouvée, la méthode retourne None.</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">        :param texte: Contenu textuel à partir duquel les étapes et l&#39;algorithme</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">            seront extraits.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">        :type texte: str</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">        :return: Une paire composée des étapes extraites sous forme de texte</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">            et de l&#39;algorithme extrait. Si aucun élément n&#39;est trouvé,</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">            retourne deux valeurs None.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        :rtype: Tuple[Optional[str], Optional[str]]</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">texte</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texte</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="c1"># Patterns multiples pour extraction robuste</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="n">patterns_etapes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="sa">r</span><span class="s1">&#39;ETAPES?\s*:?\s*\n(.*?)(?=ALGORITHME|```|$)&#39;</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="sa">r</span><span class="s1">&#39;(\d+\..*?)(?=ALGORITHME|```|$)&#39;</span><span class="p">,</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="p">]</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        <span class="n">patterns_algo</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="sa">r</span><span class="s1">&#39;ALGORITHME\s*:?\s*\n(.*?)(?=```|$)&#39;</span><span class="p">,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="sa">r</span><span class="s1">&#39;```python\s*(.*?)```&#39;</span><span class="p">,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>            <span class="sa">r</span><span class="s1">&#39;```\s*(.*?)```&#39;</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="p">]</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">etapes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">algorithme</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="c1"># Extraction des étapes</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_etapes</span><span class="p">:</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">texte</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                    <span class="n">extracted</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                        <span class="n">etapes</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                        <span class="k">break</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="k">continue</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>        <span class="c1"># Extraction de l&#39;algorithme</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_algo</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">texte</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                    <span class="n">extracted</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                        <span class="n">algorithme</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                        <span class="k">break</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="k">continue</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="k">return</span> <span class="n">etapes</span><span class="p">,</span> <span class="n">algorithme</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extraire_reponse_directe_flexible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texte</span><span class="p">):</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">        Extrait une réponse directe depuis une chaîne de texte en utilisant des expressions</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        régulières pour identifier des modèles spécifiques. Le processus tente</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">        d&#39;abord les motifs les plus restrictifs avant de passer à ceux plus généraux.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">        :param texte: Chaîne de texte contenant des informations structurées</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">            à analyser.</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        :type texte: str</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">        :return: La réponse directe extraite si trouvée et valide, ou None sinon.</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">        :rtype: str | None</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">texte</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texte</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">texte</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="n">patterns_reponse</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="c1"># Pattern 1: Directement après TYPE: DIRECT</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT\s*\n(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT\s+(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                <span class="sa">r</span><span class="s1">&#39;REPONSE\s*:?\s*(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT.*?REPONSE\s*:?\s*(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                <span class="sa">r</span><span class="s1">&#39;(?:TYPE.*?\n|HISTORIQUE.*?\n)+(.*?)$&#39;</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="p">]</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_reponse</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">texte</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                    <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                        <span class="n">reponse</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                        <span class="k">if</span> <span class="n">reponse</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reponse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reponse</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                            <span class="c1"># Nettoyer la réponse</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                            <span class="n">reponse</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reponse</span><span class="p">)</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; REPONSE EXTRAITE: &#39;</span><span class="si">{</span><span class="n">reponse</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                            <span class="k">return</span> <span class="n">reponse</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                    <span class="k">continue</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur extraction reponse directe: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_excel_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">):</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        Analyse le contexte d&#39;une question utilisateur pour déterminer si une analyse</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">        basée sur des calculs est nécessaire et applique des instructions adaptées en</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">        conséquence.</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        Cette méthode évalue si une question utilisateur contient des mots-clés</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">        impliquant un besoin d&#39;analyse ou de calcul via l&#39;exploration de données dans</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        un contexte donné. Si un besoin de calcul est détecté, une réponse spécifique</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        et des instructions de calcul sont générées. Sinon, une réponse générique est</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        assignée au contexte.</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        :param state: L&#39;état courant du processus d&#39;analyse, contenant notamment la</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">            question utilisateur sous forme de chaîne de caractères et d&#39;autres</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">            informations sur le contexte.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        :param historique_contexte: L&#39;historique du contexte pour maintenir une traçabilité</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">            des interactions.</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        :type historique_contexte: list</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">        :return: Cette méthode ne retourne rien. Elle modifie directement le dictionnaire</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">            `state` en fonction de l&#39;analyse réalisée.</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">        :rtype: None</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="n">question</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;combien&#39;</span><span class="p">,</span> <span class="s1">&#39;pourcentage&#39;</span><span class="p">,</span> <span class="s1">&#39;calcul&#39;</span><span class="p">,</span> <span class="s1">&#39;analyse&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">]):</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyse fallback</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; FALLBACK EXCEL - Calculs forcés&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyse en cours pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; FALLBACK EXCEL - Réponse directe&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_excel_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a><span class="sd">        Gère une erreur technique liée à Excel en modifiant l&#39;état fourni et en enregistrant un message d&#39;erreur.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">        L&#39;état est mis à jour pour indiquer qu&#39;aucun calcul supplémentaire n&#39;est nécessaire, et un message d&#39;erreur</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a><span class="sd">        est enregistré pour permettre un retour clair à l&#39;utilisateur.</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        :param error: Objet représentant l&#39;erreur technique capturée.</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        :type error: Exception</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">        :param state: Dictionnaire représentant l&#39;état courant, qui sera modifié pour inclure l&#39;information liée à l&#39;erreur.</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">        :return: Aucun retour explicite. L&#39;état est modifié directement.</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">        :rtype: None</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erreur technique Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_preparer_contexte_excel_avec_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a><span class="sd">        Prépare un contexte Excel avec des métadonnées pour l&#39;analyse.</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">        Cette fonction génère une chaîne de caractères décrivant les données disponibles</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="sd">        pour l&#39;analyse, notamment les tableaux et dataframes présents, leur structure,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">        et les colonnes qu&#39;ils contiennent. Cela inclut des détails tels que le titre</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">        contextuel, le fichier source et la feuille associée. Seules les colonnes</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">        des cinq premières colonnes sont affichées pour chaque dataframe.</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">        :param state: Un dictionnaire contenant des informations sur les tableaux importés</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">                      et les dataframes correspondants, avec les clés &#39;tableaux_pour_upload&#39;</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">                      et &#39;dataframes&#39;.</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        :return: Une chaîne de caractères contenant un résumé formaté des tableaux et</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">                 dataframes disponibles pour l&#39;analyse.</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        :rtype: str</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="n">contexte</span> <span class="o">=</span> <span class="s2">&quot;DONNÉES DISPONIBLES POUR L&#39;ANALYSE:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="n">tableaux_a_analyser</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tableaux_pour_upload&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="n">dataframes_a_analyser</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataframes&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">tableau</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tableaux_a_analyser</span><span class="p">,</span> <span class="n">dataframes_a_analyser</span><span class="p">)):</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>            <span class="n">titre</span> <span class="o">=</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titre_contextuel&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Tableau </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="n">source</span> <span class="o">=</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fichier_source&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="n">feuille</span> <span class="o">=</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nom_feuille&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="n">contexte</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;DATAFRAME df</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: &quot;</span><span class="si">{</span><span class="n">titre</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="s2">   Source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> -&gt; Feuille &quot;</span><span class="si">{</span><span class="n">feuille</span><span class="si">}</span><span class="s2">&quot; </span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="s2">   Structure: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> lignes × </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> colonnes</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="s2">   Colonnes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="si">}</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="k">return</span> <span class="n">contexte</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_creer_dataframes_valides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableaux_charges</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">        Génère une liste de DataFrames valides à partir d&#39;une liste de tableaux</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">        fournis en entrée. Chaque DataFrame passe par un processus de nettoyage,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        puis est complété avec des méta-données provenant des tableaux d&#39;origine.</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">        Si une erreur survient lors de la création ou du nettoyage d&#39;un DataFrame,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">        l&#39;erreur est enregistrée mais l&#39;exécution continue pour les tableaux</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">        suivants.</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">        :param tableaux_charges: Liste de dictionnaires représentant les tableaux</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">            à convertir en DataFrames. Chaque dictionnaire doit inclure des</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">            informations comme le titre contextuel, le fichier source, et le nom</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">            de la feuille (si applicables).</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">        :type tableaux_charges: list[dict]</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        :param state: Dictionnaire ou objet contenant l&#39;état actuel, utilisé</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">            pour enregistrer des informations concernant les erreurs</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">            ou événements lors du processus.</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">        :return: Liste de pandas DataFrames valides, accompagnés</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">            de leurs méta-données.</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        :rtype: list[pandas.DataFrame]</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tableau</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tableaux_charges</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">pandas_agent</span><span class="o">.</span><span class="n">creer_dataframe_propre</span><span class="p">(</span><span class="n">tableau</span><span class="p">)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                    <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                        <span class="s1">&#39;titre&#39;</span><span class="p">:</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titre_contextuel&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Tableau </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fichier_source&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                        <span class="s1">&#39;feuille&#39;</span><span class="p">:</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nom_feuille&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                    <span class="p">})</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                    <span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Création DataFrame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="k">return</span> <span class="n">dataframes</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_creer_csvs_pour_gemini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        Génère un ensemble de fichiers CSV à partir d&#39;une liste de DataFrames fournie.</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">        Chaque DataFrame valide (non vide et non nul) est converti en fichier CSV et nommé</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">        de manière incrémentale. Retourne une liste des noms de fichiers CSV créés. En cas</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">        d&#39;erreur, un message est enregistré dans le journal.</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        :param dataframes: Liste de pandas.DataFrame à convertir en fichiers CSV</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        :param state: État actuel du programme, utilisé pour consigner les erreurs dans le journal</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">        :return: Liste des chemins des fichiers CSV générés</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        :rtype: list</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">fichiers_csv</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataframes</span><span class="p">):</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                    <span class="n">nom_fichier</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;df</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_analysis.csv&#39;</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">nom_fichier</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                    <span class="n">fichiers_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nom_fichier</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur création CSV: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="k">return</span> <span class="n">fichiers_csv</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_upload_fichier_to_gemini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fichiers_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">        Télécharge une liste de fichiers CSV vers Gemini via l&#39;API.</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        Cette méthode reçoit une liste de fichiers CSV, les télécharge vers la plateforme</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        Gemini à l&#39;aide de son API, et retourne les fichiers téléchargés ainsi que</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">        le client utilisé pour l&#39;opération. En cas d&#39;échec, une exception est levée</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">        et consignée dans les journaux d&#39;erreur.</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        :param fichiers_csv: Liste des fichiers CSV à télécharger.</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">        :type fichiers_csv: list[str]</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">        :param state: État ou contexte lié au processus actuel utilisé pour journaliser</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">            des erreurs.</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        :type state: Any</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        :return: Une liste des fichiers téléchargés et le client utilisé pour l&#39;opération.</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        :rtype: tuple[list[object], genai.Client]</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        :raises Exception: Si une erreur survient lors du téléchargement des fichiers.</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">genai</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">fichiers_gemini</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="k">for</span> <span class="n">fichier_csv</span> <span class="ow">in</span> <span class="n">fichiers_csv</span><span class="p">:</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                <span class="n">fichier_uploade</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">fichier_csv</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="n">fichiers_gemini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fichier_uploade</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur upload </span><span class="si">{</span><span class="n">fichier_csv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                <span class="k">raise</span> <span class="n">e</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_nettoyer_csvs_temporaires</span><span class="p">(</span><span class="n">fichiers_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="k">return</span> <span class="n">fichiers_gemini</span><span class="p">,</span> <span class="n">client</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_nettoyer_fichiers_gemini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fichiers_gemini</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        Nettoie une liste de fichiers Gemini en supprimant chacun d&#39;entre eux via le client spécifié.</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">        En cas d&#39;erreur lors de la suppression d&#39;un fichier, l&#39;erreur est enregistrée à l&#39;aide</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        du système de journalisation du chatbot.</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        :param fichiers_gemini: Liste des fichiers Gemini à supprimer.</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">        :param client: Instance du client utilisé pour la suppression des fichiers.</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        :param state: Objet représentant l&#39;état à utiliser pour enregistrer les erreurs.</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        :return: Aucun.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="k">for</span> <span class="n">fichier</span> <span class="ow">in</span> <span class="n">fichiers_gemini</span><span class="p">:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>                <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fichier</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur suppression Gemini: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_nettoyer_csvs_temporaires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fichiers_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">        Supprime les fichiers CSV temporaires spécifiés.</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        Cette méthode parcourt une liste de fichiers CSV et tente de les supprimer s&#39;ils</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        existent. En cas d&#39;erreur lors de la suppression, un message d&#39;erreur est</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">        enregistré grâce à la méthode `_log_error` de l&#39;objet chatbot. Cette méthode est</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        utile pour nettoyer les fichiers temporaires inutilisés après leur traitement.</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        :param fichiers_csv: Une liste contenant les chemins des fichiers CSV à supprimer.</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        :type fichiers_csv: list[str]</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        :param state: État ou contexte utilisé pour enregistrer les erreurs pendant la suppression.</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        :type state: Any</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        :return: Cette fonction ne renvoie aucune valeur.</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">        :rtype: None</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="k">for</span> <span class="n">fichier</span> <span class="ow">in</span> <span class="n">fichiers_csv</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fichier</span><span class="p">):</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fichier</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur suppression </span><span class="si">{</span><span class="n">fichier</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_gemini_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        Exécute un appel à l&#39;API Gemini avec des tentatives automatiques en cas de</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">        défaillances. Cette méthode effectue un maximum de `max_retries` tentatives</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        avant de lever une exception en cas d&#39;échec.</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">        Les délais entre les tentatives augmentent de manière exponentielle, suivant</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">        la formule 2 ** attempt.</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">        :param client: Client utilisé pour interagir avec l&#39;API Gemini.</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        :type client: object</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">        :param content: Contenu à envoyer dans la requête pour la génération.</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">        :type content: list ou str</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        :param state: État ou contexte associé à la génération.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        :type state: dict</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        :param max_retries: Nombre maximum de tentatives autorisées en cas d&#39;échec.</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        Valeur par défaut : 3.</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        :type max_retries: int</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        :return: La réponse générée par l&#39;API Gemini si réussie.</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">        :rtype: object</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        :raises Exception: Si tous les essais échouent ou si la réponse est invalide.</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-2.5-pro&quot;</span><span class="p">,</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                    <span class="n">contents</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                    <span class="n">config</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">GenerateContentConfig</span><span class="p">(</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>                        <span class="n">candidate_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                        <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                        <span class="n">thinking_config</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">ThinkingConfig</span><span class="p">(</span><span class="n">include_thoughts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>                    <span class="p">)</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                <span class="p">)</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                    <span class="k">return</span> <span class="n">response</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Réponse Gemini invalide&quot;</span><span class="p">)</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                    <span class="k">continue</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                    <span class="k">raise</span> <span class="n">e</span>
</span></pre></div>


            </section>
                <section id="AnalyzerAgentUnified">
                            <input id="AnalyzerAgentUnified-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AnalyzerAgentUnified</span>:

                <label class="view-source-button" for="AnalyzerAgentUnified-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AnalyzerAgentUnified"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AnalyzerAgentUnified-15"><a href="#AnalyzerAgentUnified-15"><span class="linenos">  15</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AnalyzerAgentUnified</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-16"><a href="#AnalyzerAgentUnified-16"><span class="linenos">  16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-17"><a href="#AnalyzerAgentUnified-17"><span class="linenos">  17</span></a>
</span><span id="AnalyzerAgentUnified-18"><a href="#AnalyzerAgentUnified-18"><span class="linenos">  18</span></a><span class="sd">    La classe AnalyzerAgentUnified est responsable d&#39;exécuter des tâches d&#39;analyse complexes sur des données Excel</span>
</span><span id="AnalyzerAgentUnified-19"><a href="#AnalyzerAgentUnified-19"><span class="linenos">  19</span></a><span class="sd">    et PDF en utilisant des modèles d&#39;IA et des outils d&#39;automatisation. Elle gère également la communication avec</span>
</span><span id="AnalyzerAgentUnified-20"><a href="#AnalyzerAgentUnified-20"><span class="linenos">  20</span></a><span class="sd">    un chatbot et garantit une analyse robuste avec des étapes définies de traitement des données.</span>
</span><span id="AnalyzerAgentUnified-21"><a href="#AnalyzerAgentUnified-21"><span class="linenos">  21</span></a>
</span><span id="AnalyzerAgentUnified-22"><a href="#AnalyzerAgentUnified-22"><span class="linenos">  22</span></a><span class="sd">    :ivar gemini_model: Référence au modèle Gemini utilisé pour les opérations d&#39;analyse.</span>
</span><span id="AnalyzerAgentUnified-23"><a href="#AnalyzerAgentUnified-23"><span class="linenos">  23</span></a><span class="sd">    :ivar chatbot: Instance de chatbot utilisée pour la journalisation et les interactions avec l&#39;utilisateur.</span>
</span><span id="AnalyzerAgentUnified-24"><a href="#AnalyzerAgentUnified-24"><span class="linenos">  24</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-25"><a href="#AnalyzerAgentUnified-25"><span class="linenos">  25</span></a>
</span><span id="AnalyzerAgentUnified-26"><a href="#AnalyzerAgentUnified-26"><span class="linenos">  26</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gemini_model</span><span class="p">,</span> <span class="n">chatbot_instance</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-27"><a href="#AnalyzerAgentUnified-27"><span class="linenos">  27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gemini_model</span> <span class="o">=</span> <span class="n">gemini_model</span>
</span><span id="AnalyzerAgentUnified-28"><a href="#AnalyzerAgentUnified-28"><span class="linenos">  28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span> <span class="o">=</span> <span class="n">chatbot_instance</span>
</span><span id="AnalyzerAgentUnified-29"><a href="#AnalyzerAgentUnified-29"><span class="linenos">  29</span></a>
</span><span id="AnalyzerAgentUnified-30"><a href="#AnalyzerAgentUnified-30"><span class="linenos">  30</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-31"><a href="#AnalyzerAgentUnified-31"><span class="linenos">  31</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-32"><a href="#AnalyzerAgentUnified-32"><span class="linenos">  32</span></a><span class="sd">        Exécute une analyse sur l&#39;état actuel du chatbot et retourne un nouvel état</span>
</span><span id="AnalyzerAgentUnified-33"><a href="#AnalyzerAgentUnified-33"><span class="linenos">  33</span></a><span class="sd">        après traitement par l&#39;agent analyseur unifié.</span>
</span><span id="AnalyzerAgentUnified-34"><a href="#AnalyzerAgentUnified-34"><span class="linenos">  34</span></a>
</span><span id="AnalyzerAgentUnified-35"><a href="#AnalyzerAgentUnified-35"><span class="linenos">  35</span></a><span class="sd">        Le comportement de cette méthode dépend de la logique d&#39;analyse définie</span>
</span><span id="AnalyzerAgentUnified-36"><a href="#AnalyzerAgentUnified-36"><span class="linenos">  36</span></a><span class="sd">        par l&#39;agent analyseur unifié. Elle prend en entrée l&#39;état actuel du chatbot et</span>
</span><span id="AnalyzerAgentUnified-37"><a href="#AnalyzerAgentUnified-37"><span class="linenos">  37</span></a><span class="sd">        le traite pour retourner un état mis à jour.</span>
</span><span id="AnalyzerAgentUnified-38"><a href="#AnalyzerAgentUnified-38"><span class="linenos">  38</span></a>
</span><span id="AnalyzerAgentUnified-39"><a href="#AnalyzerAgentUnified-39"><span class="linenos">  39</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot à traiter.</span>
</span><span id="AnalyzerAgentUnified-40"><a href="#AnalyzerAgentUnified-40"><span class="linenos">  40</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-41"><a href="#AnalyzerAgentUnified-41"><span class="linenos">  41</span></a><span class="sd">        :return: Le nouvel état du chatbot après traitement par l&#39;agent analyseur unifié.</span>
</span><span id="AnalyzerAgentUnified-42"><a href="#AnalyzerAgentUnified-42"><span class="linenos">  42</span></a><span class="sd">        :rtype: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-43"><a href="#AnalyzerAgentUnified-43"><span class="linenos">  43</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-44"><a href="#AnalyzerAgentUnified-44"><span class="linenos">  44</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_analyseur_unifie</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-45"><a href="#AnalyzerAgentUnified-45"><span class="linenos">  45</span></a>
</span><span id="AnalyzerAgentUnified-46"><a href="#AnalyzerAgentUnified-46"><span class="linenos">  46</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">agent_analyseur_unifie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-47"><a href="#AnalyzerAgentUnified-47"><span class="linenos">  47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-48"><a href="#AnalyzerAgentUnified-48"><span class="linenos">  48</span></a><span class="sd">        Analyse et traitement unifiés des documents Excel et PDF basés sur l&#39;état actuel</span>
</span><span id="AnalyzerAgentUnified-49"><a href="#AnalyzerAgentUnified-49"><span class="linenos">  49</span></a><span class="sd">        du chatbot. Ce processus intègre l&#39;historique de l&#39;utilisateur et finalise l&#39;état</span>
</span><span id="AnalyzerAgentUnified-50"><a href="#AnalyzerAgentUnified-50"><span class="linenos">  50</span></a><span class="sd">        après traitement des documents.</span>
</span><span id="AnalyzerAgentUnified-51"><a href="#AnalyzerAgentUnified-51"><span class="linenos">  51</span></a>
</span><span id="AnalyzerAgentUnified-52"><a href="#AnalyzerAgentUnified-52"><span class="linenos">  52</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot, encapsulant les données nécessaires au</span>
</span><span id="AnalyzerAgentUnified-53"><a href="#AnalyzerAgentUnified-53"><span class="linenos">  53</span></a><span class="sd">            traitement et à l&#39;analyse des documents.</span>
</span><span id="AnalyzerAgentUnified-54"><a href="#AnalyzerAgentUnified-54"><span class="linenos">  54</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-55"><a href="#AnalyzerAgentUnified-55"><span class="linenos">  55</span></a><span class="sd">        :return: L&#39;état mis à jour du chatbot après l&#39;exécution complète des analyses</span>
</span><span id="AnalyzerAgentUnified-56"><a href="#AnalyzerAgentUnified-56"><span class="linenos">  56</span></a><span class="sd">            Excel et PDF.</span>
</span><span id="AnalyzerAgentUnified-57"><a href="#AnalyzerAgentUnified-57"><span class="linenos">  57</span></a><span class="sd">        :rtype: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-58"><a href="#AnalyzerAgentUnified-58"><span class="linenos">  58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-59"><a href="#AnalyzerAgentUnified-59"><span class="linenos">  59</span></a>
</span><span id="AnalyzerAgentUnified-60"><a href="#AnalyzerAgentUnified-60"><span class="linenos">  60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Agent Analyseur Unifié: Début de l&#39;analyse Excel + PDF&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-61"><a href="#AnalyzerAgentUnified-61"><span class="linenos">  61</span></a>        <span class="n">session_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-62"><a href="#AnalyzerAgentUnified-62"><span class="linenos">  62</span></a>
</span><span id="AnalyzerAgentUnified-63"><a href="#AnalyzerAgentUnified-63"><span class="linenos">  63</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-64"><a href="#AnalyzerAgentUnified-64"><span class="linenos">  64</span></a>            <span class="n">_send_to_frontend</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;Agent Analyseur Unifié: Traitement Excel + PDF...&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-65"><a href="#AnalyzerAgentUnified-65"><span class="linenos">  65</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-66"><a href="#AnalyzerAgentUnified-66"><span class="linenos">  66</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Envoi frontend échoué: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-67"><a href="#AnalyzerAgentUnified-67"><span class="linenos">  67</span></a>
</span><span id="AnalyzerAgentUnified-68"><a href="#AnalyzerAgentUnified-68"><span class="linenos">  68</span></a>        <span class="c1"># Récupérer les informations utilisateur</span>
</span><span id="AnalyzerAgentUnified-69"><a href="#AnalyzerAgentUnified-69"><span class="linenos">  69</span></a>        <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_user_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-70"><a href="#AnalyzerAgentUnified-70"><span class="linenos">  70</span></a>
</span><span id="AnalyzerAgentUnified-71"><a href="#AnalyzerAgentUnified-71"><span class="linenos">  71</span></a>        <span class="c1"># Récupérer l&#39;historique utilisateur</span>
</span><span id="AnalyzerAgentUnified-72"><a href="#AnalyzerAgentUnified-72"><span class="linenos">  72</span></a>        <span class="n">historique_contexte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-73"><a href="#AnalyzerAgentUnified-73"><span class="linenos">  73</span></a>
</span><span id="AnalyzerAgentUnified-74"><a href="#AnalyzerAgentUnified-74"><span class="linenos">  74</span></a>        <span class="c1"># ========== PARTIE 1: ANALYSE EXCEL ==========</span>
</span><span id="AnalyzerAgentUnified-75"><a href="#AnalyzerAgentUnified-75"><span class="linenos">  75</span></a>        <span class="n">excel_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_excel_documents</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-76"><a href="#AnalyzerAgentUnified-76"><span class="linenos">  76</span></a>
</span><span id="AnalyzerAgentUnified-77"><a href="#AnalyzerAgentUnified-77"><span class="linenos">  77</span></a>        <span class="c1"># ========== PARTIE 2: ANALYSE PDF  ==========</span>
</span><span id="AnalyzerAgentUnified-78"><a href="#AnalyzerAgentUnified-78"><span class="linenos">  78</span></a>        <span class="n">pdf_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_pdf_documents</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-79"><a href="#AnalyzerAgentUnified-79"><span class="linenos">  79</span></a>
</span><span id="AnalyzerAgentUnified-80"><a href="#AnalyzerAgentUnified-80"><span class="linenos">  80</span></a>        <span class="c1"># ========== PARTIE 3: ÉTAT FINAL ==========</span>
</span><span id="AnalyzerAgentUnified-81"><a href="#AnalyzerAgentUnified-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_analysis_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">excel_processed</span><span class="p">,</span> <span class="n">pdf_processed</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-82"><a href="#AnalyzerAgentUnified-82"><span class="linenos">  82</span></a>
</span><span id="AnalyzerAgentUnified-83"><a href="#AnalyzerAgentUnified-83"><span class="linenos">  83</span></a>        <span class="k">return</span> <span class="n">state</span>
</span><span id="AnalyzerAgentUnified-84"><a href="#AnalyzerAgentUnified-84"><span class="linenos">  84</span></a>
</span><span id="AnalyzerAgentUnified-85"><a href="#AnalyzerAgentUnified-85"><span class="linenos">  85</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_excel_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-86"><a href="#AnalyzerAgentUnified-86"><span class="linenos">  86</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-87"><a href="#AnalyzerAgentUnified-87"><span class="linenos">  87</span></a><span class="sd">        Analyse et traite les documents Excel pour identifier les données valides, les traiter et</span>
</span><span id="AnalyzerAgentUnified-88"><a href="#AnalyzerAgentUnified-88"><span class="linenos">  88</span></a><span class="sd">        préparer une réponse basée sur leur contenu.</span>
</span><span id="AnalyzerAgentUnified-89"><a href="#AnalyzerAgentUnified-89"><span class="linenos">  89</span></a>
</span><span id="AnalyzerAgentUnified-90"><a href="#AnalyzerAgentUnified-90"><span class="linenos">  90</span></a><span class="sd">        Cette méthode prend en charge plusieurs étapes, incluant la création des DataFrames à partir</span>
</span><span id="AnalyzerAgentUnified-91"><a href="#AnalyzerAgentUnified-91"><span class="linenos">  91</span></a><span class="sd">        des fichiers Excel, la préparation du contexte pour traitement, la gestion des erreurs durant</span>
</span><span id="AnalyzerAgentUnified-92"><a href="#AnalyzerAgentUnified-92"><span class="linenos">  92</span></a><span class="sd">        les processus d&#39;analyse, et l&#39;envoi des données pour une analyse approfondie via un système</span>
</span><span id="AnalyzerAgentUnified-93"><a href="#AnalyzerAgentUnified-93"><span class="linenos">  93</span></a><span class="sd">        externe. Une fois analysées, les données retournées peuvent être traitées et interprétées pour</span>
</span><span id="AnalyzerAgentUnified-94"><a href="#AnalyzerAgentUnified-94"><span class="linenos">  94</span></a><span class="sd">        en extraire les informations pertinentes.</span>
</span><span id="AnalyzerAgentUnified-95"><a href="#AnalyzerAgentUnified-95"><span class="linenos">  95</span></a>
</span><span id="AnalyzerAgentUnified-96"><a href="#AnalyzerAgentUnified-96"><span class="linenos">  96</span></a><span class="sd">        :param state: Instance d&#39;état contenant les informations de la session en cours.</span>
</span><span id="AnalyzerAgentUnified-97"><a href="#AnalyzerAgentUnified-97"><span class="linenos">  97</span></a><span class="sd">        :param historique_contexte: Historique contextuel pour enrichir le prompt d&#39;analyse.</span>
</span><span id="AnalyzerAgentUnified-98"><a href="#AnalyzerAgentUnified-98"><span class="linenos">  98</span></a><span class="sd">        :return: Un booléen indiquant si l&#39;analyse des documents Excel a été effectuée avec succès.</span>
</span><span id="AnalyzerAgentUnified-99"><a href="#AnalyzerAgentUnified-99"><span class="linenos">  99</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-100"><a href="#AnalyzerAgentUnified-100"><span class="linenos"> 100</span></a>
</span><span id="AnalyzerAgentUnified-101"><a href="#AnalyzerAgentUnified-101"><span class="linenos"> 101</span></a>        <span class="c1"># Vérifier s&#39;il y a des Excel à traiter</span>
</span><span id="AnalyzerAgentUnified-102"><a href="#AnalyzerAgentUnified-102"><span class="linenos"> 102</span></a>        <span class="n">tableaux_pour_upload</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tableaux_pour_upload&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="AnalyzerAgentUnified-103"><a href="#AnalyzerAgentUnified-103"><span class="linenos"> 103</span></a>
</span><span id="AnalyzerAgentUnified-104"><a href="#AnalyzerAgentUnified-104"><span class="linenos"> 104</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tableaux_pour_upload</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-105"><a href="#AnalyzerAgentUnified-105"><span class="linenos"> 105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Aucun tableau Excel à analyser&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-106"><a href="#AnalyzerAgentUnified-106"><span class="linenos"> 106</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;excel_empty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-107"><a href="#AnalyzerAgentUnified-107"><span class="linenos"> 107</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-108"><a href="#AnalyzerAgentUnified-108"><span class="linenos"> 108</span></a>
</span><span id="AnalyzerAgentUnified-109"><a href="#AnalyzerAgentUnified-109"><span class="linenos"> 109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyse de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tableaux_pour_upload</span><span class="p">)</span><span class="si">}</span><span class="s2"> tableaux Excel&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-110"><a href="#AnalyzerAgentUnified-110"><span class="linenos"> 110</span></a>
</span><span id="AnalyzerAgentUnified-111"><a href="#AnalyzerAgentUnified-111"><span class="linenos"> 111</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-112"><a href="#AnalyzerAgentUnified-112"><span class="linenos"> 112</span></a>            <span class="c1"># Création des DataFrames avec validation</span>
</span><span id="AnalyzerAgentUnified-113"><a href="#AnalyzerAgentUnified-113"><span class="linenos"> 113</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creer_dataframes_valides</span><span class="p">(</span><span class="n">tableaux_pour_upload</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-114"><a href="#AnalyzerAgentUnified-114"><span class="linenos"> 114</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">]:</span>
</span><span id="AnalyzerAgentUnified-115"><a href="#AnalyzerAgentUnified-115"><span class="linenos"> 115</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-116"><a href="#AnalyzerAgentUnified-116"><span class="linenos"> 116</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Impossible de traiter les données Excel trouvées.&quot;</span>
</span><span id="AnalyzerAgentUnified-117"><a href="#AnalyzerAgentUnified-117"><span class="linenos"> 117</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-118"><a href="#AnalyzerAgentUnified-118"><span class="linenos"> 118</span></a>
</span><span id="AnalyzerAgentUnified-119"><a href="#AnalyzerAgentUnified-119"><span class="linenos"> 119</span></a>
</span><span id="AnalyzerAgentUnified-120"><a href="#AnalyzerAgentUnified-120"><span class="linenos"> 120</span></a>            <span class="n">contexte_complet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preparer_contexte_excel_avec_metadata</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-121"><a href="#AnalyzerAgentUnified-121"><span class="linenos"> 121</span></a>
</span><span id="AnalyzerAgentUnified-122"><a href="#AnalyzerAgentUnified-122"><span class="linenos"> 122</span></a>            <span class="c1"># Variables pour le nettoyage</span>
</span><span id="AnalyzerAgentUnified-123"><a href="#AnalyzerAgentUnified-123"><span class="linenos"> 123</span></a>            <span class="n">fichier_gemini</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-124"><a href="#AnalyzerAgentUnified-124"><span class="linenos"> 124</span></a>            <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-125"><a href="#AnalyzerAgentUnified-125"><span class="linenos"> 125</span></a>
</span><span id="AnalyzerAgentUnified-126"><a href="#AnalyzerAgentUnified-126"><span class="linenos"> 126</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-127"><a href="#AnalyzerAgentUnified-127"><span class="linenos"> 127</span></a>                <span class="n">fichier_csv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creer_csvs_pour_gemini</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">],</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-128"><a href="#AnalyzerAgentUnified-128"><span class="linenos"> 128</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">fichier_csv</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-129"><a href="#AnalyzerAgentUnified-129"><span class="linenos"> 129</span></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Aucun fichier CSV créé&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-130"><a href="#AnalyzerAgentUnified-130"><span class="linenos"> 130</span></a>
</span><span id="AnalyzerAgentUnified-131"><a href="#AnalyzerAgentUnified-131"><span class="linenos"> 131</span></a>                <span class="n">fichier_gemini</span><span class="p">,</span> <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_fichier_to_gemini</span><span class="p">(</span><span class="n">fichier_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-132"><a href="#AnalyzerAgentUnified-132"><span class="linenos"> 132</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fichiers_gemini&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fichier_gemini</span>
</span><span id="AnalyzerAgentUnified-133"><a href="#AnalyzerAgentUnified-133"><span class="linenos"> 133</span></a>
</span><span id="AnalyzerAgentUnified-134"><a href="#AnalyzerAgentUnified-134"><span class="linenos"> 134</span></a>                <span class="n">prompt_excel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creer_prompt_excel_unifie</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">contexte_complet</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-135"><a href="#AnalyzerAgentUnified-135"><span class="linenos"> 135</span></a>
</span><span id="AnalyzerAgentUnified-136"><a href="#AnalyzerAgentUnified-136"><span class="linenos"> 136</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-137"><a href="#AnalyzerAgentUnified-137"><span class="linenos"> 137</span></a>                    <span class="n">_send_to_frontend</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">),</span> <span class="s2">&quot;Génération de réponse Excel...&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-138"><a href="#AnalyzerAgentUnified-138"><span class="linenos"> 138</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-139"><a href="#AnalyzerAgentUnified-139"><span class="linenos"> 139</span></a>                    <span class="k">pass</span>
</span><span id="AnalyzerAgentUnified-140"><a href="#AnalyzerAgentUnified-140"><span class="linenos"> 140</span></a>
</span><span id="AnalyzerAgentUnified-141"><a href="#AnalyzerAgentUnified-141"><span class="linenos"> 141</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt_excel</span><span class="p">]</span>
</span><span id="AnalyzerAgentUnified-142"><a href="#AnalyzerAgentUnified-142"><span class="linenos"> 142</span></a>                <span class="n">content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fichier_gemini</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-143"><a href="#AnalyzerAgentUnified-143"><span class="linenos"> 143</span></a>
</span><span id="AnalyzerAgentUnified-144"><a href="#AnalyzerAgentUnified-144"><span class="linenos"> 144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PROMPT EXCEL: </span><span class="si">{</span><span class="n">prompt_excel</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-145"><a href="#AnalyzerAgentUnified-145"><span class="linenos"> 145</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; FICHIERS GEMINI: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fichier_gemini</span><span class="p">)</span><span class="si">}</span><span class="s2"> fichiers&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-146"><a href="#AnalyzerAgentUnified-146"><span class="linenos"> 146</span></a>
</span><span id="AnalyzerAgentUnified-147"><a href="#AnalyzerAgentUnified-147"><span class="linenos"> 147</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_gemini_with_retry</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-148"><a href="#AnalyzerAgentUnified-148"><span class="linenos"> 148</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; FINISH_REASON: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">finish_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-149"><a href="#AnalyzerAgentUnified-149"><span class="linenos"> 149</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; HAS PARTS: </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;parts&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-150"><a href="#AnalyzerAgentUnified-150"><span class="linenos"> 150</span></a>
</span><span id="AnalyzerAgentUnified-151"><a href="#AnalyzerAgentUnified-151"><span class="linenos"> 151</span></a>                <span class="n">answer_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_contenu_gemini_robuste</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-152"><a href="#AnalyzerAgentUnified-152"><span class="linenos"> 152</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; REPONSE EXTRAITE: </span><span class="si">{</span><span class="n">answer_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-153"><a href="#AnalyzerAgentUnified-153"><span class="linenos"> 153</span></a>
</span><span id="AnalyzerAgentUnified-154"><a href="#AnalyzerAgentUnified-154"><span class="linenos"> 154</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_text</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-155"><a href="#AnalyzerAgentUnified-155"><span class="linenos"> 155</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_excel_fallback</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-156"><a href="#AnalyzerAgentUnified-156"><span class="linenos"> 156</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-157"><a href="#AnalyzerAgentUnified-157"><span class="linenos"> 157</span></a>
</span><span id="AnalyzerAgentUnified-158"><a href="#AnalyzerAgentUnified-158"><span class="linenos"> 158</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_analyseur_brute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_text</span>
</span><span id="AnalyzerAgentUnified-159"><a href="#AnalyzerAgentUnified-159"><span class="linenos"> 159</span></a>
</span><span id="AnalyzerAgentUnified-160"><a href="#AnalyzerAgentUnified-160"><span class="linenos"> 160</span></a>                <span class="n">calculs_detected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_excel_response_avec_garantie_calculs</span><span class="p">(</span><span class="n">answer_text</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-161"><a href="#AnalyzerAgentUnified-161"><span class="linenos"> 161</span></a>                                                                                    <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-162"><a href="#AnalyzerAgentUnified-162"><span class="linenos"> 162</span></a>
</span><span id="AnalyzerAgentUnified-163"><a href="#AnalyzerAgentUnified-163"><span class="linenos"> 163</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">calculs_detected</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-164"><a href="#AnalyzerAgentUnified-164"><span class="linenos"> 164</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_excel_fallback</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-165"><a href="#AnalyzerAgentUnified-165"><span class="linenos"> 165</span></a>
</span><span id="AnalyzerAgentUnified-166"><a href="#AnalyzerAgentUnified-166"><span class="linenos"> 166</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyse Excel terminée - Calculs nécessaires: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-167"><a href="#AnalyzerAgentUnified-167"><span class="linenos"> 167</span></a>                                  <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-168"><a href="#AnalyzerAgentUnified-168"><span class="linenos"> 168</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-169"><a href="#AnalyzerAgentUnified-169"><span class="linenos"> 169</span></a>
</span><span id="AnalyzerAgentUnified-170"><a href="#AnalyzerAgentUnified-170"><span class="linenos"> 170</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-171"><a href="#AnalyzerAgentUnified-171"><span class="linenos"> 171</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur analyse Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-172"><a href="#AnalyzerAgentUnified-172"><span class="linenos"> 172</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_excel_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-173"><a href="#AnalyzerAgentUnified-173"><span class="linenos"> 173</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-174"><a href="#AnalyzerAgentUnified-174"><span class="linenos"> 174</span></a>
</span><span id="AnalyzerAgentUnified-175"><a href="#AnalyzerAgentUnified-175"><span class="linenos"> 175</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-176"><a href="#AnalyzerAgentUnified-176"><span class="linenos"> 176</span></a>                <span class="c1"># Nettoyage garanti</span>
</span><span id="AnalyzerAgentUnified-177"><a href="#AnalyzerAgentUnified-177"><span class="linenos"> 177</span></a>                <span class="k">if</span> <span class="n">fichier_gemini</span> <span class="ow">and</span> <span class="n">client</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-178"><a href="#AnalyzerAgentUnified-178"><span class="linenos"> 178</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-179"><a href="#AnalyzerAgentUnified-179"><span class="linenos"> 179</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_nettoyer_fichiers_gemini</span><span class="p">(</span><span class="n">fichier_gemini</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-180"><a href="#AnalyzerAgentUnified-180"><span class="linenos"> 180</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-181"><a href="#AnalyzerAgentUnified-181"><span class="linenos"> 181</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur nettoyage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-182"><a href="#AnalyzerAgentUnified-182"><span class="linenos"> 182</span></a>
</span><span id="AnalyzerAgentUnified-183"><a href="#AnalyzerAgentUnified-183"><span class="linenos"> 183</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-184"><a href="#AnalyzerAgentUnified-184"><span class="linenos"> 184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur création DataFrames Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-185"><a href="#AnalyzerAgentUnified-185"><span class="linenos"> 185</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-186"><a href="#AnalyzerAgentUnified-186"><span class="linenos"> 186</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Erreur lors du traitement des données Excel.&quot;</span>
</span><span id="AnalyzerAgentUnified-187"><a href="#AnalyzerAgentUnified-187"><span class="linenos"> 187</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-188"><a href="#AnalyzerAgentUnified-188"><span class="linenos"> 188</span></a>
</span><span id="AnalyzerAgentUnified-189"><a href="#AnalyzerAgentUnified-189"><span class="linenos"> 189</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_pdf_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-190"><a href="#AnalyzerAgentUnified-190"><span class="linenos"> 190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-191"><a href="#AnalyzerAgentUnified-191"><span class="linenos"> 191</span></a><span class="sd">        Analyse les documents PDF spécifiés dans l&#39;état du chatbot et génère des réponses</span>
</span><span id="AnalyzerAgentUnified-192"><a href="#AnalyzerAgentUnified-192"><span class="linenos"> 192</span></a><span class="sd">        en fonction de leur contenu en utilisant le service Gemini.</span>
</span><span id="AnalyzerAgentUnified-193"><a href="#AnalyzerAgentUnified-193"><span class="linenos"> 193</span></a>
</span><span id="AnalyzerAgentUnified-194"><a href="#AnalyzerAgentUnified-194"><span class="linenos"> 194</span></a><span class="sd">        Cette méthode vérifie d&#39;abord l&#39;existence des documents PDF à analyser. Les documents</span>
</span><span id="AnalyzerAgentUnified-195"><a href="#AnalyzerAgentUnified-195"><span class="linenos"> 195</span></a><span class="sd">        sont ensuite téléchargés sur le service Gemini pour une analyse approfondie selon une</span>
</span><span id="AnalyzerAgentUnified-196"><a href="#AnalyzerAgentUnified-196"><span class="linenos"> 196</span></a><span class="sd">        question fournie par l&#39;utilisateur. Si l&#39;analyse est réussie, la réponse correspondante</span>
</span><span id="AnalyzerAgentUnified-197"><a href="#AnalyzerAgentUnified-197"><span class="linenos"> 197</span></a><span class="sd">        et les sources des documents sont stockées dans l&#39;état. En cas d&#39;échec, aucune réponse</span>
</span><span id="AnalyzerAgentUnified-198"><a href="#AnalyzerAgentUnified-198"><span class="linenos"> 198</span></a><span class="sd">        n&#39;est générée.</span>
</span><span id="AnalyzerAgentUnified-199"><a href="#AnalyzerAgentUnified-199"><span class="linenos"> 199</span></a>
</span><span id="AnalyzerAgentUnified-200"><a href="#AnalyzerAgentUnified-200"><span class="linenos"> 200</span></a><span class="sd">        :param state: Un objet représentant l&#39;état actuel du chatbot, contenant des</span>
</span><span id="AnalyzerAgentUnified-201"><a href="#AnalyzerAgentUnified-201"><span class="linenos"> 201</span></a><span class="sd">                      informations nécessaires pour l&#39;analyse.</span>
</span><span id="AnalyzerAgentUnified-202"><a href="#AnalyzerAgentUnified-202"><span class="linenos"> 202</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-203"><a href="#AnalyzerAgentUnified-203"><span class="linenos"> 203</span></a><span class="sd">        :param historique_contexte: Une chaîne représentant l&#39;historique contextuel du</span>
</span><span id="AnalyzerAgentUnified-204"><a href="#AnalyzerAgentUnified-204"><span class="linenos"> 204</span></a><span class="sd">                                     chatbot durant l&#39;interaction.</span>
</span><span id="AnalyzerAgentUnified-205"><a href="#AnalyzerAgentUnified-205"><span class="linenos"> 205</span></a><span class="sd">        :type historique_contexte: str</span>
</span><span id="AnalyzerAgentUnified-206"><a href="#AnalyzerAgentUnified-206"><span class="linenos"> 206</span></a><span class="sd">        :return: Indique si l&#39;analyse des documents PDF a réussi ou échoué.</span>
</span><span id="AnalyzerAgentUnified-207"><a href="#AnalyzerAgentUnified-207"><span class="linenos"> 207</span></a><span class="sd">        :rtype: bool</span>
</span><span id="AnalyzerAgentUnified-208"><a href="#AnalyzerAgentUnified-208"><span class="linenos"> 208</span></a>
</span><span id="AnalyzerAgentUnified-209"><a href="#AnalyzerAgentUnified-209"><span class="linenos"> 209</span></a><span class="sd">        :raises Exception: Si une erreur inattendue survient lors de l&#39;analyse ou du</span>
</span><span id="AnalyzerAgentUnified-210"><a href="#AnalyzerAgentUnified-210"><span class="linenos"> 210</span></a><span class="sd">                           téléchargement des documents.</span>
</span><span id="AnalyzerAgentUnified-211"><a href="#AnalyzerAgentUnified-211"><span class="linenos"> 211</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-212"><a href="#AnalyzerAgentUnified-212"><span class="linenos"> 212</span></a>
</span><span id="AnalyzerAgentUnified-213"><a href="#AnalyzerAgentUnified-213"><span class="linenos"> 213</span></a>        <span class="n">pdfs_pour_upload</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdfs_pour_upload&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="AnalyzerAgentUnified-214"><a href="#AnalyzerAgentUnified-214"><span class="linenos"> 214</span></a>
</span><span id="AnalyzerAgentUnified-215"><a href="#AnalyzerAgentUnified-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdfs_pour_upload</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-216"><a href="#AnalyzerAgentUnified-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Aucun document PDF à analyser&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-217"><a href="#AnalyzerAgentUnified-217"><span class="linenos"> 217</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-218"><a href="#AnalyzerAgentUnified-218"><span class="linenos"> 218</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sources_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-219"><a href="#AnalyzerAgentUnified-219"><span class="linenos"> 219</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-220"><a href="#AnalyzerAgentUnified-220"><span class="linenos"> 220</span></a>
</span><span id="AnalyzerAgentUnified-221"><a href="#AnalyzerAgentUnified-221"><span class="linenos"> 221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DEBUG PDF: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pdfs_pour_upload</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDFs à analyser&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-222"><a href="#AnalyzerAgentUnified-222"><span class="linenos"> 222</span></a>
</span><span id="AnalyzerAgentUnified-223"><a href="#AnalyzerAgentUnified-223"><span class="linenos"> 223</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-224"><a href="#AnalyzerAgentUnified-224"><span class="linenos"> 224</span></a>            <span class="c1"># Upload des PDFs vers Gemini</span>
</span><span id="AnalyzerAgentUnified-225"><a href="#AnalyzerAgentUnified-225"><span class="linenos"> 225</span></a>            <span class="n">fichiers_pdf_gemini</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-226"><a href="#AnalyzerAgentUnified-226"><span class="linenos"> 226</span></a>            <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-227"><a href="#AnalyzerAgentUnified-227"><span class="linenos"> 227</span></a>
</span><span id="AnalyzerAgentUnified-228"><a href="#AnalyzerAgentUnified-228"><span class="linenos"> 228</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdf_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdfs_pour_upload</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-229"><a href="#AnalyzerAgentUnified-229"><span class="linenos"> 229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DEBUG PDF </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pdf_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-230"><a href="#AnalyzerAgentUnified-230"><span class="linenos"> 230</span></a>
</span><span id="AnalyzerAgentUnified-231"><a href="#AnalyzerAgentUnified-231"><span class="linenos"> 231</span></a>                <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">pdf_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdf_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pdf_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tableau_path&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-232"><a href="#AnalyzerAgentUnified-232"><span class="linenos"> 232</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF path: </span><span class="si">{</span><span class="n">pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-233"><a href="#AnalyzerAgentUnified-233"><span class="linenos"> 233</span></a>
</span><span id="AnalyzerAgentUnified-234"><a href="#AnalyzerAgentUnified-234"><span class="linenos"> 234</span></a>                <span class="k">if</span> <span class="n">pdf_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-235"><a href="#AnalyzerAgentUnified-235"><span class="linenos"> 235</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF existe: </span><span class="si">{</span><span class="n">pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-236"><a href="#AnalyzerAgentUnified-236"><span class="linenos"> 236</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-237"><a href="#AnalyzerAgentUnified-237"><span class="linenos"> 237</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-238"><a href="#AnalyzerAgentUnified-238"><span class="linenos"> 238</span></a>                            <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-239"><a href="#AnalyzerAgentUnified-239"><span class="linenos"> 239</span></a>                            <span class="n">client</span> <span class="o">=</span> <span class="n">genai</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-240"><a href="#AnalyzerAgentUnified-240"><span class="linenos"> 240</span></a>
</span><span id="AnalyzerAgentUnified-241"><a href="#AnalyzerAgentUnified-241"><span class="linenos"> 241</span></a>                        <span class="c1"># Upload du PDF vers Gemini</span>
</span><span id="AnalyzerAgentUnified-242"><a href="#AnalyzerAgentUnified-242"><span class="linenos"> 242</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Upload PDF vers Gemini...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-243"><a href="#AnalyzerAgentUnified-243"><span class="linenos"> 243</span></a>                        <span class="n">fichier_pdf</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">pdf_path</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-244"><a href="#AnalyzerAgentUnified-244"><span class="linenos"> 244</span></a>                        <span class="n">fichiers_pdf_gemini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fichier_pdf</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-245"><a href="#AnalyzerAgentUnified-245"><span class="linenos"> 245</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> uploadé: </span><span class="si">{</span><span class="n">fichier_pdf</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-246"><a href="#AnalyzerAgentUnified-246"><span class="linenos"> 246</span></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-247"><a href="#AnalyzerAgentUnified-247"><span class="linenos"> 247</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur upload PDF </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-248"><a href="#AnalyzerAgentUnified-248"><span class="linenos"> 248</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-249"><a href="#AnalyzerAgentUnified-249"><span class="linenos"> 249</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> inexistant: </span><span class="si">{</span><span class="n">pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-250"><a href="#AnalyzerAgentUnified-250"><span class="linenos"> 250</span></a>
</span><span id="AnalyzerAgentUnified-251"><a href="#AnalyzerAgentUnified-251"><span class="linenos"> 251</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">fichiers_pdf_gemini</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-252"><a href="#AnalyzerAgentUnified-252"><span class="linenos"> 252</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Aucun PDF uploadé avec succès&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-253"><a href="#AnalyzerAgentUnified-253"><span class="linenos"> 253</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-254"><a href="#AnalyzerAgentUnified-254"><span class="linenos"> 254</span></a>
</span><span id="AnalyzerAgentUnified-255"><a href="#AnalyzerAgentUnified-255"><span class="linenos"> 255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fichiers_pdf_gemini</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDFs uploadés, analyse...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-256"><a href="#AnalyzerAgentUnified-256"><span class="linenos"> 256</span></a>
</span><span id="AnalyzerAgentUnified-257"><a href="#AnalyzerAgentUnified-257"><span class="linenos"> 257</span></a>            <span class="c1"># Créer le prompt avec les PDFs uploadés</span>
</span><span id="AnalyzerAgentUnified-258"><a href="#AnalyzerAgentUnified-258"><span class="linenos"> 258</span></a>            <span class="n">prompt_pdf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Tu es un expert qui analyse le contenu COMPLET des documents PDF.</span>
</span><span id="AnalyzerAgentUnified-259"><a href="#AnalyzerAgentUnified-259"><span class="linenos"> 259</span></a>
</span><span id="AnalyzerAgentUnified-260"><a href="#AnalyzerAgentUnified-260"><span class="linenos"> 260</span></a><span class="s2">    QUESTION: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span>
</span><span id="AnalyzerAgentUnified-261"><a href="#AnalyzerAgentUnified-261"><span class="linenos"> 261</span></a>
</span><span id="AnalyzerAgentUnified-262"><a href="#AnalyzerAgentUnified-262"><span class="linenos"> 262</span></a><span class="s2">    INSTRUCTIONS:</span>
</span><span id="AnalyzerAgentUnified-263"><a href="#AnalyzerAgentUnified-263"><span class="linenos"> 263</span></a><span class="s2">    1. Lis attentivement le contenu de tous les PDFs fournis</span>
</span><span id="AnalyzerAgentUnified-264"><a href="#AnalyzerAgentUnified-264"><span class="linenos"> 264</span></a><span class="s2">    2. Réponds directement à la question avec les informations des PDFs</span>
</span><span id="AnalyzerAgentUnified-265"><a href="#AnalyzerAgentUnified-265"><span class="linenos"> 265</span></a><span class="s2">    3. Si les PDFs ne contiennent pas d&#39;info pertinente, dis-le clairement</span>
</span><span id="AnalyzerAgentUnified-266"><a href="#AnalyzerAgentUnified-266"><span class="linenos"> 266</span></a>
</span><span id="AnalyzerAgentUnified-267"><a href="#AnalyzerAgentUnified-267"><span class="linenos"> 267</span></a><span class="s2">    RÉPONSE:&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-268"><a href="#AnalyzerAgentUnified-268"><span class="linenos"> 268</span></a>
</span><span id="AnalyzerAgentUnified-269"><a href="#AnalyzerAgentUnified-269"><span class="linenos"> 269</span></a>            <span class="c1"># Appel Gemini avec les PDFs</span>
</span><span id="AnalyzerAgentUnified-270"><a href="#AnalyzerAgentUnified-270"><span class="linenos"> 270</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt_pdf</span><span class="p">]</span>
</span><span id="AnalyzerAgentUnified-271"><a href="#AnalyzerAgentUnified-271"><span class="linenos"> 271</span></a>            <span class="n">content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fichiers_pdf_gemini</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-272"><a href="#AnalyzerAgentUnified-272"><span class="linenos"> 272</span></a>
</span><span id="AnalyzerAgentUnified-273"><a href="#AnalyzerAgentUnified-273"><span class="linenos"> 273</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Appel Gemini avec PDFs...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-274"><a href="#AnalyzerAgentUnified-274"><span class="linenos"> 274</span></a>
</span><span id="AnalyzerAgentUnified-275"><a href="#AnalyzerAgentUnified-275"><span class="linenos"> 275</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
</span><span id="AnalyzerAgentUnified-276"><a href="#AnalyzerAgentUnified-276"><span class="linenos"> 276</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-2.5-pro&quot;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-277"><a href="#AnalyzerAgentUnified-277"><span class="linenos"> 277</span></a>                <span class="n">contents</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-278"><a href="#AnalyzerAgentUnified-278"><span class="linenos"> 278</span></a>                <span class="n">config</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">GenerateContentConfig</span><span class="p">(</span>
</span><span id="AnalyzerAgentUnified-279"><a href="#AnalyzerAgentUnified-279"><span class="linenos"> 279</span></a>                    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-280"><a href="#AnalyzerAgentUnified-280"><span class="linenos"> 280</span></a>                    <span class="n">candidate_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-281"><a href="#AnalyzerAgentUnified-281"><span class="linenos"> 281</span></a>                    <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">8192</span>
</span><span id="AnalyzerAgentUnified-282"><a href="#AnalyzerAgentUnified-282"><span class="linenos"> 282</span></a>                <span class="p">)</span>
</span><span id="AnalyzerAgentUnified-283"><a href="#AnalyzerAgentUnified-283"><span class="linenos"> 283</span></a>            <span class="p">)</span>
</span><span id="AnalyzerAgentUnified-284"><a href="#AnalyzerAgentUnified-284"><span class="linenos"> 284</span></a>
</span><span id="AnalyzerAgentUnified-285"><a href="#AnalyzerAgentUnified-285"><span class="linenos"> 285</span></a>            <span class="c1"># Extraction et stockage</span>
</span><span id="AnalyzerAgentUnified-286"><a href="#AnalyzerAgentUnified-286"><span class="linenos"> 286</span></a>            <span class="c1">#self.chatbot._log(f&quot;REPONSE GEMINI : {response}&quot;,state)</span>
</span><span id="AnalyzerAgentUnified-287"><a href="#AnalyzerAgentUnified-287"><span class="linenos"> 287</span></a>            <span class="n">answer_text_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_contenu_gemini_robuste</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-288"><a href="#AnalyzerAgentUnified-288"><span class="linenos"> 288</span></a>
</span><span id="AnalyzerAgentUnified-289"><a href="#AnalyzerAgentUnified-289"><span class="linenos"> 289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Réponse PDF: </span><span class="si">{</span><span class="n">answer_text_pdf</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">answer_text_pdf</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-290"><a href="#AnalyzerAgentUnified-290"><span class="linenos"> 290</span></a>
</span><span id="AnalyzerAgentUnified-291"><a href="#AnalyzerAgentUnified-291"><span class="linenos"> 291</span></a>            <span class="k">if</span> <span class="n">answer_text_pdf</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-292"><a href="#AnalyzerAgentUnified-292"><span class="linenos"> 292</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_text_pdf</span>
</span><span id="AnalyzerAgentUnified-293"><a href="#AnalyzerAgentUnified-293"><span class="linenos"> 293</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sources_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titre_contextuel&#39;</span><span class="p">,</span> <span class="s1">&#39;PDF&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">pdfs_pour_upload</span><span class="p">]</span>
</span><span id="AnalyzerAgentUnified-294"><a href="#AnalyzerAgentUnified-294"><span class="linenos"> 294</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyse PDF réussie&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-295"><a href="#AnalyzerAgentUnified-295"><span class="linenos"> 295</span></a>
</span><span id="AnalyzerAgentUnified-296"><a href="#AnalyzerAgentUnified-296"><span class="linenos"> 296</span></a>                <span class="c1"># Nettoyage Gemini</span>
</span><span id="AnalyzerAgentUnified-297"><a href="#AnalyzerAgentUnified-297"><span class="linenos"> 297</span></a>                <span class="k">for</span> <span class="n">fichier</span> <span class="ow">in</span> <span class="n">fichiers_pdf_gemini</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-298"><a href="#AnalyzerAgentUnified-298"><span class="linenos"> 298</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-299"><a href="#AnalyzerAgentUnified-299"><span class="linenos"> 299</span></a>                        <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fichier</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-300"><a href="#AnalyzerAgentUnified-300"><span class="linenos"> 300</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-301"><a href="#AnalyzerAgentUnified-301"><span class="linenos"> 301</span></a>                        <span class="k">pass</span>
</span><span id="AnalyzerAgentUnified-302"><a href="#AnalyzerAgentUnified-302"><span class="linenos"> 302</span></a>
</span><span id="AnalyzerAgentUnified-303"><a href="#AnalyzerAgentUnified-303"><span class="linenos"> 303</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-304"><a href="#AnalyzerAgentUnified-304"><span class="linenos"> 304</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-305"><a href="#AnalyzerAgentUnified-305"><span class="linenos"> 305</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Extraction réponse PDF échouée&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-306"><a href="#AnalyzerAgentUnified-306"><span class="linenos"> 306</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-307"><a href="#AnalyzerAgentUnified-307"><span class="linenos"> 307</span></a>
</span><span id="AnalyzerAgentUnified-308"><a href="#AnalyzerAgentUnified-308"><span class="linenos"> 308</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-309"><a href="#AnalyzerAgentUnified-309"><span class="linenos"> 309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Erreur analyse PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-310"><a href="#AnalyzerAgentUnified-310"><span class="linenos"> 310</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</span><span id="AnalyzerAgentUnified-311"><a href="#AnalyzerAgentUnified-311"><span class="linenos"> 311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traceback: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-312"><a href="#AnalyzerAgentUnified-312"><span class="linenos"> 312</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-313"><a href="#AnalyzerAgentUnified-313"><span class="linenos"> 313</span></a>
</span><span id="AnalyzerAgentUnified-314"><a href="#AnalyzerAgentUnified-314"><span class="linenos"> 314</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_excel_response_avec_garantie_calculs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer_text</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-315"><a href="#AnalyzerAgentUnified-315"><span class="linenos"> 315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-316"><a href="#AnalyzerAgentUnified-316"><span class="linenos"> 316</span></a><span class="sd">        Analyse et traite une réponse Excel fournie afin de déterminer si elle nécessite des</span>
</span><span id="AnalyzerAgentUnified-317"><a href="#AnalyzerAgentUnified-317"><span class="linenos"> 317</span></a><span class="sd">        calculs ou si elle contient une réponse directe. Si des calculs sont nécessaires,</span>
</span><span id="AnalyzerAgentUnified-318"><a href="#AnalyzerAgentUnified-318"><span class="linenos"> 318</span></a><span class="sd">        génère des étapes d&#39;instructions et un algorithme correspondant. En cas de réponse</span>
</span><span id="AnalyzerAgentUnified-319"><a href="#AnalyzerAgentUnified-319"><span class="linenos"> 319</span></a><span class="sd">        directe, extrait et retourne cette réponse. Garantit une analyse ou une réponse</span>
</span><span id="AnalyzerAgentUnified-320"><a href="#AnalyzerAgentUnified-320"><span class="linenos"> 320</span></a><span class="sd">        adéquate même en cas d&#39;erreur.</span>
</span><span id="AnalyzerAgentUnified-321"><a href="#AnalyzerAgentUnified-321"><span class="linenos"> 321</span></a>
</span><span id="AnalyzerAgentUnified-322"><a href="#AnalyzerAgentUnified-322"><span class="linenos"> 322</span></a><span class="sd">        :param answer_text: Texte de réponse à analyser et traiter</span>
</span><span id="AnalyzerAgentUnified-323"><a href="#AnalyzerAgentUnified-323"><span class="linenos"> 323</span></a><span class="sd">        :type answer_text: str</span>
</span><span id="AnalyzerAgentUnified-324"><a href="#AnalyzerAgentUnified-324"><span class="linenos"> 324</span></a><span class="sd">        :param state: Dictionnaire contenant l&#39;état courant, incluant la question, les résultats</span>
</span><span id="AnalyzerAgentUnified-325"><a href="#AnalyzerAgentUnified-325"><span class="linenos"> 325</span></a><span class="sd">                      intermédiaires et les données contextuelles</span>
</span><span id="AnalyzerAgentUnified-326"><a href="#AnalyzerAgentUnified-326"><span class="linenos"> 326</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-327"><a href="#AnalyzerAgentUnified-327"><span class="linenos"> 327</span></a><span class="sd">        :param historique_contexte: Historique des interactions ou contexte supplémentaire</span>
</span><span id="AnalyzerAgentUnified-328"><a href="#AnalyzerAgentUnified-328"><span class="linenos"> 328</span></a><span class="sd">        :type historique_contexte: list</span>
</span><span id="AnalyzerAgentUnified-329"><a href="#AnalyzerAgentUnified-329"><span class="linenos"> 329</span></a><span class="sd">        :return: Indique si une analyse ou un traitement des calculs ont été réalisés</span>
</span><span id="AnalyzerAgentUnified-330"><a href="#AnalyzerAgentUnified-330"><span class="linenos"> 330</span></a><span class="sd">        :rtype: bool</span>
</span><span id="AnalyzerAgentUnified-331"><a href="#AnalyzerAgentUnified-331"><span class="linenos"> 331</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-332"><a href="#AnalyzerAgentUnified-332"><span class="linenos"> 332</span></a>
</span><span id="AnalyzerAgentUnified-333"><a href="#AnalyzerAgentUnified-333"><span class="linenos"> 333</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">answer_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-334"><a href="#AnalyzerAgentUnified-334"><span class="linenos"> 334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="s2">&quot;answer_text invalide pour parsing Excel&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-335"><a href="#AnalyzerAgentUnified-335"><span class="linenos"> 335</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-336"><a href="#AnalyzerAgentUnified-336"><span class="linenos"> 336</span></a>
</span><span id="AnalyzerAgentUnified-337"><a href="#AnalyzerAgentUnified-337"><span class="linenos"> 337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DEBUT PARSING - Longueur: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">answer_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-338"><a href="#AnalyzerAgentUnified-338"><span class="linenos"> 338</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; APERÇU RÉPONSE: &#39;</span><span class="si">{</span><span class="n">answer_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-339"><a href="#AnalyzerAgentUnified-339"><span class="linenos"> 339</span></a>
</span><span id="AnalyzerAgentUnified-340"><a href="#AnalyzerAgentUnified-340"><span class="linenos"> 340</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-341"><a href="#AnalyzerAgentUnified-341"><span class="linenos"> 341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing Excel de &#39;</span><span class="si">{</span><span class="n">answer_text</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-342"><a href="#AnalyzerAgentUnified-342"><span class="linenos"> 342</span></a>
</span><span id="AnalyzerAgentUnified-343"><a href="#AnalyzerAgentUnified-343"><span class="linenos"> 343</span></a>            <span class="n">patterns_calculs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AnalyzerAgentUnified-344"><a href="#AnalyzerAgentUnified-344"><span class="linenos"> 344</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*CALCULS&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-345"><a href="#AnalyzerAgentUnified-345"><span class="linenos"> 345</span></a>                <span class="sa">r</span><span class="s1">&#39;CALCULS_NECESSAIRES&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-346"><a href="#AnalyzerAgentUnified-346"><span class="linenos"> 346</span></a>                <span class="sa">r</span><span class="s1">&#39;FORMAT\s*1&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-347"><a href="#AnalyzerAgentUnified-347"><span class="linenos"> 347</span></a>                <span class="sa">r</span><span class="s1">&#39;ETAPES?\s*:&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-348"><a href="#AnalyzerAgentUnified-348"><span class="linenos"> 348</span></a>                <span class="sa">r</span><span class="s1">&#39;ALGORITHME\s*:&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-349"><a href="#AnalyzerAgentUnified-349"><span class="linenos"> 349</span></a>                <span class="sa">r</span><span class="s1">&#39;```python&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-350"><a href="#AnalyzerAgentUnified-350"><span class="linenos"> 350</span></a>                <span class="sa">r</span><span class="s1">&#39;df\d+\.&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-351"><a href="#AnalyzerAgentUnified-351"><span class="linenos"> 351</span></a>                <span class="sa">r</span><span class="s1">&#39;besoin.*calcul&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-352"><a href="#AnalyzerAgentUnified-352"><span class="linenos"> 352</span></a>                <span class="sa">r</span><span class="s1">&#39;exécuter.*code&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-353"><a href="#AnalyzerAgentUnified-353"><span class="linenos"> 353</span></a>                <span class="sa">r</span><span class="s1">&#39;analyser.*données&#39;</span>
</span><span id="AnalyzerAgentUnified-354"><a href="#AnalyzerAgentUnified-354"><span class="linenos"> 354</span></a>            <span class="p">]</span>
</span><span id="AnalyzerAgentUnified-355"><a href="#AnalyzerAgentUnified-355"><span class="linenos"> 355</span></a>
</span><span id="AnalyzerAgentUnified-356"><a href="#AnalyzerAgentUnified-356"><span class="linenos"> 356</span></a>            <span class="n">patterns_direct</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AnalyzerAgentUnified-357"><a href="#AnalyzerAgentUnified-357"><span class="linenos"> 357</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-358"><a href="#AnalyzerAgentUnified-358"><span class="linenos"> 358</span></a>                <span class="sa">r</span><span class="s1">&#39;REPONSE_DIRECTE&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-359"><a href="#AnalyzerAgentUnified-359"><span class="linenos"> 359</span></a>                <span class="sa">r</span><span class="s1">&#39;FORMAT\s*2&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-360"><a href="#AnalyzerAgentUnified-360"><span class="linenos"> 360</span></a>                <span class="sa">r</span><span class="s1">&#39;REPONSE\s*:&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-361"><a href="#AnalyzerAgentUnified-361"><span class="linenos"> 361</span></a>            <span class="p">]</span>
</span><span id="AnalyzerAgentUnified-362"><a href="#AnalyzerAgentUnified-362"><span class="linenos"> 362</span></a>
</span><span id="AnalyzerAgentUnified-363"><a href="#AnalyzerAgentUnified-363"><span class="linenos"> 363</span></a>            <span class="n">is_calculs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-364"><a href="#AnalyzerAgentUnified-364"><span class="linenos"> 364</span></a>            <span class="n">is_direct</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-365"><a href="#AnalyzerAgentUnified-365"><span class="linenos"> 365</span></a>
</span><span id="AnalyzerAgentUnified-366"><a href="#AnalyzerAgentUnified-366"><span class="linenos"> 366</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_calculs</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-367"><a href="#AnalyzerAgentUnified-367"><span class="linenos"> 367</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">answer_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-368"><a href="#AnalyzerAgentUnified-368"><span class="linenos"> 368</span></a>                    <span class="n">is_calculs</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-369"><a href="#AnalyzerAgentUnified-369"><span class="linenos"> 369</span></a>                    <span class="k">break</span>
</span><span id="AnalyzerAgentUnified-370"><a href="#AnalyzerAgentUnified-370"><span class="linenos"> 370</span></a>
</span><span id="AnalyzerAgentUnified-371"><a href="#AnalyzerAgentUnified-371"><span class="linenos"> 371</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_direct</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-372"><a href="#AnalyzerAgentUnified-372"><span class="linenos"> 372</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">answer_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-373"><a href="#AnalyzerAgentUnified-373"><span class="linenos"> 373</span></a>                    <span class="n">is_direct</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-374"><a href="#AnalyzerAgentUnified-374"><span class="linenos"> 374</span></a>                    <span class="k">break</span>
</span><span id="AnalyzerAgentUnified-375"><a href="#AnalyzerAgentUnified-375"><span class="linenos"> 375</span></a>
</span><span id="AnalyzerAgentUnified-376"><a href="#AnalyzerAgentUnified-376"><span class="linenos"> 376</span></a>            <span class="n">question</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-377"><a href="#AnalyzerAgentUnified-377"><span class="linenos"> 377</span></a>            <span class="n">question_needs_calculs</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="AnalyzerAgentUnified-378"><a href="#AnalyzerAgentUnified-378"><span class="linenos"> 378</span></a>                <span class="s1">&#39;combien&#39;</span><span class="p">,</span> <span class="s1">&#39;pourcentage&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;moyenne&#39;</span><span class="p">,</span> <span class="s1">&#39;maximum&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-379"><a href="#AnalyzerAgentUnified-379"><span class="linenos"> 379</span></a>                <span class="s1">&#39;calcul&#39;</span><span class="p">,</span> <span class="s1">&#39;analyse&#39;</span><span class="p">,</span> <span class="s1">&#39;compare&#39;</span><span class="p">,</span> <span class="s1">&#39;évolution&#39;</span><span class="p">,</span> <span class="s1">&#39;statistique&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-380"><a href="#AnalyzerAgentUnified-380"><span class="linenos"> 380</span></a>                <span class="s1">&#39;quelle ville&#39;</span><span class="p">,</span> <span class="s1">&#39;plus élevé&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion&#39;</span><span class="p">,</span> <span class="s1">&#39;tendance&#39;</span>
</span><span id="AnalyzerAgentUnified-381"><a href="#AnalyzerAgentUnified-381"><span class="linenos"> 381</span></a>            <span class="p">])</span>
</span><span id="AnalyzerAgentUnified-382"><a href="#AnalyzerAgentUnified-382"><span class="linenos"> 382</span></a>
</span><span id="AnalyzerAgentUnified-383"><a href="#AnalyzerAgentUnified-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PATTERNS - CALCULS: </span><span class="si">{</span><span class="n">is_calculs</span><span class="si">}</span><span class="s2">, DIRECT: </span><span class="si">{</span><span class="n">is_direct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-384"><a href="#AnalyzerAgentUnified-384"><span class="linenos"> 384</span></a>            <span class="k">if</span> <span class="n">is_calculs</span> <span class="ow">or</span> <span class="p">(</span><span class="n">question_needs_calculs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_direct</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-385"><a href="#AnalyzerAgentUnified-385"><span class="linenos"> 385</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; BRANCHE CALCULS ACTIVÉE&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-386"><a href="#AnalyzerAgentUnified-386"><span class="linenos"> 386</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;CALCULS DÉTECTÉS - Extraction des étapes&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-387"><a href="#AnalyzerAgentUnified-387"><span class="linenos"> 387</span></a>
</span><span id="AnalyzerAgentUnified-388"><a href="#AnalyzerAgentUnified-388"><span class="linenos"> 388</span></a>                <span class="n">etapes</span><span class="p">,</span> <span class="n">algorithme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_etapes_et_algo_flexible</span><span class="p">(</span><span class="n">answer_text</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-389"><a href="#AnalyzerAgentUnified-389"><span class="linenos"> 389</span></a>
</span><span id="AnalyzerAgentUnified-390"><a href="#AnalyzerAgentUnified-390"><span class="linenos"> 390</span></a>                <span class="k">if</span> <span class="n">etapes</span> <span class="ow">and</span> <span class="n">algorithme</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-391"><a href="#AnalyzerAgentUnified-391"><span class="linenos"> 391</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-392"><a href="#AnalyzerAgentUnified-392"><span class="linenos"> 392</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etapes</span>
</span><span id="AnalyzerAgentUnified-393"><a href="#AnalyzerAgentUnified-393"><span class="linenos"> 393</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithme</span>
</span><span id="AnalyzerAgentUnified-394"><a href="#AnalyzerAgentUnified-394"><span class="linenos"> 394</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; CALCULS GARANTIS - Étapes et algo extraits&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-395"><a href="#AnalyzerAgentUnified-395"><span class="linenos"> 395</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-396"><a href="#AnalyzerAgentUnified-396"><span class="linenos"> 396</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-397"><a href="#AnalyzerAgentUnified-397"><span class="linenos"> 397</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; FALLBACK CALCULS - Génération automatique&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-398"><a href="#AnalyzerAgentUnified-398"><span class="linenos"> 398</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-399"><a href="#AnalyzerAgentUnified-399"><span class="linenos"> 399</span></a>                    <span class="n">state</span><span class="p">[</span>
</span><span id="AnalyzerAgentUnified-400"><a href="#AnalyzerAgentUnified-400"><span class="linenos"> 400</span></a>                        <span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour répondre à : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-401"><a href="#AnalyzerAgentUnified-401"><span class="linenos"> 401</span></a>
</span><span id="AnalyzerAgentUnified-402"><a href="#AnalyzerAgentUnified-402"><span class="linenos"> 402</span></a>                    <span class="c1"># Algo intelligent basé sur la question</span>
</span><span id="AnalyzerAgentUnified-403"><a href="#AnalyzerAgentUnified-403"><span class="linenos"> 403</span></a>                    <span class="k">if</span> <span class="s1">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">question</span> <span class="ow">or</span> <span class="s1">&#39;somme&#39;</span> <span class="ow">in</span> <span class="n">question</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-404"><a href="#AnalyzerAgentUnified-404"><span class="linenos"> 404</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Calculer les totaux</span><span class="se">\n</span><span class="s2">resultat = df0.sum(numeric_only=True)&quot;</span>
</span><span id="AnalyzerAgentUnified-405"><a href="#AnalyzerAgentUnified-405"><span class="linenos"> 405</span></a>                    <span class="k">elif</span> <span class="s1">&#39;moyenne&#39;</span> <span class="ow">in</span> <span class="n">question</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-406"><a href="#AnalyzerAgentUnified-406"><span class="linenos"> 406</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Calculer les moyennes</span><span class="se">\n</span><span class="s2">resultat = df0.mean(numeric_only=True)&quot;</span>
</span><span id="AnalyzerAgentUnified-407"><a href="#AnalyzerAgentUnified-407"><span class="linenos"> 407</span></a>                    <span class="k">elif</span> <span class="s1">&#39;compare&#39;</span> <span class="ow">in</span> <span class="n">question</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-408"><a href="#AnalyzerAgentUnified-408"><span class="linenos"> 408</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Comparer les données</span><span class="se">\n</span><span class="s2">resultat = df0.groupby(df0.columns[0]).sum()&quot;</span>
</span><span id="AnalyzerAgentUnified-409"><a href="#AnalyzerAgentUnified-409"><span class="linenos"> 409</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-410"><a href="#AnalyzerAgentUnified-410"><span class="linenos"> 410</span></a>                        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyser les données selon la question</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="AnalyzerAgentUnified-411"><a href="#AnalyzerAgentUnified-411"><span class="linenos"> 411</span></a>
</span><span id="AnalyzerAgentUnified-412"><a href="#AnalyzerAgentUnified-412"><span class="linenos"> 412</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; CALCULS GARANTIS - Fallback appliqué&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-413"><a href="#AnalyzerAgentUnified-413"><span class="linenos"> 413</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-414"><a href="#AnalyzerAgentUnified-414"><span class="linenos"> 414</span></a>
</span><span id="AnalyzerAgentUnified-415"><a href="#AnalyzerAgentUnified-415"><span class="linenos"> 415</span></a>            <span class="k">elif</span> <span class="n">is_direct</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-416"><a href="#AnalyzerAgentUnified-416"><span class="linenos"> 416</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;RÉPONSE DIRECTE DÉTECTÉE&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-417"><a href="#AnalyzerAgentUnified-417"><span class="linenos"> 417</span></a>                <span class="n">reponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraire_reponse_directe_flexible</span><span class="p">(</span><span class="n">answer_text</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-418"><a href="#AnalyzerAgentUnified-418"><span class="linenos"> 418</span></a>                <span class="k">if</span> <span class="n">reponse</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-419"><a href="#AnalyzerAgentUnified-419"><span class="linenos"> 419</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-420"><a href="#AnalyzerAgentUnified-420"><span class="linenos"> 420</span></a>                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reponse</span>
</span><span id="AnalyzerAgentUnified-421"><a href="#AnalyzerAgentUnified-421"><span class="linenos"> 421</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Réponse directe Excel extraite&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-422"><a href="#AnalyzerAgentUnified-422"><span class="linenos"> 422</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-423"><a href="#AnalyzerAgentUnified-423"><span class="linenos"> 423</span></a>
</span><span id="AnalyzerAgentUnified-424"><a href="#AnalyzerAgentUnified-424"><span class="linenos"> 424</span></a>            <span class="c1"># FALLBACK FINAL BASÉ SUR LA QUESTION</span>
</span><span id="AnalyzerAgentUnified-425"><a href="#AnalyzerAgentUnified-425"><span class="linenos"> 425</span></a>            <span class="k">if</span> <span class="n">question_needs_calculs</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-426"><a href="#AnalyzerAgentUnified-426"><span class="linenos"> 426</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; GARANTIE FINALE - Question nécessite des calculs&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-427"><a href="#AnalyzerAgentUnified-427"><span class="linenos"> 427</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-428"><a href="#AnalyzerAgentUnified-428"><span class="linenos"> 428</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-429"><a href="#AnalyzerAgentUnified-429"><span class="linenos"> 429</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyser les dataframes selon la question</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="AnalyzerAgentUnified-430"><a href="#AnalyzerAgentUnified-430"><span class="linenos"> 430</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-431"><a href="#AnalyzerAgentUnified-431"><span class="linenos"> 431</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-432"><a href="#AnalyzerAgentUnified-432"><span class="linenos"> 432</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Question factuelle - pas de calculs nécessaires&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-433"><a href="#AnalyzerAgentUnified-433"><span class="linenos"> 433</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-434"><a href="#AnalyzerAgentUnified-434"><span class="linenos"> 434</span></a>
</span><span id="AnalyzerAgentUnified-435"><a href="#AnalyzerAgentUnified-435"><span class="linenos"> 435</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-436"><a href="#AnalyzerAgentUnified-436"><span class="linenos"> 436</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur parsing Excel: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-437"><a href="#AnalyzerAgentUnified-437"><span class="linenos"> 437</span></a>            <span class="c1"># MÊME EN CAS D&#39;ERREUR, SI LA QUESTION NÉCESSITE DES CALCULS, ON LES FAIT</span>
</span><span id="AnalyzerAgentUnified-438"><a href="#AnalyzerAgentUnified-438"><span class="linenos"> 438</span></a>            <span class="n">question</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-439"><a href="#AnalyzerAgentUnified-439"><span class="linenos"> 439</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;combien&#39;</span><span class="p">,</span> <span class="s1">&#39;pourcentage&#39;</span><span class="p">,</span> <span class="s1">&#39;calcul&#39;</span><span class="p">,</span> <span class="s1">&#39;analyse&#39;</span><span class="p">]):</span>
</span><span id="AnalyzerAgentUnified-440"><a href="#AnalyzerAgentUnified-440"><span class="linenos"> 440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; ERREUR MAIS CALCULS FORCÉS&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-441"><a href="#AnalyzerAgentUnified-441"><span class="linenos"> 441</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-442"><a href="#AnalyzerAgentUnified-442"><span class="linenos"> 442</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-443"><a href="#AnalyzerAgentUnified-443"><span class="linenos"> 443</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyse de base</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="AnalyzerAgentUnified-444"><a href="#AnalyzerAgentUnified-444"><span class="linenos"> 444</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-445"><a href="#AnalyzerAgentUnified-445"><span class="linenos"> 445</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-446"><a href="#AnalyzerAgentUnified-446"><span class="linenos"> 446</span></a>
</span><span id="AnalyzerAgentUnified-447"><a href="#AnalyzerAgentUnified-447"><span class="linenos"> 447</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_analysis_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">,</span> <span class="n">excel_processed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">pdf_processed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-448"><a href="#AnalyzerAgentUnified-448"><span class="linenos"> 448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-449"><a href="#AnalyzerAgentUnified-449"><span class="linenos"> 449</span></a><span class="sd">        Met à jour et enregistre l&#39;état final de l&#39;analyse en fonction des résultats</span>
</span><span id="AnalyzerAgentUnified-450"><a href="#AnalyzerAgentUnified-450"><span class="linenos"> 450</span></a><span class="sd">        des traitements effectués sur les fichiers Excel et PDF. Cette méthode</span>
</span><span id="AnalyzerAgentUnified-451"><a href="#AnalyzerAgentUnified-451"><span class="linenos"> 451</span></a><span class="sd">        enregistre des messages de journalisation en fonction des conditions remplies</span>
</span><span id="AnalyzerAgentUnified-452"><a href="#AnalyzerAgentUnified-452"><span class="linenos"> 452</span></a><span class="sd">        et vérifie également la présence des réponses issues des analyses Excel, PDF,</span>
</span><span id="AnalyzerAgentUnified-453"><a href="#AnalyzerAgentUnified-453"><span class="linenos"> 453</span></a><span class="sd">        ainsi que des calculs éventuels.</span>
</span><span id="AnalyzerAgentUnified-454"><a href="#AnalyzerAgentUnified-454"><span class="linenos"> 454</span></a>
</span><span id="AnalyzerAgentUnified-455"><a href="#AnalyzerAgentUnified-455"><span class="linenos"> 455</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot. Contient des informations sur les calculs</span>
</span><span id="AnalyzerAgentUnified-456"><a href="#AnalyzerAgentUnified-456"><span class="linenos"> 456</span></a><span class="sd">            et les réponses déjà générées.</span>
</span><span id="AnalyzerAgentUnified-457"><a href="#AnalyzerAgentUnified-457"><span class="linenos"> 457</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-458"><a href="#AnalyzerAgentUnified-458"><span class="linenos"> 458</span></a><span class="sd">        :param excel_processed: Indique si le fichier Excel a été traité avec succès.</span>
</span><span id="AnalyzerAgentUnified-459"><a href="#AnalyzerAgentUnified-459"><span class="linenos"> 459</span></a><span class="sd">        :type excel_processed: bool</span>
</span><span id="AnalyzerAgentUnified-460"><a href="#AnalyzerAgentUnified-460"><span class="linenos"> 460</span></a><span class="sd">        :param pdf_processed: Indique si le fichier PDF a été traité avec succès.</span>
</span><span id="AnalyzerAgentUnified-461"><a href="#AnalyzerAgentUnified-461"><span class="linenos"> 461</span></a><span class="sd">        :type pdf_processed: bool</span>
</span><span id="AnalyzerAgentUnified-462"><a href="#AnalyzerAgentUnified-462"><span class="linenos"> 462</span></a><span class="sd">        :return: Aucun résultat n&#39;est retourné.</span>
</span><span id="AnalyzerAgentUnified-463"><a href="#AnalyzerAgentUnified-463"><span class="linenos"> 463</span></a><span class="sd">        :rtype: None</span>
</span><span id="AnalyzerAgentUnified-464"><a href="#AnalyzerAgentUnified-464"><span class="linenos"> 464</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-465"><a href="#AnalyzerAgentUnified-465"><span class="linenos"> 465</span></a>
</span><span id="AnalyzerAgentUnified-466"><a href="#AnalyzerAgentUnified-466"><span class="linenos"> 466</span></a>        <span class="k">if</span> <span class="n">excel_processed</span> <span class="ow">and</span> <span class="n">pdf_processed</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-467"><a href="#AnalyzerAgentUnified-467"><span class="linenos"> 467</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyses Excel + PDF terminées avec succès&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-468"><a href="#AnalyzerAgentUnified-468"><span class="linenos"> 468</span></a>        <span class="k">elif</span> <span class="n">excel_processed</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-469"><a href="#AnalyzerAgentUnified-469"><span class="linenos"> 469</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyse Excel seule terminée&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-470"><a href="#AnalyzerAgentUnified-470"><span class="linenos"> 470</span></a>        <span class="k">elif</span> <span class="n">pdf_processed</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-471"><a href="#AnalyzerAgentUnified-471"><span class="linenos"> 471</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Analyse PDF seule terminée&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-472"><a href="#AnalyzerAgentUnified-472"><span class="linenos"> 472</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-473"><a href="#AnalyzerAgentUnified-473"><span class="linenos"> 473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; Aucune analyse n&#39;a abouti&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-474"><a href="#AnalyzerAgentUnified-474"><span class="linenos"> 474</span></a>
</span><span id="AnalyzerAgentUnified-475"><a href="#AnalyzerAgentUnified-475"><span class="linenos"> 475</span></a>        <span class="c1"># Debug des résultats</span>
</span><span id="AnalyzerAgentUnified-476"><a href="#AnalyzerAgentUnified-476"><span class="linenos"> 476</span></a>        <span class="n">has_calculs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-477"><a href="#AnalyzerAgentUnified-477"><span class="linenos"> 477</span></a>        <span class="n">has_excel_response</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="AnalyzerAgentUnified-478"><a href="#AnalyzerAgentUnified-478"><span class="linenos"> 478</span></a>        <span class="n">has_pdf_response</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reponse_finale_pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="AnalyzerAgentUnified-479"><a href="#AnalyzerAgentUnified-479"><span class="linenos"> 479</span></a>
</span><span id="AnalyzerAgentUnified-480"><a href="#AnalyzerAgentUnified-480"><span class="linenos"> 480</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
</span><span id="AnalyzerAgentUnified-481"><a href="#AnalyzerAgentUnified-481"><span class="linenos"> 481</span></a>            <span class="sa">f</span><span class="s2">&quot;État final: calculs=</span><span class="si">{</span><span class="n">has_calculs</span><span class="si">}</span><span class="s2">, excel_response=</span><span class="si">{</span><span class="n">has_excel_response</span><span class="si">}</span><span class="s2">, pdf_response=</span><span class="si">{</span><span class="n">has_pdf_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-482"><a href="#AnalyzerAgentUnified-482"><span class="linenos"> 482</span></a>            <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-483"><a href="#AnalyzerAgentUnified-483"><span class="linenos"> 483</span></a>
</span><span id="AnalyzerAgentUnified-484"><a href="#AnalyzerAgentUnified-484"><span class="linenos"> 484</span></a>
</span><span id="AnalyzerAgentUnified-485"><a href="#AnalyzerAgentUnified-485"><span class="linenos"> 485</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_user_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-486"><a href="#AnalyzerAgentUnified-486"><span class="linenos"> 486</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-487"><a href="#AnalyzerAgentUnified-487"><span class="linenos"> 487</span></a><span class="sd">        Récupère le contexte utilisateur basé sur le nom d&#39;utilisateur et l&#39;email. Si le contexte</span>
</span><span id="AnalyzerAgentUnified-488"><a href="#AnalyzerAgentUnified-488"><span class="linenos"> 488</span></a><span class="sd">        peut être récupéré et qu&#39;il n&#39;indique aucune conversation précédente, un message de</span>
</span><span id="AnalyzerAgentUnified-489"><a href="#AnalyzerAgentUnified-489"><span class="linenos"> 489</span></a><span class="sd">        journalisation est enregistré. En cas d&#39;erreur, un message d&#39;erreur est enregistré</span>
</span><span id="AnalyzerAgentUnified-490"><a href="#AnalyzerAgentUnified-490"><span class="linenos"> 490</span></a><span class="sd">        et une chaîne vide est retournée.</span>
</span><span id="AnalyzerAgentUnified-491"><a href="#AnalyzerAgentUnified-491"><span class="linenos"> 491</span></a>
</span><span id="AnalyzerAgentUnified-492"><a href="#AnalyzerAgentUnified-492"><span class="linenos"> 492</span></a><span class="sd">        :param username: Le nom d&#39;utilisateur pour identifier l&#39;utilisateur.</span>
</span><span id="AnalyzerAgentUnified-493"><a href="#AnalyzerAgentUnified-493"><span class="linenos"> 493</span></a><span class="sd">        :type username: str</span>
</span><span id="AnalyzerAgentUnified-494"><a href="#AnalyzerAgentUnified-494"><span class="linenos"> 494</span></a><span class="sd">        :param email: L&#39;adresse email associée à l&#39;utilisateur.</span>
</span><span id="AnalyzerAgentUnified-495"><a href="#AnalyzerAgentUnified-495"><span class="linenos"> 495</span></a><span class="sd">        :type email: str</span>
</span><span id="AnalyzerAgentUnified-496"><a href="#AnalyzerAgentUnified-496"><span class="linenos"> 496</span></a><span class="sd">        :param state: L&#39;état actuel ou contexte d&#39;exécution en cours.</span>
</span><span id="AnalyzerAgentUnified-497"><a href="#AnalyzerAgentUnified-497"><span class="linenos"> 497</span></a><span class="sd">        :type state: Any</span>
</span><span id="AnalyzerAgentUnified-498"><a href="#AnalyzerAgentUnified-498"><span class="linenos"> 498</span></a><span class="sd">        :return: Une chaîne contenant le contexte utilisateur ou une chaîne vide si le contexte</span>
</span><span id="AnalyzerAgentUnified-499"><a href="#AnalyzerAgentUnified-499"><span class="linenos"> 499</span></a><span class="sd">                 ne peut pas être récupéré.</span>
</span><span id="AnalyzerAgentUnified-500"><a href="#AnalyzerAgentUnified-500"><span class="linenos"> 500</span></a><span class="sd">        :rtype: str</span>
</span><span id="AnalyzerAgentUnified-501"><a href="#AnalyzerAgentUnified-501"><span class="linenos"> 501</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-502"><a href="#AnalyzerAgentUnified-502"><span class="linenos"> 502</span></a>        <span class="n">historique_contexte</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-503"><a href="#AnalyzerAgentUnified-503"><span class="linenos"> 503</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-504"><a href="#AnalyzerAgentUnified-504"><span class="linenos"> 504</span></a>            <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">email</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-505"><a href="#AnalyzerAgentUnified-505"><span class="linenos"> 505</span></a>                <span class="n">historique_contexte</span> <span class="o">=</span> <span class="n">get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-506"><a href="#AnalyzerAgentUnified-506"><span class="linenos"> 506</span></a>                <span class="k">if</span> <span class="n">historique_contexte</span> <span class="ow">and</span> <span class="s2">&quot;Aucune conversation précédente&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">historique_contexte</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-507"><a href="#AnalyzerAgentUnified-507"><span class="linenos"> 507</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Historique utilisateur récupéré pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-508"><a href="#AnalyzerAgentUnified-508"><span class="linenos"> 508</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-509"><a href="#AnalyzerAgentUnified-509"><span class="linenos"> 509</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Première conversation pour </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-510"><a href="#AnalyzerAgentUnified-510"><span class="linenos"> 510</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-511"><a href="#AnalyzerAgentUnified-511"><span class="linenos"> 511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Récupération historique: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-512"><a href="#AnalyzerAgentUnified-512"><span class="linenos"> 512</span></a>            <span class="n">historique_contexte</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-513"><a href="#AnalyzerAgentUnified-513"><span class="linenos"> 513</span></a>        <span class="k">return</span> <span class="n">historique_contexte</span>
</span><span id="AnalyzerAgentUnified-514"><a href="#AnalyzerAgentUnified-514"><span class="linenos"> 514</span></a>
</span><span id="AnalyzerAgentUnified-515"><a href="#AnalyzerAgentUnified-515"><span class="linenos"> 515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-516"><a href="#AnalyzerAgentUnified-516"><span class="linenos"> 516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-517"><a href="#AnalyzerAgentUnified-517"><span class="linenos"> 517</span></a><span class="sd">        Extrait les informations de l&#39;utilisateur depuis l&#39;état d&#39;un chatbot. Cette méthode analyse</span>
</span><span id="AnalyzerAgentUnified-518"><a href="#AnalyzerAgentUnified-518"><span class="linenos"> 518</span></a><span class="sd">        l&#39;état fourni pour identifier et retourner le nom d&#39;utilisateur et l&#39;adresse email correspondante.</span>
</span><span id="AnalyzerAgentUnified-519"><a href="#AnalyzerAgentUnified-519"><span class="linenos"> 519</span></a><span class="sd">        Si les informations ne sont pas directement disponibles, elle établit des valeurs par défaut en</span>
</span><span id="AnalyzerAgentUnified-520"><a href="#AnalyzerAgentUnified-520"><span class="linenos"> 520</span></a><span class="sd">        fonction du rôle d&#39;utilisateur trouvé dans l&#39;état. En cas d&#39;erreur, une journalisation est effectuée.</span>
</span><span id="AnalyzerAgentUnified-521"><a href="#AnalyzerAgentUnified-521"><span class="linenos"> 521</span></a>
</span><span id="AnalyzerAgentUnified-522"><a href="#AnalyzerAgentUnified-522"><span class="linenos"> 522</span></a><span class="sd">        :param state: Représente l&#39;état actuel du chatbot contenant les informations de l&#39;utilisateur.</span>
</span><span id="AnalyzerAgentUnified-523"><a href="#AnalyzerAgentUnified-523"><span class="linenos"> 523</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified-524"><a href="#AnalyzerAgentUnified-524"><span class="linenos"> 524</span></a>
</span><span id="AnalyzerAgentUnified-525"><a href="#AnalyzerAgentUnified-525"><span class="linenos"> 525</span></a><span class="sd">        :return: Une paire (tuple) contenant le nom d&#39;utilisateur et son adresse email. Retourne</span>
</span><span id="AnalyzerAgentUnified-526"><a href="#AnalyzerAgentUnified-526"><span class="linenos"> 526</span></a><span class="sd">                 (None, None) en cas d&#39;échec ou si les informations ne sont pas disponibles.</span>
</span><span id="AnalyzerAgentUnified-527"><a href="#AnalyzerAgentUnified-527"><span class="linenos"> 527</span></a><span class="sd">        :rtype: tuple</span>
</span><span id="AnalyzerAgentUnified-528"><a href="#AnalyzerAgentUnified-528"><span class="linenos"> 528</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-529"><a href="#AnalyzerAgentUnified-529"><span class="linenos"> 529</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-530"><a href="#AnalyzerAgentUnified-530"><span class="linenos"> 530</span></a>            <span class="n">session_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-531"><a href="#AnalyzerAgentUnified-531"><span class="linenos"> 531</span></a>            <span class="n">username</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-532"><a href="#AnalyzerAgentUnified-532"><span class="linenos"> 532</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-533"><a href="#AnalyzerAgentUnified-533"><span class="linenos"> 533</span></a>
</span><span id="AnalyzerAgentUnified-534"><a href="#AnalyzerAgentUnified-534"><span class="linenos"> 534</span></a>            <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">email</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-535"><a href="#AnalyzerAgentUnified-535"><span class="linenos"> 535</span></a>                <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span>
</span><span id="AnalyzerAgentUnified-536"><a href="#AnalyzerAgentUnified-536"><span class="linenos"> 536</span></a>
</span><span id="AnalyzerAgentUnified-537"><a href="#AnalyzerAgentUnified-537"><span class="linenos"> 537</span></a>            <span class="n">user_role</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_role&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-538"><a href="#AnalyzerAgentUnified-538"><span class="linenos"> 538</span></a>
</span><span id="AnalyzerAgentUnified-539"><a href="#AnalyzerAgentUnified-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-540"><a href="#AnalyzerAgentUnified-540"><span class="linenos"> 540</span></a>                <span class="k">if</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">in</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-541"><a href="#AnalyzerAgentUnified-541"><span class="linenos"> 541</span></a>                    <span class="k">return</span> <span class="s1">&#39;admin_user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin@amdie.ma&#39;</span>
</span><span id="AnalyzerAgentUnified-542"><a href="#AnalyzerAgentUnified-542"><span class="linenos"> 542</span></a>                <span class="k">elif</span> <span class="s1">&#39;employee&#39;</span> <span class="ow">in</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s1">&#39;employee&#39;</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-543"><a href="#AnalyzerAgentUnified-543"><span class="linenos"> 543</span></a>                    <span class="k">return</span> <span class="s1">&#39;employee_user&#39;</span><span class="p">,</span> <span class="s1">&#39;employee@amdie.ma&#39;</span>
</span><span id="AnalyzerAgentUnified-544"><a href="#AnalyzerAgentUnified-544"><span class="linenos"> 544</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-545"><a href="#AnalyzerAgentUnified-545"><span class="linenos"> 545</span></a>                    <span class="k">return</span> <span class="s1">&#39;public_user&#39;</span><span class="p">,</span> <span class="s1">&#39;public@amdie.ma&#39;</span>
</span><span id="AnalyzerAgentUnified-546"><a href="#AnalyzerAgentUnified-546"><span class="linenos"> 546</span></a>
</span><span id="AnalyzerAgentUnified-547"><a href="#AnalyzerAgentUnified-547"><span class="linenos"> 547</span></a>            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-548"><a href="#AnalyzerAgentUnified-548"><span class="linenos"> 548</span></a>
</span><span id="AnalyzerAgentUnified-549"><a href="#AnalyzerAgentUnified-549"><span class="linenos"> 549</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-550"><a href="#AnalyzerAgentUnified-550"><span class="linenos"> 550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur extraction info utilisateur: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-551"><a href="#AnalyzerAgentUnified-551"><span class="linenos"> 551</span></a>            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-552"><a href="#AnalyzerAgentUnified-552"><span class="linenos"> 552</span></a>
</span><span id="AnalyzerAgentUnified-553"><a href="#AnalyzerAgentUnified-553"><span class="linenos"> 553</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_creer_prompt_excel_unifie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">contexte_complet</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-554"><a href="#AnalyzerAgentUnified-554"><span class="linenos"> 554</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-555"><a href="#AnalyzerAgentUnified-555"><span class="linenos"> 555</span></a><span class="sd">        Crée un prompt unifié pour une analyse de données basée sur le contexte donné. Le prompt généré</span>
</span><span id="AnalyzerAgentUnified-556"><a href="#AnalyzerAgentUnified-556"><span class="linenos"> 556</span></a><span class="sd">        fournit une structure strictement formatée pour répondre aux questions des utilisateurs sur des</span>
</span><span id="AnalyzerAgentUnified-557"><a href="#AnalyzerAgentUnified-557"><span class="linenos"> 557</span></a><span class="sd">        données Excel avec une perspective spécifique au Maroc.</span>
</span><span id="AnalyzerAgentUnified-558"><a href="#AnalyzerAgentUnified-558"><span class="linenos"> 558</span></a>
</span><span id="AnalyzerAgentUnified-559"><a href="#AnalyzerAgentUnified-559"><span class="linenos"> 559</span></a><span class="sd">        :param state: Dictionnaire contenant la question de l&#39;utilisateur sous la clé</span>
</span><span id="AnalyzerAgentUnified-560"><a href="#AnalyzerAgentUnified-560"><span class="linenos"> 560</span></a><span class="sd">            &#39;question_utilisateur&#39;.</span>
</span><span id="AnalyzerAgentUnified-561"><a href="#AnalyzerAgentUnified-561"><span class="linenos"> 561</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-562"><a href="#AnalyzerAgentUnified-562"><span class="linenos"> 562</span></a><span class="sd">        :param contexte_complet: Chaîne représentant le contexte complet qui sera intégré au prompt.</span>
</span><span id="AnalyzerAgentUnified-563"><a href="#AnalyzerAgentUnified-563"><span class="linenos"> 563</span></a><span class="sd">        :type contexte_complet: str</span>
</span><span id="AnalyzerAgentUnified-564"><a href="#AnalyzerAgentUnified-564"><span class="linenos"> 564</span></a><span class="sd">        :param historique_contexte: Historique ou contexte supplémentaire qui peut être utilisé pour</span>
</span><span id="AnalyzerAgentUnified-565"><a href="#AnalyzerAgentUnified-565"><span class="linenos"> 565</span></a><span class="sd">            enrichir le prompt.</span>
</span><span id="AnalyzerAgentUnified-566"><a href="#AnalyzerAgentUnified-566"><span class="linenos"> 566</span></a><span class="sd">        :type historique_contexte: str</span>
</span><span id="AnalyzerAgentUnified-567"><a href="#AnalyzerAgentUnified-567"><span class="linenos"> 567</span></a><span class="sd">        :return: Une chaîne formatée qui constitue le prompt pour répondre à la question utilisateur.</span>
</span><span id="AnalyzerAgentUnified-568"><a href="#AnalyzerAgentUnified-568"><span class="linenos"> 568</span></a><span class="sd">        :rtype: str</span>
</span><span id="AnalyzerAgentUnified-569"><a href="#AnalyzerAgentUnified-569"><span class="linenos"> 569</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-570"><a href="#AnalyzerAgentUnified-570"><span class="linenos"> 570</span></a>
</span><span id="AnalyzerAgentUnified-571"><a href="#AnalyzerAgentUnified-571"><span class="linenos"> 571</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Tu es un expert en analyse de données du Maroc.</span>
</span><span id="AnalyzerAgentUnified-572"><a href="#AnalyzerAgentUnified-572"><span class="linenos"> 572</span></a>
</span><span id="AnalyzerAgentUnified-573"><a href="#AnalyzerAgentUnified-573"><span class="linenos"> 573</span></a><span class="s2">    QUESTION: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span>
</span><span id="AnalyzerAgentUnified-574"><a href="#AnalyzerAgentUnified-574"><span class="linenos"> 574</span></a>
</span><span id="AnalyzerAgentUnified-575"><a href="#AnalyzerAgentUnified-575"><span class="linenos"> 575</span></a><span class="s2">    </span><span class="si">{</span><span class="n">contexte_complet</span><span class="si">}</span>
</span><span id="AnalyzerAgentUnified-576"><a href="#AnalyzerAgentUnified-576"><span class="linenos"> 576</span></a>
</span><span id="AnalyzerAgentUnified-577"><a href="#AnalyzerAgentUnified-577"><span class="linenos"> 577</span></a><span class="s2">    RÈGLE SIMPLE: </span>
</span><span id="AnalyzerAgentUnified-578"><a href="#AnalyzerAgentUnified-578"><span class="linenos"> 578</span></a><span class="s2">    - Si la question nécessite des CALCULS (pourcentage, total, comparaison) → réponds &quot;TYPE: CALCULS&quot;</span>
</span><span id="AnalyzerAgentUnified-579"><a href="#AnalyzerAgentUnified-579"><span class="linenos"> 579</span></a><span class="s2">    - Sinon → réponds &quot;TYPE: DIRECT&quot; suivi de ta réponse</span>
</span><span id="AnalyzerAgentUnified-580"><a href="#AnalyzerAgentUnified-580"><span class="linenos"> 580</span></a>
</span><span id="AnalyzerAgentUnified-581"><a href="#AnalyzerAgentUnified-581"><span class="linenos"> 581</span></a><span class="s2">    FORMAT DE RÉPONSE OBLIGATOIRE:</span>
</span><span id="AnalyzerAgentUnified-582"><a href="#AnalyzerAgentUnified-582"><span class="linenos"> 582</span></a><span class="s2">TYPE: CALCULS</span>
</span><span id="AnalyzerAgentUnified-583"><a href="#AnalyzerAgentUnified-583"><span class="linenos"> 583</span></a>
</span><span id="AnalyzerAgentUnified-584"><a href="#AnalyzerAgentUnified-584"><span class="linenos"> 584</span></a><span class="s2">INSTRUCTION_CALCUL: [description des étapes]</span>
</span><span id="AnalyzerAgentUnified-585"><a href="#AnalyzerAgentUnified-585"><span class="linenos"> 585</span></a>
</span><span id="AnalyzerAgentUnified-586"><a href="#AnalyzerAgentUnified-586"><span class="linenos"> 586</span></a><span class="s2">ALGORITHME: [étapes détaillées]</span>
</span><span id="AnalyzerAgentUnified-587"><a href="#AnalyzerAgentUnified-587"><span class="linenos"> 587</span></a>
</span><span id="AnalyzerAgentUnified-588"><a href="#AnalyzerAgentUnified-588"><span class="linenos"> 588</span></a><span class="s2">SOURCES_UTILISEES: [sources]</span>
</span><span id="AnalyzerAgentUnified-589"><a href="#AnalyzerAgentUnified-589"><span class="linenos"> 589</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-590"><a href="#AnalyzerAgentUnified-590"><span class="linenos"> 590</span></a>
</span><span id="AnalyzerAgentUnified-591"><a href="#AnalyzerAgentUnified-591"><span class="linenos"> 591</span></a>
</span><span id="AnalyzerAgentUnified-592"><a href="#AnalyzerAgentUnified-592"><span class="linenos"> 592</span></a>
</span><span id="AnalyzerAgentUnified-593"><a href="#AnalyzerAgentUnified-593"><span class="linenos"> 593</span></a>        <span class="k">return</span> <span class="n">prompt</span>
</span><span id="AnalyzerAgentUnified-594"><a href="#AnalyzerAgentUnified-594"><span class="linenos"> 594</span></a>
</span><span id="AnalyzerAgentUnified-595"><a href="#AnalyzerAgentUnified-595"><span class="linenos"> 595</span></a>
</span><span id="AnalyzerAgentUnified-596"><a href="#AnalyzerAgentUnified-596"><span class="linenos"> 596</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extraire_contenu_gemini_robuste</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-597"><a href="#AnalyzerAgentUnified-597"><span class="linenos"> 597</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-598"><a href="#AnalyzerAgentUnified-598"><span class="linenos"> 598</span></a><span class="sd">        Extrait de manière robuste le contenu textuel depuis la réponse d&#39;un service Gemini.</span>
</span><span id="AnalyzerAgentUnified-599"><a href="#AnalyzerAgentUnified-599"><span class="linenos"> 599</span></a>
</span><span id="AnalyzerAgentUnified-600"><a href="#AnalyzerAgentUnified-600"><span class="linenos"> 600</span></a><span class="sd">        Ce traitement analyse les composants de la réponse pour extraire toutes les parties textuelles</span>
</span><span id="AnalyzerAgentUnified-601"><a href="#AnalyzerAgentUnified-601"><span class="linenos"> 601</span></a><span class="sd">        disponibles et les concatène en une seule chaîne de caractères. Si aucune partie textuelle</span>
</span><span id="AnalyzerAgentUnified-602"><a href="#AnalyzerAgentUnified-602"><span class="linenos"> 602</span></a><span class="sd">        n&#39;est disponible ou si une erreur se produit durant cette extraction, la fonction retourne `None`.</span>
</span><span id="AnalyzerAgentUnified-603"><a href="#AnalyzerAgentUnified-603"><span class="linenos"> 603</span></a>
</span><span id="AnalyzerAgentUnified-604"><a href="#AnalyzerAgentUnified-604"><span class="linenos"> 604</span></a><span class="sd">        :param response: La réponse du service Gemini contenant potentiellement des données candidates</span>
</span><span id="AnalyzerAgentUnified-605"><a href="#AnalyzerAgentUnified-605"><span class="linenos"> 605</span></a><span class="sd">            avec du contenu structuré.</span>
</span><span id="AnalyzerAgentUnified-606"><a href="#AnalyzerAgentUnified-606"><span class="linenos"> 606</span></a><span class="sd">        :type response: object</span>
</span><span id="AnalyzerAgentUnified-607"><a href="#AnalyzerAgentUnified-607"><span class="linenos"> 607</span></a><span class="sd">        :param state: État courant de l&#39;application ou de la session permettant de journaliser les informations.</span>
</span><span id="AnalyzerAgentUnified-608"><a href="#AnalyzerAgentUnified-608"><span class="linenos"> 608</span></a><span class="sd">        :type state: object</span>
</span><span id="AnalyzerAgentUnified-609"><a href="#AnalyzerAgentUnified-609"><span class="linenos"> 609</span></a><span class="sd">        :return: Une chaîne de texte combinée issue des parties disponibles, ou `None` si rien n&#39;est extrait</span>
</span><span id="AnalyzerAgentUnified-610"><a href="#AnalyzerAgentUnified-610"><span class="linenos"> 610</span></a><span class="sd">            ou qu&#39;une erreur survient.</span>
</span><span id="AnalyzerAgentUnified-611"><a href="#AnalyzerAgentUnified-611"><span class="linenos"> 611</span></a><span class="sd">        :rtype: Optional[str]</span>
</span><span id="AnalyzerAgentUnified-612"><a href="#AnalyzerAgentUnified-612"><span class="linenos"> 612</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-613"><a href="#AnalyzerAgentUnified-613"><span class="linenos"> 613</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-614"><a href="#AnalyzerAgentUnified-614"><span class="linenos"> 614</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;candidates&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-615"><a href="#AnalyzerAgentUnified-615"><span class="linenos"> 615</span></a>                <span class="n">candidate</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AnalyzerAgentUnified-616"><a href="#AnalyzerAgentUnified-616"><span class="linenos"> 616</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-617"><a href="#AnalyzerAgentUnified-617"><span class="linenos"> 617</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;parts&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-618"><a href="#AnalyzerAgentUnified-618"><span class="linenos"> 618</span></a>
</span><span id="AnalyzerAgentUnified-619"><a href="#AnalyzerAgentUnified-619"><span class="linenos"> 619</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PARTS COUNT: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-620"><a href="#AnalyzerAgentUnified-620"><span class="linenos"> 620</span></a>                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-621"><a href="#AnalyzerAgentUnified-621"><span class="linenos"> 621</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PART </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="si">}</span><span class="s2"> - hasattr text: </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-622"><a href="#AnalyzerAgentUnified-622"><span class="linenos"> 622</span></a>                                              <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-623"><a href="#AnalyzerAgentUnified-623"><span class="linenos"> 623</span></a>                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-624"><a href="#AnalyzerAgentUnified-624"><span class="linenos"> 624</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PART </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> TEXT: </span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-625"><a href="#AnalyzerAgentUnified-625"><span class="linenos"> 625</span></a>
</span><span id="AnalyzerAgentUnified-626"><a href="#AnalyzerAgentUnified-626"><span class="linenos"> 626</span></a>                        <span class="n">all_text</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-627"><a href="#AnalyzerAgentUnified-627"><span class="linenos"> 627</span></a>                        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">candidate</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-628"><a href="#AnalyzerAgentUnified-628"><span class="linenos"> 628</span></a>                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-629"><a href="#AnalyzerAgentUnified-629"><span class="linenos"> 629</span></a>                                <span class="n">all_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-630"><a href="#AnalyzerAgentUnified-630"><span class="linenos"> 630</span></a>                        <span class="k">if</span> <span class="n">all_text</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-631"><a href="#AnalyzerAgentUnified-631"><span class="linenos"> 631</span></a>                            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-632"><a href="#AnalyzerAgentUnified-632"><span class="linenos"> 632</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-633"><a href="#AnalyzerAgentUnified-633"><span class="linenos"> 633</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-634"><a href="#AnalyzerAgentUnified-634"><span class="linenos"> 634</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-635"><a href="#AnalyzerAgentUnified-635"><span class="linenos"> 635</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-636"><a href="#AnalyzerAgentUnified-636"><span class="linenos"> 636</span></a>
</span><span id="AnalyzerAgentUnified-637"><a href="#AnalyzerAgentUnified-637"><span class="linenos"> 637</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extraire_etapes_et_algo_flexible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texte</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-638"><a href="#AnalyzerAgentUnified-638"><span class="linenos"> 638</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-639"><a href="#AnalyzerAgentUnified-639"><span class="linenos"> 639</span></a><span class="sd">        Extrait les étapes et l&#39;algorithme d&#39;un texte donné en utilisant des expressions</span>
</span><span id="AnalyzerAgentUnified-640"><a href="#AnalyzerAgentUnified-640"><span class="linenos"> 640</span></a><span class="sd">        régulières pour garantir une extraction flexible et robuste. Cette méthode</span>
</span><span id="AnalyzerAgentUnified-641"><a href="#AnalyzerAgentUnified-641"><span class="linenos"> 641</span></a><span class="sd">        accepte un texte structuré contenant des sections telles que &quot;ETAPES&quot; et</span>
</span><span id="AnalyzerAgentUnified-642"><a href="#AnalyzerAgentUnified-642"><span class="linenos"> 642</span></a><span class="sd">        &quot;ALGORITHME&quot;. Elle tente de localiser et de découper ces sections en fonction</span>
</span><span id="AnalyzerAgentUnified-643"><a href="#AnalyzerAgentUnified-643"><span class="linenos"> 643</span></a><span class="sd">        de plusieurs motifs prédéfinis.</span>
</span><span id="AnalyzerAgentUnified-644"><a href="#AnalyzerAgentUnified-644"><span class="linenos"> 644</span></a>
</span><span id="AnalyzerAgentUnified-645"><a href="#AnalyzerAgentUnified-645"><span class="linenos"> 645</span></a><span class="sd">        Si aucune section valide n&#39;est trouvée, la méthode retourne None.</span>
</span><span id="AnalyzerAgentUnified-646"><a href="#AnalyzerAgentUnified-646"><span class="linenos"> 646</span></a>
</span><span id="AnalyzerAgentUnified-647"><a href="#AnalyzerAgentUnified-647"><span class="linenos"> 647</span></a><span class="sd">        :param texte: Contenu textuel à partir duquel les étapes et l&#39;algorithme</span>
</span><span id="AnalyzerAgentUnified-648"><a href="#AnalyzerAgentUnified-648"><span class="linenos"> 648</span></a><span class="sd">            seront extraits.</span>
</span><span id="AnalyzerAgentUnified-649"><a href="#AnalyzerAgentUnified-649"><span class="linenos"> 649</span></a><span class="sd">        :type texte: str</span>
</span><span id="AnalyzerAgentUnified-650"><a href="#AnalyzerAgentUnified-650"><span class="linenos"> 650</span></a><span class="sd">        :return: Une paire composée des étapes extraites sous forme de texte</span>
</span><span id="AnalyzerAgentUnified-651"><a href="#AnalyzerAgentUnified-651"><span class="linenos"> 651</span></a><span class="sd">            et de l&#39;algorithme extrait. Si aucun élément n&#39;est trouvé,</span>
</span><span id="AnalyzerAgentUnified-652"><a href="#AnalyzerAgentUnified-652"><span class="linenos"> 652</span></a><span class="sd">            retourne deux valeurs None.</span>
</span><span id="AnalyzerAgentUnified-653"><a href="#AnalyzerAgentUnified-653"><span class="linenos"> 653</span></a><span class="sd">        :rtype: Tuple[Optional[str], Optional[str]]</span>
</span><span id="AnalyzerAgentUnified-654"><a href="#AnalyzerAgentUnified-654"><span class="linenos"> 654</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-655"><a href="#AnalyzerAgentUnified-655"><span class="linenos"> 655</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">texte</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texte</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-656"><a href="#AnalyzerAgentUnified-656"><span class="linenos"> 656</span></a>            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-657"><a href="#AnalyzerAgentUnified-657"><span class="linenos"> 657</span></a>
</span><span id="AnalyzerAgentUnified-658"><a href="#AnalyzerAgentUnified-658"><span class="linenos"> 658</span></a>        <span class="c1"># Patterns multiples pour extraction robuste</span>
</span><span id="AnalyzerAgentUnified-659"><a href="#AnalyzerAgentUnified-659"><span class="linenos"> 659</span></a>        <span class="n">patterns_etapes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AnalyzerAgentUnified-660"><a href="#AnalyzerAgentUnified-660"><span class="linenos"> 660</span></a>            <span class="sa">r</span><span class="s1">&#39;ETAPES?\s*:?\s*\n(.*?)(?=ALGORITHME|```|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-661"><a href="#AnalyzerAgentUnified-661"><span class="linenos"> 661</span></a>            <span class="sa">r</span><span class="s1">&#39;(\d+\..*?)(?=ALGORITHME|```|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-662"><a href="#AnalyzerAgentUnified-662"><span class="linenos"> 662</span></a>        <span class="p">]</span>
</span><span id="AnalyzerAgentUnified-663"><a href="#AnalyzerAgentUnified-663"><span class="linenos"> 663</span></a>
</span><span id="AnalyzerAgentUnified-664"><a href="#AnalyzerAgentUnified-664"><span class="linenos"> 664</span></a>        <span class="n">patterns_algo</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AnalyzerAgentUnified-665"><a href="#AnalyzerAgentUnified-665"><span class="linenos"> 665</span></a>            <span class="sa">r</span><span class="s1">&#39;ALGORITHME\s*:?\s*\n(.*?)(?=```|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-666"><a href="#AnalyzerAgentUnified-666"><span class="linenos"> 666</span></a>            <span class="sa">r</span><span class="s1">&#39;```python\s*(.*?)```&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-667"><a href="#AnalyzerAgentUnified-667"><span class="linenos"> 667</span></a>            <span class="sa">r</span><span class="s1">&#39;```\s*(.*?)```&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-668"><a href="#AnalyzerAgentUnified-668"><span class="linenos"> 668</span></a>        <span class="p">]</span>
</span><span id="AnalyzerAgentUnified-669"><a href="#AnalyzerAgentUnified-669"><span class="linenos"> 669</span></a>
</span><span id="AnalyzerAgentUnified-670"><a href="#AnalyzerAgentUnified-670"><span class="linenos"> 670</span></a>        <span class="n">etapes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-671"><a href="#AnalyzerAgentUnified-671"><span class="linenos"> 671</span></a>        <span class="n">algorithme</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-672"><a href="#AnalyzerAgentUnified-672"><span class="linenos"> 672</span></a>
</span><span id="AnalyzerAgentUnified-673"><a href="#AnalyzerAgentUnified-673"><span class="linenos"> 673</span></a>        <span class="c1"># Extraction des étapes</span>
</span><span id="AnalyzerAgentUnified-674"><a href="#AnalyzerAgentUnified-674"><span class="linenos"> 674</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_etapes</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-675"><a href="#AnalyzerAgentUnified-675"><span class="linenos"> 675</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-676"><a href="#AnalyzerAgentUnified-676"><span class="linenos"> 676</span></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">texte</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-677"><a href="#AnalyzerAgentUnified-677"><span class="linenos"> 677</span></a>                <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-678"><a href="#AnalyzerAgentUnified-678"><span class="linenos"> 678</span></a>                    <span class="n">extracted</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-679"><a href="#AnalyzerAgentUnified-679"><span class="linenos"> 679</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-680"><a href="#AnalyzerAgentUnified-680"><span class="linenos"> 680</span></a>                        <span class="n">etapes</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span id="AnalyzerAgentUnified-681"><a href="#AnalyzerAgentUnified-681"><span class="linenos"> 681</span></a>                        <span class="k">break</span>
</span><span id="AnalyzerAgentUnified-682"><a href="#AnalyzerAgentUnified-682"><span class="linenos"> 682</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-683"><a href="#AnalyzerAgentUnified-683"><span class="linenos"> 683</span></a>                <span class="k">continue</span>
</span><span id="AnalyzerAgentUnified-684"><a href="#AnalyzerAgentUnified-684"><span class="linenos"> 684</span></a>
</span><span id="AnalyzerAgentUnified-685"><a href="#AnalyzerAgentUnified-685"><span class="linenos"> 685</span></a>        <span class="c1"># Extraction de l&#39;algorithme</span>
</span><span id="AnalyzerAgentUnified-686"><a href="#AnalyzerAgentUnified-686"><span class="linenos"> 686</span></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_algo</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-687"><a href="#AnalyzerAgentUnified-687"><span class="linenos"> 687</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-688"><a href="#AnalyzerAgentUnified-688"><span class="linenos"> 688</span></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">texte</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-689"><a href="#AnalyzerAgentUnified-689"><span class="linenos"> 689</span></a>                <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-690"><a href="#AnalyzerAgentUnified-690"><span class="linenos"> 690</span></a>                    <span class="n">extracted</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-691"><a href="#AnalyzerAgentUnified-691"><span class="linenos"> 691</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-692"><a href="#AnalyzerAgentUnified-692"><span class="linenos"> 692</span></a>                        <span class="n">algorithme</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span id="AnalyzerAgentUnified-693"><a href="#AnalyzerAgentUnified-693"><span class="linenos"> 693</span></a>                        <span class="k">break</span>
</span><span id="AnalyzerAgentUnified-694"><a href="#AnalyzerAgentUnified-694"><span class="linenos"> 694</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-695"><a href="#AnalyzerAgentUnified-695"><span class="linenos"> 695</span></a>                <span class="k">continue</span>
</span><span id="AnalyzerAgentUnified-696"><a href="#AnalyzerAgentUnified-696"><span class="linenos"> 696</span></a>
</span><span id="AnalyzerAgentUnified-697"><a href="#AnalyzerAgentUnified-697"><span class="linenos"> 697</span></a>        <span class="k">return</span> <span class="n">etapes</span><span class="p">,</span> <span class="n">algorithme</span>
</span><span id="AnalyzerAgentUnified-698"><a href="#AnalyzerAgentUnified-698"><span class="linenos"> 698</span></a>
</span><span id="AnalyzerAgentUnified-699"><a href="#AnalyzerAgentUnified-699"><span class="linenos"> 699</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extraire_reponse_directe_flexible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texte</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-700"><a href="#AnalyzerAgentUnified-700"><span class="linenos"> 700</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-701"><a href="#AnalyzerAgentUnified-701"><span class="linenos"> 701</span></a><span class="sd">        Extrait une réponse directe depuis une chaîne de texte en utilisant des expressions</span>
</span><span id="AnalyzerAgentUnified-702"><a href="#AnalyzerAgentUnified-702"><span class="linenos"> 702</span></a><span class="sd">        régulières pour identifier des modèles spécifiques. Le processus tente</span>
</span><span id="AnalyzerAgentUnified-703"><a href="#AnalyzerAgentUnified-703"><span class="linenos"> 703</span></a><span class="sd">        d&#39;abord les motifs les plus restrictifs avant de passer à ceux plus généraux.</span>
</span><span id="AnalyzerAgentUnified-704"><a href="#AnalyzerAgentUnified-704"><span class="linenos"> 704</span></a>
</span><span id="AnalyzerAgentUnified-705"><a href="#AnalyzerAgentUnified-705"><span class="linenos"> 705</span></a><span class="sd">        :param texte: Chaîne de texte contenant des informations structurées</span>
</span><span id="AnalyzerAgentUnified-706"><a href="#AnalyzerAgentUnified-706"><span class="linenos"> 706</span></a><span class="sd">            à analyser.</span>
</span><span id="AnalyzerAgentUnified-707"><a href="#AnalyzerAgentUnified-707"><span class="linenos"> 707</span></a><span class="sd">        :type texte: str</span>
</span><span id="AnalyzerAgentUnified-708"><a href="#AnalyzerAgentUnified-708"><span class="linenos"> 708</span></a><span class="sd">        :return: La réponse directe extraite si trouvée et valide, ou None sinon.</span>
</span><span id="AnalyzerAgentUnified-709"><a href="#AnalyzerAgentUnified-709"><span class="linenos"> 709</span></a><span class="sd">        :rtype: str | None</span>
</span><span id="AnalyzerAgentUnified-710"><a href="#AnalyzerAgentUnified-710"><span class="linenos"> 710</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-711"><a href="#AnalyzerAgentUnified-711"><span class="linenos"> 711</span></a>
</span><span id="AnalyzerAgentUnified-712"><a href="#AnalyzerAgentUnified-712"><span class="linenos"> 712</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">texte</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texte</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">texte</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-713"><a href="#AnalyzerAgentUnified-713"><span class="linenos"> 713</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-714"><a href="#AnalyzerAgentUnified-714"><span class="linenos"> 714</span></a>
</span><span id="AnalyzerAgentUnified-715"><a href="#AnalyzerAgentUnified-715"><span class="linenos"> 715</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-716"><a href="#AnalyzerAgentUnified-716"><span class="linenos"> 716</span></a>            <span class="n">patterns_reponse</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AnalyzerAgentUnified-717"><a href="#AnalyzerAgentUnified-717"><span class="linenos"> 717</span></a>                <span class="c1"># Pattern 1: Directement après TYPE: DIRECT</span>
</span><span id="AnalyzerAgentUnified-718"><a href="#AnalyzerAgentUnified-718"><span class="linenos"> 718</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT\s*\n(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-719"><a href="#AnalyzerAgentUnified-719"><span class="linenos"> 719</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT\s+(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-720"><a href="#AnalyzerAgentUnified-720"><span class="linenos"> 720</span></a>
</span><span id="AnalyzerAgentUnified-721"><a href="#AnalyzerAgentUnified-721"><span class="linenos"> 721</span></a>                <span class="sa">r</span><span class="s1">&#39;REPONSE\s*:?\s*(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-722"><a href="#AnalyzerAgentUnified-722"><span class="linenos"> 722</span></a>                <span class="sa">r</span><span class="s1">&#39;TYPE\s*:\s*DIRECT.*?REPONSE\s*:?\s*(.*?)(?=\n\s*===|$)&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-723"><a href="#AnalyzerAgentUnified-723"><span class="linenos"> 723</span></a>                <span class="sa">r</span><span class="s1">&#39;(?:TYPE.*?\n|HISTORIQUE.*?\n)+(.*?)$&#39;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-724"><a href="#AnalyzerAgentUnified-724"><span class="linenos"> 724</span></a>            <span class="p">]</span>
</span><span id="AnalyzerAgentUnified-725"><a href="#AnalyzerAgentUnified-725"><span class="linenos"> 725</span></a>
</span><span id="AnalyzerAgentUnified-726"><a href="#AnalyzerAgentUnified-726"><span class="linenos"> 726</span></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns_reponse</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-727"><a href="#AnalyzerAgentUnified-727"><span class="linenos"> 727</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-728"><a href="#AnalyzerAgentUnified-728"><span class="linenos"> 728</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">texte</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-729"><a href="#AnalyzerAgentUnified-729"><span class="linenos"> 729</span></a>                    <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-730"><a href="#AnalyzerAgentUnified-730"><span class="linenos"> 730</span></a>                        <span class="n">reponse</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-731"><a href="#AnalyzerAgentUnified-731"><span class="linenos"> 731</span></a>                        <span class="k">if</span> <span class="n">reponse</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reponse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reponse</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
</span><span id="AnalyzerAgentUnified-732"><a href="#AnalyzerAgentUnified-732"><span class="linenos"> 732</span></a>                            <span class="c1"># Nettoyer la réponse</span>
</span><span id="AnalyzerAgentUnified-733"><a href="#AnalyzerAgentUnified-733"><span class="linenos"> 733</span></a>                            <span class="n">reponse</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reponse</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-734"><a href="#AnalyzerAgentUnified-734"><span class="linenos"> 734</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; REPONSE EXTRAITE: &#39;</span><span class="si">{</span><span class="n">reponse</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="AnalyzerAgentUnified-735"><a href="#AnalyzerAgentUnified-735"><span class="linenos"> 735</span></a>                            <span class="k">return</span> <span class="n">reponse</span>
</span><span id="AnalyzerAgentUnified-736"><a href="#AnalyzerAgentUnified-736"><span class="linenos"> 736</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-737"><a href="#AnalyzerAgentUnified-737"><span class="linenos"> 737</span></a>                    <span class="k">continue</span>
</span><span id="AnalyzerAgentUnified-738"><a href="#AnalyzerAgentUnified-738"><span class="linenos"> 738</span></a>
</span><span id="AnalyzerAgentUnified-739"><a href="#AnalyzerAgentUnified-739"><span class="linenos"> 739</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-740"><a href="#AnalyzerAgentUnified-740"><span class="linenos"> 740</span></a>
</span><span id="AnalyzerAgentUnified-741"><a href="#AnalyzerAgentUnified-741"><span class="linenos"> 741</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-742"><a href="#AnalyzerAgentUnified-742"><span class="linenos"> 742</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur extraction reponse directe: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="AnalyzerAgentUnified-743"><a href="#AnalyzerAgentUnified-743"><span class="linenos"> 743</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AnalyzerAgentUnified-744"><a href="#AnalyzerAgentUnified-744"><span class="linenos"> 744</span></a>
</span><span id="AnalyzerAgentUnified-745"><a href="#AnalyzerAgentUnified-745"><span class="linenos"> 745</span></a>
</span><span id="AnalyzerAgentUnified-746"><a href="#AnalyzerAgentUnified-746"><span class="linenos"> 746</span></a>
</span><span id="AnalyzerAgentUnified-747"><a href="#AnalyzerAgentUnified-747"><span class="linenos"> 747</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_excel_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-748"><a href="#AnalyzerAgentUnified-748"><span class="linenos"> 748</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-749"><a href="#AnalyzerAgentUnified-749"><span class="linenos"> 749</span></a><span class="sd">        Analyse le contexte d&#39;une question utilisateur pour déterminer si une analyse</span>
</span><span id="AnalyzerAgentUnified-750"><a href="#AnalyzerAgentUnified-750"><span class="linenos"> 750</span></a><span class="sd">        basée sur des calculs est nécessaire et applique des instructions adaptées en</span>
</span><span id="AnalyzerAgentUnified-751"><a href="#AnalyzerAgentUnified-751"><span class="linenos"> 751</span></a><span class="sd">        conséquence.</span>
</span><span id="AnalyzerAgentUnified-752"><a href="#AnalyzerAgentUnified-752"><span class="linenos"> 752</span></a>
</span><span id="AnalyzerAgentUnified-753"><a href="#AnalyzerAgentUnified-753"><span class="linenos"> 753</span></a><span class="sd">        Cette méthode évalue si une question utilisateur contient des mots-clés</span>
</span><span id="AnalyzerAgentUnified-754"><a href="#AnalyzerAgentUnified-754"><span class="linenos"> 754</span></a><span class="sd">        impliquant un besoin d&#39;analyse ou de calcul via l&#39;exploration de données dans</span>
</span><span id="AnalyzerAgentUnified-755"><a href="#AnalyzerAgentUnified-755"><span class="linenos"> 755</span></a><span class="sd">        un contexte donné. Si un besoin de calcul est détecté, une réponse spécifique</span>
</span><span id="AnalyzerAgentUnified-756"><a href="#AnalyzerAgentUnified-756"><span class="linenos"> 756</span></a><span class="sd">        et des instructions de calcul sont générées. Sinon, une réponse générique est</span>
</span><span id="AnalyzerAgentUnified-757"><a href="#AnalyzerAgentUnified-757"><span class="linenos"> 757</span></a><span class="sd">        assignée au contexte.</span>
</span><span id="AnalyzerAgentUnified-758"><a href="#AnalyzerAgentUnified-758"><span class="linenos"> 758</span></a>
</span><span id="AnalyzerAgentUnified-759"><a href="#AnalyzerAgentUnified-759"><span class="linenos"> 759</span></a><span class="sd">        :param state: L&#39;état courant du processus d&#39;analyse, contenant notamment la</span>
</span><span id="AnalyzerAgentUnified-760"><a href="#AnalyzerAgentUnified-760"><span class="linenos"> 760</span></a><span class="sd">            question utilisateur sous forme de chaîne de caractères et d&#39;autres</span>
</span><span id="AnalyzerAgentUnified-761"><a href="#AnalyzerAgentUnified-761"><span class="linenos"> 761</span></a><span class="sd">            informations sur le contexte.</span>
</span><span id="AnalyzerAgentUnified-762"><a href="#AnalyzerAgentUnified-762"><span class="linenos"> 762</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-763"><a href="#AnalyzerAgentUnified-763"><span class="linenos"> 763</span></a><span class="sd">        :param historique_contexte: L&#39;historique du contexte pour maintenir une traçabilité</span>
</span><span id="AnalyzerAgentUnified-764"><a href="#AnalyzerAgentUnified-764"><span class="linenos"> 764</span></a><span class="sd">            des interactions.</span>
</span><span id="AnalyzerAgentUnified-765"><a href="#AnalyzerAgentUnified-765"><span class="linenos"> 765</span></a><span class="sd">        :type historique_contexte: list</span>
</span><span id="AnalyzerAgentUnified-766"><a href="#AnalyzerAgentUnified-766"><span class="linenos"> 766</span></a><span class="sd">        :return: Cette méthode ne retourne rien. Elle modifie directement le dictionnaire</span>
</span><span id="AnalyzerAgentUnified-767"><a href="#AnalyzerAgentUnified-767"><span class="linenos"> 767</span></a><span class="sd">            `state` en fonction de l&#39;analyse réalisée.</span>
</span><span id="AnalyzerAgentUnified-768"><a href="#AnalyzerAgentUnified-768"><span class="linenos"> 768</span></a><span class="sd">        :rtype: None</span>
</span><span id="AnalyzerAgentUnified-769"><a href="#AnalyzerAgentUnified-769"><span class="linenos"> 769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-770"><a href="#AnalyzerAgentUnified-770"><span class="linenos"> 770</span></a>        <span class="n">question</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="AnalyzerAgentUnified-771"><a href="#AnalyzerAgentUnified-771"><span class="linenos"> 771</span></a>
</span><span id="AnalyzerAgentUnified-772"><a href="#AnalyzerAgentUnified-772"><span class="linenos"> 772</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;combien&#39;</span><span class="p">,</span> <span class="s1">&#39;pourcentage&#39;</span><span class="p">,</span> <span class="s1">&#39;calcul&#39;</span><span class="p">,</span> <span class="s1">&#39;analyse&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">]):</span>
</span><span id="AnalyzerAgentUnified-773"><a href="#AnalyzerAgentUnified-773"><span class="linenos"> 773</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AnalyzerAgentUnified-774"><a href="#AnalyzerAgentUnified-774"><span class="linenos"> 774</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;instruction_calcul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyser les données pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-775"><a href="#AnalyzerAgentUnified-775"><span class="linenos"> 775</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;algo_genere&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;# Analyse fallback</span><span class="se">\n</span><span class="s2">resultat = df0.describe()&quot;</span>
</span><span id="AnalyzerAgentUnified-776"><a href="#AnalyzerAgentUnified-776"><span class="linenos"> 776</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; FALLBACK EXCEL - Calculs forcés&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-777"><a href="#AnalyzerAgentUnified-777"><span class="linenos"> 777</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-778"><a href="#AnalyzerAgentUnified-778"><span class="linenos"> 778</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-779"><a href="#AnalyzerAgentUnified-779"><span class="linenos"> 779</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Analyse en cours pour : </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_utilisateur&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-780"><a href="#AnalyzerAgentUnified-780"><span class="linenos"> 780</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot; FALLBACK EXCEL - Réponse directe&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-781"><a href="#AnalyzerAgentUnified-781"><span class="linenos"> 781</span></a>
</span><span id="AnalyzerAgentUnified-782"><a href="#AnalyzerAgentUnified-782"><span class="linenos"> 782</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_excel_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-783"><a href="#AnalyzerAgentUnified-783"><span class="linenos"> 783</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-784"><a href="#AnalyzerAgentUnified-784"><span class="linenos"> 784</span></a><span class="sd">        Gère une erreur technique liée à Excel en modifiant l&#39;état fourni et en enregistrant un message d&#39;erreur.</span>
</span><span id="AnalyzerAgentUnified-785"><a href="#AnalyzerAgentUnified-785"><span class="linenos"> 785</span></a>
</span><span id="AnalyzerAgentUnified-786"><a href="#AnalyzerAgentUnified-786"><span class="linenos"> 786</span></a><span class="sd">        L&#39;état est mis à jour pour indiquer qu&#39;aucun calcul supplémentaire n&#39;est nécessaire, et un message d&#39;erreur</span>
</span><span id="AnalyzerAgentUnified-787"><a href="#AnalyzerAgentUnified-787"><span class="linenos"> 787</span></a><span class="sd">        est enregistré pour permettre un retour clair à l&#39;utilisateur.</span>
</span><span id="AnalyzerAgentUnified-788"><a href="#AnalyzerAgentUnified-788"><span class="linenos"> 788</span></a>
</span><span id="AnalyzerAgentUnified-789"><a href="#AnalyzerAgentUnified-789"><span class="linenos"> 789</span></a><span class="sd">        :param error: Objet représentant l&#39;erreur technique capturée.</span>
</span><span id="AnalyzerAgentUnified-790"><a href="#AnalyzerAgentUnified-790"><span class="linenos"> 790</span></a><span class="sd">        :type error: Exception</span>
</span><span id="AnalyzerAgentUnified-791"><a href="#AnalyzerAgentUnified-791"><span class="linenos"> 791</span></a><span class="sd">        :param state: Dictionnaire représentant l&#39;état courant, qui sera modifié pour inclure l&#39;information liée à l&#39;erreur.</span>
</span><span id="AnalyzerAgentUnified-792"><a href="#AnalyzerAgentUnified-792"><span class="linenos"> 792</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-793"><a href="#AnalyzerAgentUnified-793"><span class="linenos"> 793</span></a><span class="sd">        :return: Aucun retour explicite. L&#39;état est modifié directement.</span>
</span><span id="AnalyzerAgentUnified-794"><a href="#AnalyzerAgentUnified-794"><span class="linenos"> 794</span></a><span class="sd">        :rtype: None</span>
</span><span id="AnalyzerAgentUnified-795"><a href="#AnalyzerAgentUnified-795"><span class="linenos"> 795</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-796"><a href="#AnalyzerAgentUnified-796"><span class="linenos"> 796</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;besoin_calculs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AnalyzerAgentUnified-797"><a href="#AnalyzerAgentUnified-797"><span class="linenos"> 797</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;reponse_finale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erreur technique Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span id="AnalyzerAgentUnified-798"><a href="#AnalyzerAgentUnified-798"><span class="linenos"> 798</span></a>
</span><span id="AnalyzerAgentUnified-799"><a href="#AnalyzerAgentUnified-799"><span class="linenos"> 799</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_preparer_contexte_excel_avec_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-800"><a href="#AnalyzerAgentUnified-800"><span class="linenos"> 800</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-801"><a href="#AnalyzerAgentUnified-801"><span class="linenos"> 801</span></a><span class="sd">        Prépare un contexte Excel avec des métadonnées pour l&#39;analyse.</span>
</span><span id="AnalyzerAgentUnified-802"><a href="#AnalyzerAgentUnified-802"><span class="linenos"> 802</span></a>
</span><span id="AnalyzerAgentUnified-803"><a href="#AnalyzerAgentUnified-803"><span class="linenos"> 803</span></a><span class="sd">        Cette fonction génère une chaîne de caractères décrivant les données disponibles</span>
</span><span id="AnalyzerAgentUnified-804"><a href="#AnalyzerAgentUnified-804"><span class="linenos"> 804</span></a><span class="sd">        pour l&#39;analyse, notamment les tableaux et dataframes présents, leur structure,</span>
</span><span id="AnalyzerAgentUnified-805"><a href="#AnalyzerAgentUnified-805"><span class="linenos"> 805</span></a><span class="sd">        et les colonnes qu&#39;ils contiennent. Cela inclut des détails tels que le titre</span>
</span><span id="AnalyzerAgentUnified-806"><a href="#AnalyzerAgentUnified-806"><span class="linenos"> 806</span></a><span class="sd">        contextuel, le fichier source et la feuille associée. Seules les colonnes</span>
</span><span id="AnalyzerAgentUnified-807"><a href="#AnalyzerAgentUnified-807"><span class="linenos"> 807</span></a><span class="sd">        des cinq premières colonnes sont affichées pour chaque dataframe.</span>
</span><span id="AnalyzerAgentUnified-808"><a href="#AnalyzerAgentUnified-808"><span class="linenos"> 808</span></a>
</span><span id="AnalyzerAgentUnified-809"><a href="#AnalyzerAgentUnified-809"><span class="linenos"> 809</span></a><span class="sd">        :param state: Un dictionnaire contenant des informations sur les tableaux importés</span>
</span><span id="AnalyzerAgentUnified-810"><a href="#AnalyzerAgentUnified-810"><span class="linenos"> 810</span></a><span class="sd">                      et les dataframes correspondants, avec les clés &#39;tableaux_pour_upload&#39;</span>
</span><span id="AnalyzerAgentUnified-811"><a href="#AnalyzerAgentUnified-811"><span class="linenos"> 811</span></a><span class="sd">                      et &#39;dataframes&#39;.</span>
</span><span id="AnalyzerAgentUnified-812"><a href="#AnalyzerAgentUnified-812"><span class="linenos"> 812</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-813"><a href="#AnalyzerAgentUnified-813"><span class="linenos"> 813</span></a>
</span><span id="AnalyzerAgentUnified-814"><a href="#AnalyzerAgentUnified-814"><span class="linenos"> 814</span></a><span class="sd">        :return: Une chaîne de caractères contenant un résumé formaté des tableaux et</span>
</span><span id="AnalyzerAgentUnified-815"><a href="#AnalyzerAgentUnified-815"><span class="linenos"> 815</span></a><span class="sd">                 dataframes disponibles pour l&#39;analyse.</span>
</span><span id="AnalyzerAgentUnified-816"><a href="#AnalyzerAgentUnified-816"><span class="linenos"> 816</span></a><span class="sd">        :rtype: str</span>
</span><span id="AnalyzerAgentUnified-817"><a href="#AnalyzerAgentUnified-817"><span class="linenos"> 817</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-818"><a href="#AnalyzerAgentUnified-818"><span class="linenos"> 818</span></a>        <span class="n">contexte</span> <span class="o">=</span> <span class="s2">&quot;DONNÉES DISPONIBLES POUR L&#39;ANALYSE:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-819"><a href="#AnalyzerAgentUnified-819"><span class="linenos"> 819</span></a>        <span class="n">tableaux_a_analyser</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tableaux_pour_upload&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="AnalyzerAgentUnified-820"><a href="#AnalyzerAgentUnified-820"><span class="linenos"> 820</span></a>        <span class="n">dataframes_a_analyser</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataframes&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="AnalyzerAgentUnified-821"><a href="#AnalyzerAgentUnified-821"><span class="linenos"> 821</span></a>
</span><span id="AnalyzerAgentUnified-822"><a href="#AnalyzerAgentUnified-822"><span class="linenos"> 822</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">tableau</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tableaux_a_analyser</span><span class="p">,</span> <span class="n">dataframes_a_analyser</span><span class="p">)):</span>
</span><span id="AnalyzerAgentUnified-823"><a href="#AnalyzerAgentUnified-823"><span class="linenos"> 823</span></a>            <span class="n">titre</span> <span class="o">=</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titre_contextuel&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Tableau </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-824"><a href="#AnalyzerAgentUnified-824"><span class="linenos"> 824</span></a>            <span class="n">source</span> <span class="o">=</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fichier_source&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-825"><a href="#AnalyzerAgentUnified-825"><span class="linenos"> 825</span></a>            <span class="n">feuille</span> <span class="o">=</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nom_feuille&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-826"><a href="#AnalyzerAgentUnified-826"><span class="linenos"> 826</span></a>
</span><span id="AnalyzerAgentUnified-827"><a href="#AnalyzerAgentUnified-827"><span class="linenos"> 827</span></a>            <span class="n">contexte</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;DATAFRAME df</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: &quot;</span><span class="si">{</span><span class="n">titre</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AnalyzerAgentUnified-828"><a href="#AnalyzerAgentUnified-828"><span class="linenos"> 828</span></a><span class="s2">   Source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> -&gt; Feuille &quot;</span><span class="si">{</span><span class="n">feuille</span><span class="si">}</span><span class="s2">&quot; </span>
</span><span id="AnalyzerAgentUnified-829"><a href="#AnalyzerAgentUnified-829"><span class="linenos"> 829</span></a><span class="s2">   Structure: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> lignes × </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> colonnes</span>
</span><span id="AnalyzerAgentUnified-830"><a href="#AnalyzerAgentUnified-830"><span class="linenos"> 830</span></a><span class="s2">   Colonnes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="si">}</span>
</span><span id="AnalyzerAgentUnified-831"><a href="#AnalyzerAgentUnified-831"><span class="linenos"> 831</span></a>
</span><span id="AnalyzerAgentUnified-832"><a href="#AnalyzerAgentUnified-832"><span class="linenos"> 832</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-833"><a href="#AnalyzerAgentUnified-833"><span class="linenos"> 833</span></a>        <span class="k">return</span> <span class="n">contexte</span>
</span><span id="AnalyzerAgentUnified-834"><a href="#AnalyzerAgentUnified-834"><span class="linenos"> 834</span></a>
</span><span id="AnalyzerAgentUnified-835"><a href="#AnalyzerAgentUnified-835"><span class="linenos"> 835</span></a>
</span><span id="AnalyzerAgentUnified-836"><a href="#AnalyzerAgentUnified-836"><span class="linenos"> 836</span></a>
</span><span id="AnalyzerAgentUnified-837"><a href="#AnalyzerAgentUnified-837"><span class="linenos"> 837</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_creer_dataframes_valides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableaux_charges</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-838"><a href="#AnalyzerAgentUnified-838"><span class="linenos"> 838</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-839"><a href="#AnalyzerAgentUnified-839"><span class="linenos"> 839</span></a><span class="sd">        Génère une liste de DataFrames valides à partir d&#39;une liste de tableaux</span>
</span><span id="AnalyzerAgentUnified-840"><a href="#AnalyzerAgentUnified-840"><span class="linenos"> 840</span></a><span class="sd">        fournis en entrée. Chaque DataFrame passe par un processus de nettoyage,</span>
</span><span id="AnalyzerAgentUnified-841"><a href="#AnalyzerAgentUnified-841"><span class="linenos"> 841</span></a><span class="sd">        puis est complété avec des méta-données provenant des tableaux d&#39;origine.</span>
</span><span id="AnalyzerAgentUnified-842"><a href="#AnalyzerAgentUnified-842"><span class="linenos"> 842</span></a><span class="sd">        Si une erreur survient lors de la création ou du nettoyage d&#39;un DataFrame,</span>
</span><span id="AnalyzerAgentUnified-843"><a href="#AnalyzerAgentUnified-843"><span class="linenos"> 843</span></a><span class="sd">        l&#39;erreur est enregistrée mais l&#39;exécution continue pour les tableaux</span>
</span><span id="AnalyzerAgentUnified-844"><a href="#AnalyzerAgentUnified-844"><span class="linenos"> 844</span></a><span class="sd">        suivants.</span>
</span><span id="AnalyzerAgentUnified-845"><a href="#AnalyzerAgentUnified-845"><span class="linenos"> 845</span></a>
</span><span id="AnalyzerAgentUnified-846"><a href="#AnalyzerAgentUnified-846"><span class="linenos"> 846</span></a><span class="sd">        :param tableaux_charges: Liste de dictionnaires représentant les tableaux</span>
</span><span id="AnalyzerAgentUnified-847"><a href="#AnalyzerAgentUnified-847"><span class="linenos"> 847</span></a><span class="sd">            à convertir en DataFrames. Chaque dictionnaire doit inclure des</span>
</span><span id="AnalyzerAgentUnified-848"><a href="#AnalyzerAgentUnified-848"><span class="linenos"> 848</span></a><span class="sd">            informations comme le titre contextuel, le fichier source, et le nom</span>
</span><span id="AnalyzerAgentUnified-849"><a href="#AnalyzerAgentUnified-849"><span class="linenos"> 849</span></a><span class="sd">            de la feuille (si applicables).</span>
</span><span id="AnalyzerAgentUnified-850"><a href="#AnalyzerAgentUnified-850"><span class="linenos"> 850</span></a><span class="sd">        :type tableaux_charges: list[dict]</span>
</span><span id="AnalyzerAgentUnified-851"><a href="#AnalyzerAgentUnified-851"><span class="linenos"> 851</span></a><span class="sd">        :param state: Dictionnaire ou objet contenant l&#39;état actuel, utilisé</span>
</span><span id="AnalyzerAgentUnified-852"><a href="#AnalyzerAgentUnified-852"><span class="linenos"> 852</span></a><span class="sd">            pour enregistrer des informations concernant les erreurs</span>
</span><span id="AnalyzerAgentUnified-853"><a href="#AnalyzerAgentUnified-853"><span class="linenos"> 853</span></a><span class="sd">            ou événements lors du processus.</span>
</span><span id="AnalyzerAgentUnified-854"><a href="#AnalyzerAgentUnified-854"><span class="linenos"> 854</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-855"><a href="#AnalyzerAgentUnified-855"><span class="linenos"> 855</span></a><span class="sd">        :return: Liste de pandas DataFrames valides, accompagnés</span>
</span><span id="AnalyzerAgentUnified-856"><a href="#AnalyzerAgentUnified-856"><span class="linenos"> 856</span></a><span class="sd">            de leurs méta-données.</span>
</span><span id="AnalyzerAgentUnified-857"><a href="#AnalyzerAgentUnified-857"><span class="linenos"> 857</span></a><span class="sd">        :rtype: list[pandas.DataFrame]</span>
</span><span id="AnalyzerAgentUnified-858"><a href="#AnalyzerAgentUnified-858"><span class="linenos"> 858</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-859"><a href="#AnalyzerAgentUnified-859"><span class="linenos"> 859</span></a>        <span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-860"><a href="#AnalyzerAgentUnified-860"><span class="linenos"> 860</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tableau</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tableaux_charges</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-861"><a href="#AnalyzerAgentUnified-861"><span class="linenos"> 861</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-862"><a href="#AnalyzerAgentUnified-862"><span class="linenos"> 862</span></a>                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">pandas_agent</span><span class="o">.</span><span class="n">creer_dataframe_propre</span><span class="p">(</span><span class="n">tableau</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-863"><a href="#AnalyzerAgentUnified-863"><span class="linenos"> 863</span></a>                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-864"><a href="#AnalyzerAgentUnified-864"><span class="linenos"> 864</span></a>                    <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="AnalyzerAgentUnified-865"><a href="#AnalyzerAgentUnified-865"><span class="linenos"> 865</span></a>                        <span class="s1">&#39;titre&#39;</span><span class="p">:</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titre_contextuel&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Tableau </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
</span><span id="AnalyzerAgentUnified-866"><a href="#AnalyzerAgentUnified-866"><span class="linenos"> 866</span></a>                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fichier_source&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
</span><span id="AnalyzerAgentUnified-867"><a href="#AnalyzerAgentUnified-867"><span class="linenos"> 867</span></a>                        <span class="s1">&#39;feuille&#39;</span><span class="p">:</span> <span class="n">tableau</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nom_feuille&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
</span><span id="AnalyzerAgentUnified-868"><a href="#AnalyzerAgentUnified-868"><span class="linenos"> 868</span></a>                    <span class="p">})</span>
</span><span id="AnalyzerAgentUnified-869"><a href="#AnalyzerAgentUnified-869"><span class="linenos"> 869</span></a>                    <span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-870"><a href="#AnalyzerAgentUnified-870"><span class="linenos"> 870</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-871"><a href="#AnalyzerAgentUnified-871"><span class="linenos"> 871</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Création DataFrame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-872"><a href="#AnalyzerAgentUnified-872"><span class="linenos"> 872</span></a>        <span class="k">return</span> <span class="n">dataframes</span>
</span><span id="AnalyzerAgentUnified-873"><a href="#AnalyzerAgentUnified-873"><span class="linenos"> 873</span></a>
</span><span id="AnalyzerAgentUnified-874"><a href="#AnalyzerAgentUnified-874"><span class="linenos"> 874</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_creer_csvs_pour_gemini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-875"><a href="#AnalyzerAgentUnified-875"><span class="linenos"> 875</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-876"><a href="#AnalyzerAgentUnified-876"><span class="linenos"> 876</span></a><span class="sd">        Génère un ensemble de fichiers CSV à partir d&#39;une liste de DataFrames fournie.</span>
</span><span id="AnalyzerAgentUnified-877"><a href="#AnalyzerAgentUnified-877"><span class="linenos"> 877</span></a><span class="sd">        Chaque DataFrame valide (non vide et non nul) est converti en fichier CSV et nommé</span>
</span><span id="AnalyzerAgentUnified-878"><a href="#AnalyzerAgentUnified-878"><span class="linenos"> 878</span></a><span class="sd">        de manière incrémentale. Retourne une liste des noms de fichiers CSV créés. En cas</span>
</span><span id="AnalyzerAgentUnified-879"><a href="#AnalyzerAgentUnified-879"><span class="linenos"> 879</span></a><span class="sd">        d&#39;erreur, un message est enregistré dans le journal.</span>
</span><span id="AnalyzerAgentUnified-880"><a href="#AnalyzerAgentUnified-880"><span class="linenos"> 880</span></a>
</span><span id="AnalyzerAgentUnified-881"><a href="#AnalyzerAgentUnified-881"><span class="linenos"> 881</span></a><span class="sd">        :param dataframes: Liste de pandas.DataFrame à convertir en fichiers CSV</span>
</span><span id="AnalyzerAgentUnified-882"><a href="#AnalyzerAgentUnified-882"><span class="linenos"> 882</span></a><span class="sd">        :param state: État actuel du programme, utilisé pour consigner les erreurs dans le journal</span>
</span><span id="AnalyzerAgentUnified-883"><a href="#AnalyzerAgentUnified-883"><span class="linenos"> 883</span></a><span class="sd">        :return: Liste des chemins des fichiers CSV générés</span>
</span><span id="AnalyzerAgentUnified-884"><a href="#AnalyzerAgentUnified-884"><span class="linenos"> 884</span></a><span class="sd">        :rtype: list</span>
</span><span id="AnalyzerAgentUnified-885"><a href="#AnalyzerAgentUnified-885"><span class="linenos"> 885</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-886"><a href="#AnalyzerAgentUnified-886"><span class="linenos"> 886</span></a>        <span class="n">fichiers_csv</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-887"><a href="#AnalyzerAgentUnified-887"><span class="linenos"> 887</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-888"><a href="#AnalyzerAgentUnified-888"><span class="linenos"> 888</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataframes</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-889"><a href="#AnalyzerAgentUnified-889"><span class="linenos"> 889</span></a>                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-890"><a href="#AnalyzerAgentUnified-890"><span class="linenos"> 890</span></a>                    <span class="n">nom_fichier</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;df</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_analysis.csv&#39;</span>
</span><span id="AnalyzerAgentUnified-891"><a href="#AnalyzerAgentUnified-891"><span class="linenos"> 891</span></a>                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">nom_fichier</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-892"><a href="#AnalyzerAgentUnified-892"><span class="linenos"> 892</span></a>                    <span class="n">fichiers_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nom_fichier</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-893"><a href="#AnalyzerAgentUnified-893"><span class="linenos"> 893</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-894"><a href="#AnalyzerAgentUnified-894"><span class="linenos"> 894</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur création CSV: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-895"><a href="#AnalyzerAgentUnified-895"><span class="linenos"> 895</span></a>        <span class="k">return</span> <span class="n">fichiers_csv</span>
</span><span id="AnalyzerAgentUnified-896"><a href="#AnalyzerAgentUnified-896"><span class="linenos"> 896</span></a>
</span><span id="AnalyzerAgentUnified-897"><a href="#AnalyzerAgentUnified-897"><span class="linenos"> 897</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_upload_fichier_to_gemini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fichiers_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-898"><a href="#AnalyzerAgentUnified-898"><span class="linenos"> 898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-899"><a href="#AnalyzerAgentUnified-899"><span class="linenos"> 899</span></a><span class="sd">        Télécharge une liste de fichiers CSV vers Gemini via l&#39;API.</span>
</span><span id="AnalyzerAgentUnified-900"><a href="#AnalyzerAgentUnified-900"><span class="linenos"> 900</span></a>
</span><span id="AnalyzerAgentUnified-901"><a href="#AnalyzerAgentUnified-901"><span class="linenos"> 901</span></a><span class="sd">        Cette méthode reçoit une liste de fichiers CSV, les télécharge vers la plateforme</span>
</span><span id="AnalyzerAgentUnified-902"><a href="#AnalyzerAgentUnified-902"><span class="linenos"> 902</span></a><span class="sd">        Gemini à l&#39;aide de son API, et retourne les fichiers téléchargés ainsi que</span>
</span><span id="AnalyzerAgentUnified-903"><a href="#AnalyzerAgentUnified-903"><span class="linenos"> 903</span></a><span class="sd">        le client utilisé pour l&#39;opération. En cas d&#39;échec, une exception est levée</span>
</span><span id="AnalyzerAgentUnified-904"><a href="#AnalyzerAgentUnified-904"><span class="linenos"> 904</span></a><span class="sd">        et consignée dans les journaux d&#39;erreur.</span>
</span><span id="AnalyzerAgentUnified-905"><a href="#AnalyzerAgentUnified-905"><span class="linenos"> 905</span></a>
</span><span id="AnalyzerAgentUnified-906"><a href="#AnalyzerAgentUnified-906"><span class="linenos"> 906</span></a><span class="sd">        :param fichiers_csv: Liste des fichiers CSV à télécharger.</span>
</span><span id="AnalyzerAgentUnified-907"><a href="#AnalyzerAgentUnified-907"><span class="linenos"> 907</span></a><span class="sd">        :type fichiers_csv: list[str]</span>
</span><span id="AnalyzerAgentUnified-908"><a href="#AnalyzerAgentUnified-908"><span class="linenos"> 908</span></a><span class="sd">        :param state: État ou contexte lié au processus actuel utilisé pour journaliser</span>
</span><span id="AnalyzerAgentUnified-909"><a href="#AnalyzerAgentUnified-909"><span class="linenos"> 909</span></a><span class="sd">            des erreurs.</span>
</span><span id="AnalyzerAgentUnified-910"><a href="#AnalyzerAgentUnified-910"><span class="linenos"> 910</span></a><span class="sd">        :type state: Any</span>
</span><span id="AnalyzerAgentUnified-911"><a href="#AnalyzerAgentUnified-911"><span class="linenos"> 911</span></a><span class="sd">        :return: Une liste des fichiers téléchargés et le client utilisé pour l&#39;opération.</span>
</span><span id="AnalyzerAgentUnified-912"><a href="#AnalyzerAgentUnified-912"><span class="linenos"> 912</span></a><span class="sd">        :rtype: tuple[list[object], genai.Client]</span>
</span><span id="AnalyzerAgentUnified-913"><a href="#AnalyzerAgentUnified-913"><span class="linenos"> 913</span></a><span class="sd">        :raises Exception: Si une erreur survient lors du téléchargement des fichiers.</span>
</span><span id="AnalyzerAgentUnified-914"><a href="#AnalyzerAgentUnified-914"><span class="linenos"> 914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-915"><a href="#AnalyzerAgentUnified-915"><span class="linenos"> 915</span></a>        <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-916"><a href="#AnalyzerAgentUnified-916"><span class="linenos"> 916</span></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">genai</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-917"><a href="#AnalyzerAgentUnified-917"><span class="linenos"> 917</span></a>        <span class="n">fichiers_gemini</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AnalyzerAgentUnified-918"><a href="#AnalyzerAgentUnified-918"><span class="linenos"> 918</span></a>        <span class="k">for</span> <span class="n">fichier_csv</span> <span class="ow">in</span> <span class="n">fichiers_csv</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-919"><a href="#AnalyzerAgentUnified-919"><span class="linenos"> 919</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-920"><a href="#AnalyzerAgentUnified-920"><span class="linenos"> 920</span></a>                <span class="n">fichier_uploade</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">fichier_csv</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-921"><a href="#AnalyzerAgentUnified-921"><span class="linenos"> 921</span></a>                <span class="n">fichiers_gemini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fichier_uploade</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-922"><a href="#AnalyzerAgentUnified-922"><span class="linenos"> 922</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-923"><a href="#AnalyzerAgentUnified-923"><span class="linenos"> 923</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur upload </span><span class="si">{</span><span class="n">fichier_csv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-924"><a href="#AnalyzerAgentUnified-924"><span class="linenos"> 924</span></a>                <span class="k">raise</span> <span class="n">e</span>
</span><span id="AnalyzerAgentUnified-925"><a href="#AnalyzerAgentUnified-925"><span class="linenos"> 925</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_nettoyer_csvs_temporaires</span><span class="p">(</span><span class="n">fichiers_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-926"><a href="#AnalyzerAgentUnified-926"><span class="linenos"> 926</span></a>        <span class="k">return</span> <span class="n">fichiers_gemini</span><span class="p">,</span> <span class="n">client</span>
</span><span id="AnalyzerAgentUnified-927"><a href="#AnalyzerAgentUnified-927"><span class="linenos"> 927</span></a>
</span><span id="AnalyzerAgentUnified-928"><a href="#AnalyzerAgentUnified-928"><span class="linenos"> 928</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_nettoyer_fichiers_gemini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fichiers_gemini</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-929"><a href="#AnalyzerAgentUnified-929"><span class="linenos"> 929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-930"><a href="#AnalyzerAgentUnified-930"><span class="linenos"> 930</span></a><span class="sd">        Nettoie une liste de fichiers Gemini en supprimant chacun d&#39;entre eux via le client spécifié.</span>
</span><span id="AnalyzerAgentUnified-931"><a href="#AnalyzerAgentUnified-931"><span class="linenos"> 931</span></a><span class="sd">        En cas d&#39;erreur lors de la suppression d&#39;un fichier, l&#39;erreur est enregistrée à l&#39;aide</span>
</span><span id="AnalyzerAgentUnified-932"><a href="#AnalyzerAgentUnified-932"><span class="linenos"> 932</span></a><span class="sd">        du système de journalisation du chatbot.</span>
</span><span id="AnalyzerAgentUnified-933"><a href="#AnalyzerAgentUnified-933"><span class="linenos"> 933</span></a>
</span><span id="AnalyzerAgentUnified-934"><a href="#AnalyzerAgentUnified-934"><span class="linenos"> 934</span></a><span class="sd">        :param fichiers_gemini: Liste des fichiers Gemini à supprimer.</span>
</span><span id="AnalyzerAgentUnified-935"><a href="#AnalyzerAgentUnified-935"><span class="linenos"> 935</span></a><span class="sd">        :param client: Instance du client utilisé pour la suppression des fichiers.</span>
</span><span id="AnalyzerAgentUnified-936"><a href="#AnalyzerAgentUnified-936"><span class="linenos"> 936</span></a><span class="sd">        :param state: Objet représentant l&#39;état à utiliser pour enregistrer les erreurs.</span>
</span><span id="AnalyzerAgentUnified-937"><a href="#AnalyzerAgentUnified-937"><span class="linenos"> 937</span></a><span class="sd">        :return: Aucun.</span>
</span><span id="AnalyzerAgentUnified-938"><a href="#AnalyzerAgentUnified-938"><span class="linenos"> 938</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-939"><a href="#AnalyzerAgentUnified-939"><span class="linenos"> 939</span></a>        <span class="k">for</span> <span class="n">fichier</span> <span class="ow">in</span> <span class="n">fichiers_gemini</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-940"><a href="#AnalyzerAgentUnified-940"><span class="linenos"> 940</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-941"><a href="#AnalyzerAgentUnified-941"><span class="linenos"> 941</span></a>                <span class="n">client</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fichier</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-942"><a href="#AnalyzerAgentUnified-942"><span class="linenos"> 942</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-943"><a href="#AnalyzerAgentUnified-943"><span class="linenos"> 943</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur suppression Gemini: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-944"><a href="#AnalyzerAgentUnified-944"><span class="linenos"> 944</span></a>
</span><span id="AnalyzerAgentUnified-945"><a href="#AnalyzerAgentUnified-945"><span class="linenos"> 945</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_nettoyer_csvs_temporaires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fichiers_csv</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-946"><a href="#AnalyzerAgentUnified-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-947"><a href="#AnalyzerAgentUnified-947"><span class="linenos"> 947</span></a><span class="sd">        Supprime les fichiers CSV temporaires spécifiés.</span>
</span><span id="AnalyzerAgentUnified-948"><a href="#AnalyzerAgentUnified-948"><span class="linenos"> 948</span></a>
</span><span id="AnalyzerAgentUnified-949"><a href="#AnalyzerAgentUnified-949"><span class="linenos"> 949</span></a><span class="sd">        Cette méthode parcourt une liste de fichiers CSV et tente de les supprimer s&#39;ils</span>
</span><span id="AnalyzerAgentUnified-950"><a href="#AnalyzerAgentUnified-950"><span class="linenos"> 950</span></a><span class="sd">        existent. En cas d&#39;erreur lors de la suppression, un message d&#39;erreur est</span>
</span><span id="AnalyzerAgentUnified-951"><a href="#AnalyzerAgentUnified-951"><span class="linenos"> 951</span></a><span class="sd">        enregistré grâce à la méthode `_log_error` de l&#39;objet chatbot. Cette méthode est</span>
</span><span id="AnalyzerAgentUnified-952"><a href="#AnalyzerAgentUnified-952"><span class="linenos"> 952</span></a><span class="sd">        utile pour nettoyer les fichiers temporaires inutilisés après leur traitement.</span>
</span><span id="AnalyzerAgentUnified-953"><a href="#AnalyzerAgentUnified-953"><span class="linenos"> 953</span></a>
</span><span id="AnalyzerAgentUnified-954"><a href="#AnalyzerAgentUnified-954"><span class="linenos"> 954</span></a><span class="sd">        :param fichiers_csv: Une liste contenant les chemins des fichiers CSV à supprimer.</span>
</span><span id="AnalyzerAgentUnified-955"><a href="#AnalyzerAgentUnified-955"><span class="linenos"> 955</span></a><span class="sd">        :type fichiers_csv: list[str]</span>
</span><span id="AnalyzerAgentUnified-956"><a href="#AnalyzerAgentUnified-956"><span class="linenos"> 956</span></a><span class="sd">        :param state: État ou contexte utilisé pour enregistrer les erreurs pendant la suppression.</span>
</span><span id="AnalyzerAgentUnified-957"><a href="#AnalyzerAgentUnified-957"><span class="linenos"> 957</span></a><span class="sd">        :type state: Any</span>
</span><span id="AnalyzerAgentUnified-958"><a href="#AnalyzerAgentUnified-958"><span class="linenos"> 958</span></a><span class="sd">        :return: Cette fonction ne renvoie aucune valeur.</span>
</span><span id="AnalyzerAgentUnified-959"><a href="#AnalyzerAgentUnified-959"><span class="linenos"> 959</span></a><span class="sd">        :rtype: None</span>
</span><span id="AnalyzerAgentUnified-960"><a href="#AnalyzerAgentUnified-960"><span class="linenos"> 960</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-961"><a href="#AnalyzerAgentUnified-961"><span class="linenos"> 961</span></a>        <span class="k">for</span> <span class="n">fichier</span> <span class="ow">in</span> <span class="n">fichiers_csv</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-962"><a href="#AnalyzerAgentUnified-962"><span class="linenos"> 962</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-963"><a href="#AnalyzerAgentUnified-963"><span class="linenos"> 963</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fichier</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-964"><a href="#AnalyzerAgentUnified-964"><span class="linenos"> 964</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fichier</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-965"><a href="#AnalyzerAgentUnified-965"><span class="linenos"> 965</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-966"><a href="#AnalyzerAgentUnified-966"><span class="linenos"> 966</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur suppression </span><span class="si">{</span><span class="n">fichier</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-967"><a href="#AnalyzerAgentUnified-967"><span class="linenos"> 967</span></a>
</span><span id="AnalyzerAgentUnified-968"><a href="#AnalyzerAgentUnified-968"><span class="linenos"> 968</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_gemini_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-969"><a href="#AnalyzerAgentUnified-969"><span class="linenos"> 969</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-970"><a href="#AnalyzerAgentUnified-970"><span class="linenos"> 970</span></a><span class="sd">        Exécute un appel à l&#39;API Gemini avec des tentatives automatiques en cas de</span>
</span><span id="AnalyzerAgentUnified-971"><a href="#AnalyzerAgentUnified-971"><span class="linenos"> 971</span></a><span class="sd">        défaillances. Cette méthode effectue un maximum de `max_retries` tentatives</span>
</span><span id="AnalyzerAgentUnified-972"><a href="#AnalyzerAgentUnified-972"><span class="linenos"> 972</span></a><span class="sd">        avant de lever une exception en cas d&#39;échec.</span>
</span><span id="AnalyzerAgentUnified-973"><a href="#AnalyzerAgentUnified-973"><span class="linenos"> 973</span></a>
</span><span id="AnalyzerAgentUnified-974"><a href="#AnalyzerAgentUnified-974"><span class="linenos"> 974</span></a><span class="sd">        Les délais entre les tentatives augmentent de manière exponentielle, suivant</span>
</span><span id="AnalyzerAgentUnified-975"><a href="#AnalyzerAgentUnified-975"><span class="linenos"> 975</span></a><span class="sd">        la formule 2 ** attempt.</span>
</span><span id="AnalyzerAgentUnified-976"><a href="#AnalyzerAgentUnified-976"><span class="linenos"> 976</span></a>
</span><span id="AnalyzerAgentUnified-977"><a href="#AnalyzerAgentUnified-977"><span class="linenos"> 977</span></a><span class="sd">        :param client: Client utilisé pour interagir avec l&#39;API Gemini.</span>
</span><span id="AnalyzerAgentUnified-978"><a href="#AnalyzerAgentUnified-978"><span class="linenos"> 978</span></a><span class="sd">        :type client: object</span>
</span><span id="AnalyzerAgentUnified-979"><a href="#AnalyzerAgentUnified-979"><span class="linenos"> 979</span></a><span class="sd">        :param content: Contenu à envoyer dans la requête pour la génération.</span>
</span><span id="AnalyzerAgentUnified-980"><a href="#AnalyzerAgentUnified-980"><span class="linenos"> 980</span></a><span class="sd">        :type content: list ou str</span>
</span><span id="AnalyzerAgentUnified-981"><a href="#AnalyzerAgentUnified-981"><span class="linenos"> 981</span></a><span class="sd">        :param state: État ou contexte associé à la génération.</span>
</span><span id="AnalyzerAgentUnified-982"><a href="#AnalyzerAgentUnified-982"><span class="linenos"> 982</span></a><span class="sd">        :type state: dict</span>
</span><span id="AnalyzerAgentUnified-983"><a href="#AnalyzerAgentUnified-983"><span class="linenos"> 983</span></a><span class="sd">        :param max_retries: Nombre maximum de tentatives autorisées en cas d&#39;échec.</span>
</span><span id="AnalyzerAgentUnified-984"><a href="#AnalyzerAgentUnified-984"><span class="linenos"> 984</span></a><span class="sd">        Valeur par défaut : 3.</span>
</span><span id="AnalyzerAgentUnified-985"><a href="#AnalyzerAgentUnified-985"><span class="linenos"> 985</span></a><span class="sd">        :type max_retries: int</span>
</span><span id="AnalyzerAgentUnified-986"><a href="#AnalyzerAgentUnified-986"><span class="linenos"> 986</span></a>
</span><span id="AnalyzerAgentUnified-987"><a href="#AnalyzerAgentUnified-987"><span class="linenos"> 987</span></a><span class="sd">        :return: La réponse générée par l&#39;API Gemini si réussie.</span>
</span><span id="AnalyzerAgentUnified-988"><a href="#AnalyzerAgentUnified-988"><span class="linenos"> 988</span></a><span class="sd">        :rtype: object</span>
</span><span id="AnalyzerAgentUnified-989"><a href="#AnalyzerAgentUnified-989"><span class="linenos"> 989</span></a>
</span><span id="AnalyzerAgentUnified-990"><a href="#AnalyzerAgentUnified-990"><span class="linenos"> 990</span></a><span class="sd">        :raises Exception: Si tous les essais échouent ou si la réponse est invalide.</span>
</span><span id="AnalyzerAgentUnified-991"><a href="#AnalyzerAgentUnified-991"><span class="linenos"> 991</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified-992"><a href="#AnalyzerAgentUnified-992"><span class="linenos"> 992</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="AnalyzerAgentUnified-993"><a href="#AnalyzerAgentUnified-993"><span class="linenos"> 993</span></a>        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified-994"><a href="#AnalyzerAgentUnified-994"><span class="linenos"> 994</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-995"><a href="#AnalyzerAgentUnified-995"><span class="linenos"> 995</span></a>
</span><span id="AnalyzerAgentUnified-996"><a href="#AnalyzerAgentUnified-996"><span class="linenos"> 996</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
</span><span id="AnalyzerAgentUnified-997"><a href="#AnalyzerAgentUnified-997"><span class="linenos"> 997</span></a>                    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemini-2.5-pro&quot;</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-998"><a href="#AnalyzerAgentUnified-998"><span class="linenos"> 998</span></a>                    <span class="n">contents</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-999"><a href="#AnalyzerAgentUnified-999"><span class="linenos"> 999</span></a>                    <span class="n">config</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">GenerateContentConfig</span><span class="p">(</span>
</span><span id="AnalyzerAgentUnified-1000"><a href="#AnalyzerAgentUnified-1000"><span class="linenos">1000</span></a>                        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-1001"><a href="#AnalyzerAgentUnified-1001"><span class="linenos">1001</span></a>                        <span class="n">candidate_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-1002"><a href="#AnalyzerAgentUnified-1002"><span class="linenos">1002</span></a>                        <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="AnalyzerAgentUnified-1003"><a href="#AnalyzerAgentUnified-1003"><span class="linenos">1003</span></a>                        <span class="n">thinking_config</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">ThinkingConfig</span><span class="p">(</span><span class="n">include_thoughts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-1004"><a href="#AnalyzerAgentUnified-1004"><span class="linenos">1004</span></a>                    <span class="p">)</span>
</span><span id="AnalyzerAgentUnified-1005"><a href="#AnalyzerAgentUnified-1005"><span class="linenos">1005</span></a>                <span class="p">)</span>
</span><span id="AnalyzerAgentUnified-1006"><a href="#AnalyzerAgentUnified-1006"><span class="linenos">1006</span></a>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">candidates</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-1007"><a href="#AnalyzerAgentUnified-1007"><span class="linenos">1007</span></a>                    <span class="k">return</span> <span class="n">response</span>
</span><span id="AnalyzerAgentUnified-1008"><a href="#AnalyzerAgentUnified-1008"><span class="linenos">1008</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-1009"><a href="#AnalyzerAgentUnified-1009"><span class="linenos">1009</span></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Réponse Gemini invalide&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-1010"><a href="#AnalyzerAgentUnified-1010"><span class="linenos">1010</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-1011"><a href="#AnalyzerAgentUnified-1011"><span class="linenos">1011</span></a>                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-1012"><a href="#AnalyzerAgentUnified-1012"><span class="linenos">1012</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified-1013"><a href="#AnalyzerAgentUnified-1013"><span class="linenos">1013</span></a>                    <span class="k">continue</span>
</span><span id="AnalyzerAgentUnified-1014"><a href="#AnalyzerAgentUnified-1014"><span class="linenos">1014</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified-1015"><a href="#AnalyzerAgentUnified-1015"><span class="linenos">1015</span></a>                    <span class="k">raise</span> <span class="n">e</span>
</span></pre></div>


            <div class="docstring"><p>La classe AnalyzerAgentUnified est responsable d'exécuter des tâches d'analyse complexes sur des données Excel
et PDF en utilisant des modèles d'IA et des outils d'automatisation. Elle gère également la communication avec
un chatbot et garantit une analyse robuste avec des étapes définies de traitement des données.</p>

<p>:ivar gemini_model: Référence au modèle Gemini utilisé pour les opérations d'analyse.
:ivar chatbot: Instance de chatbot utilisée pour la journalisation et les interactions avec l'utilisateur.</p>
</div>


                            <div id="AnalyzerAgentUnified.__init__" class="classattr">
                                        <input id="AnalyzerAgentUnified.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AnalyzerAgentUnified</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">gemini_model</span>, </span><span class="param"><span class="n">chatbot_instance</span></span>)</span>

                <label class="view-source-button" for="AnalyzerAgentUnified.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AnalyzerAgentUnified.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AnalyzerAgentUnified.__init__-26"><a href="#AnalyzerAgentUnified.__init__-26"><span class="linenos">26</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gemini_model</span><span class="p">,</span> <span class="n">chatbot_instance</span><span class="p">):</span>
</span><span id="AnalyzerAgentUnified.__init__-27"><a href="#AnalyzerAgentUnified.__init__-27"><span class="linenos">27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gemini_model</span> <span class="o">=</span> <span class="n">gemini_model</span>
</span><span id="AnalyzerAgentUnified.__init__-28"><a href="#AnalyzerAgentUnified.__init__-28"><span class="linenos">28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span> <span class="o">=</span> <span class="n">chatbot_instance</span>
</span></pre></div>


    

                            </div>
                            <div id="AnalyzerAgentUnified.gemini_model" class="classattr">
                                <div class="attr variable">
            <span class="name">gemini_model</span>

        
    </div>
    <a class="headerlink" href="#AnalyzerAgentUnified.gemini_model"></a>
    
    

                            </div>
                            <div id="AnalyzerAgentUnified.chatbot" class="classattr">
                                <div class="attr variable">
            <span class="name">chatbot</span>

        
    </div>
    <a class="headerlink" href="#AnalyzerAgentUnified.chatbot"></a>
    
    

                            </div>
                            <div id="AnalyzerAgentUnified.execute" class="classattr">
                                        <input id="AnalyzerAgentUnified.execute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">execute</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="n"><a href="../core/state.html#ChatbotState">Chatbot_AMDIE.chatbot_maroc.backend_python.src.core.state.ChatbotState</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../core/state.html#ChatbotState">Chatbot_AMDIE.chatbot_maroc.backend_python.src.core.state.ChatbotState</a></span>:</span></span>

                <label class="view-source-button" for="AnalyzerAgentUnified.execute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AnalyzerAgentUnified.execute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AnalyzerAgentUnified.execute-30"><a href="#AnalyzerAgentUnified.execute-30"><span class="linenos">30</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified.execute-31"><a href="#AnalyzerAgentUnified.execute-31"><span class="linenos">31</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified.execute-32"><a href="#AnalyzerAgentUnified.execute-32"><span class="linenos">32</span></a><span class="sd">        Exécute une analyse sur l&#39;état actuel du chatbot et retourne un nouvel état</span>
</span><span id="AnalyzerAgentUnified.execute-33"><a href="#AnalyzerAgentUnified.execute-33"><span class="linenos">33</span></a><span class="sd">        après traitement par l&#39;agent analyseur unifié.</span>
</span><span id="AnalyzerAgentUnified.execute-34"><a href="#AnalyzerAgentUnified.execute-34"><span class="linenos">34</span></a>
</span><span id="AnalyzerAgentUnified.execute-35"><a href="#AnalyzerAgentUnified.execute-35"><span class="linenos">35</span></a><span class="sd">        Le comportement de cette méthode dépend de la logique d&#39;analyse définie</span>
</span><span id="AnalyzerAgentUnified.execute-36"><a href="#AnalyzerAgentUnified.execute-36"><span class="linenos">36</span></a><span class="sd">        par l&#39;agent analyseur unifié. Elle prend en entrée l&#39;état actuel du chatbot et</span>
</span><span id="AnalyzerAgentUnified.execute-37"><a href="#AnalyzerAgentUnified.execute-37"><span class="linenos">37</span></a><span class="sd">        le traite pour retourner un état mis à jour.</span>
</span><span id="AnalyzerAgentUnified.execute-38"><a href="#AnalyzerAgentUnified.execute-38"><span class="linenos">38</span></a>
</span><span id="AnalyzerAgentUnified.execute-39"><a href="#AnalyzerAgentUnified.execute-39"><span class="linenos">39</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot à traiter.</span>
</span><span id="AnalyzerAgentUnified.execute-40"><a href="#AnalyzerAgentUnified.execute-40"><span class="linenos">40</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified.execute-41"><a href="#AnalyzerAgentUnified.execute-41"><span class="linenos">41</span></a><span class="sd">        :return: Le nouvel état du chatbot après traitement par l&#39;agent analyseur unifié.</span>
</span><span id="AnalyzerAgentUnified.execute-42"><a href="#AnalyzerAgentUnified.execute-42"><span class="linenos">42</span></a><span class="sd">        :rtype: ChatbotState</span>
</span><span id="AnalyzerAgentUnified.execute-43"><a href="#AnalyzerAgentUnified.execute-43"><span class="linenos">43</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified.execute-44"><a href="#AnalyzerAgentUnified.execute-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_analyseur_unifie</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Exécute une analyse sur l'état actuel du chatbot et retourne un nouvel état
après traitement par l'agent analyseur unifié.</p>

<p>Le comportement de cette méthode dépend de la logique d'analyse définie
par l'agent analyseur unifié. Elle prend en entrée l'état actuel du chatbot et
le traite pour retourner un état mis à jour.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>state</strong>:  L'état actuel du chatbot à traiter.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Le nouvel état du chatbot après traitement par l'agent analyseur unifié.</p>
</blockquote>
</div>


                            </div>
                            <div id="AnalyzerAgentUnified.agent_analyseur_unifie" class="classattr">
                                        <input id="AnalyzerAgentUnified.agent_analyseur_unifie-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">agent_analyseur_unifie</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="n"><a href="../core/state.html#ChatbotState">Chatbot_AMDIE.chatbot_maroc.backend_python.src.core.state.ChatbotState</a></span></span><span class="return-annotation">) -> <span class="n"><a href="../core/state.html#ChatbotState">Chatbot_AMDIE.chatbot_maroc.backend_python.src.core.state.ChatbotState</a></span>:</span></span>

                <label class="view-source-button" for="AnalyzerAgentUnified.agent_analyseur_unifie-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AnalyzerAgentUnified.agent_analyseur_unifie"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-46"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-46"><span class="linenos">46</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">agent_analyseur_unifie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-47"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-47"><span class="linenos">47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-48"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-48"><span class="linenos">48</span></a><span class="sd">        Analyse et traitement unifiés des documents Excel et PDF basés sur l&#39;état actuel</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-49"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-49"><span class="linenos">49</span></a><span class="sd">        du chatbot. Ce processus intègre l&#39;historique de l&#39;utilisateur et finalise l&#39;état</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-50"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-50"><span class="linenos">50</span></a><span class="sd">        après traitement des documents.</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-51"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-51"><span class="linenos">51</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-52"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-52"><span class="linenos">52</span></a><span class="sd">        :param state: L&#39;état actuel du chatbot, encapsulant les données nécessaires au</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-53"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-53"><span class="linenos">53</span></a><span class="sd">            traitement et à l&#39;analyse des documents.</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-54"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-54"><span class="linenos">54</span></a><span class="sd">        :type state: ChatbotState</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-55"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-55"><span class="linenos">55</span></a><span class="sd">        :return: L&#39;état mis à jour du chatbot après l&#39;exécution complète des analyses</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-56"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-56"><span class="linenos">56</span></a><span class="sd">            Excel et PDF.</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-57"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-57"><span class="linenos">57</span></a><span class="sd">        :rtype: ChatbotState</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-58"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-58"><span class="linenos">58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-59"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-59"><span class="linenos">59</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-60"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Agent Analyseur Unifié: Début de l&#39;analyse Excel + PDF&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-61"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-61"><span class="linenos">61</span></a>        <span class="n">session_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-62"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-62"><span class="linenos">62</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-63"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-63"><span class="linenos">63</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-64"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-64"><span class="linenos">64</span></a>            <span class="n">_send_to_frontend</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;Agent Analyseur Unifié: Traitement Excel + PDF...&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-65"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-65"><span class="linenos">65</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-66"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-66"><span class="linenos">66</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Envoi frontend échoué: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-67"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-67"><span class="linenos">67</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-68"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-68"><span class="linenos">68</span></a>        <span class="c1"># Récupérer les informations utilisateur</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-69"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-69"><span class="linenos">69</span></a>        <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_user_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-70"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-70"><span class="linenos">70</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-71"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-71"><span class="linenos">71</span></a>        <span class="c1"># Récupérer l&#39;historique utilisateur</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-72"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-72"><span class="linenos">72</span></a>        <span class="n">historique_contexte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_context</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-73"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-73"><span class="linenos">73</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-74"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-74"><span class="linenos">74</span></a>        <span class="c1"># ========== PARTIE 1: ANALYSE EXCEL ==========</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-75"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-75"><span class="linenos">75</span></a>        <span class="n">excel_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_excel_documents</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-76"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-76"><span class="linenos">76</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-77"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-77"><span class="linenos">77</span></a>        <span class="c1"># ========== PARTIE 2: ANALYSE PDF  ==========</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-78"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-78"><span class="linenos">78</span></a>        <span class="n">pdf_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_pdf_documents</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">historique_contexte</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-79"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-79"><span class="linenos">79</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-80"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-80"><span class="linenos">80</span></a>        <span class="c1"># ========== PARTIE 3: ÉTAT FINAL ==========</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-81"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_analysis_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">excel_processed</span><span class="p">,</span> <span class="n">pdf_processed</span><span class="p">)</span>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-82"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-82"><span class="linenos">82</span></a>
</span><span id="AnalyzerAgentUnified.agent_analyseur_unifie-83"><a href="#AnalyzerAgentUnified.agent_analyseur_unifie-83"><span class="linenos">83</span></a>        <span class="k">return</span> <span class="n">state</span>
</span></pre></div>


            <div class="docstring"><p>Analyse et traitement unifiés des documents Excel et PDF basés sur l'état actuel
du chatbot. Ce processus intègre l'historique de l'utilisateur et finalise l'état
après traitement des documents.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>state</strong>:  L'état actuel du chatbot, encapsulant les données nécessaires au
traitement et à l'analyse des documents.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>L'état mis à jour du chatbot après l'exécution complète des analyses
      Excel et PDF.</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>